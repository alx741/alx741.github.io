<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Silly Bytes</title>
    <link href="http://www.sillybytes.net/atom.xml" rel="self" />
    <link href="http://www.sillybytes.net" />
    <id>http://www.sillybytes.net/atom.xml</id>
    <author>
        <name>Daniel Campoverde [alx741]</name>
        <email>alx@sillybytes.net</email>
    </author>
    <updated>2017-05-04T00:00:00Z</updated>
    <entry>
    <title>Deploying Yesod applications with Keter</title>
    <link href="http://www.sillybytes.net/posts/keter_tutorial.html" />
    <id>http://www.sillybytes.net/posts/keter_tutorial.html</id>
    <published>2017-05-04T00:00:00Z</published>
    <updated>2017-05-04T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/keter/thumbnail.png" id="thumbnail" /><br />
</p>
<p><a href="https://github.com/snoyberg/keter">Keter</a> is the <a href="http://www.yesodweb.com/">Yesod</a>’s deployment system, fully featured and a joy to use, but there are some pitfalls that the documentation doesn’t cover, and that the user has to find out for her self; So I’ll try to give them away here together with a walk-through tutorial.</p>
<p>Although Keter is flexible and general enough to be used with various kind of applications and web frameworks, here I’m going to assume you’re using it to deploy Yesod applications. Moreover, I’ll assume you’re using Yesod’s scaffolding, as it is the preferred way to write production ready applications.</p>
<!--more-->
<p>I’m also taking for granted that you’ve already installed on your server system whatever DBMS that your Yesod app needs, and have also created the app’s databases.</p>
<h1 id="installing-keter-on-the-server">Installing Keter on the server</h1>
<h2 id="keter-binary">Keter binary</h2>
<p>It is always advisable to compile on the development machine rather than the production server, to avoid utilising its resources for building (specially considering that GHC can make use of a fair amount of them). So, assuming the architectures match, you can just install <code>keter</code> on you local machine:</p>
<pre><code>$ stack install keter</code></pre>
<p>And then put the binary on the server (<em>example.com</em>):</p>
<pre><code>$ scp ~/.local/bin/keter root@example.com:/root/</code></pre>
<h2 id="keter-user">Keter user</h2>
<p>It’s a good practice to have a dedicated <em>keter</em> user, so you don’t have to deploy as root each time:</p>
<pre><code># useradd keter
# passwd keter</code></pre>
<h2 id="directory-tree">Directory tree</h2>
<p>The directory tree needed on the server is as follows:</p>
<pre><code>keter
├── bin
│   └── keter
├── etc
│   └── keter-config.yaml
├── incoming
    └── app.keter</code></pre>
<p>So create it, copy the binary to <code>/opt/keter/bin</code>, and make sure <code>/opt/keter/incoming</code> it’s owned by the <em>keter</em> user (we’ll take care of the <code>keter-config.yaml</code> configuration later):</p>
<pre><code># mkdir -p /opt/keter /opt/keter/bin /opt/keter/etc /opt/keter/incoming
# cp /root/keter /opt/keter/bin
# touch /opt/keter/keter-config.yaml
# chown -R keter:keter /opt/keter/icoming</code></pre>
<h2 id="init-system">Init System</h2>
<p>While you could just execute <code>/opt/keter/bin/keter</code> directly, it’s better to register it as a job in your Init System.</p>
<h4 id="sysmted-redhat-fedora-centos-arch-opensuse-etc">Sysmted (RedHat, Fedora, CentOS, Arch, openSUSE, etc)</h4>
<p>Create a file <code>/etc/systemd/system/keter.service</code>, with the contents:</p>
<pre><code>[Unit]
Description=Keter
After=network.service

[Service]
Type=simple
ExecStart=/opt/keter/bin/keter /opt/keter/etc/keter-config.yaml

[Install]
WantedBy=multi-user.target</code></pre>
<p>Enable the service:</p>
<pre><code>$ sudo systemctl enable keter</code></pre>
<p>Now you can start <em>keter</em> with (don’t do it just yet, as we still need to write the <em>keter</em> configuration file):</p>
<pre><code>$ sudo systemctl start keter</code></pre>
<h4 id="upstart-debian-ubuntu-etc">Upstart (Debian, Ubuntu, etc)</h4>
<p>Create a file <code>/etc/init/keter.con</code>, with the contents:</p>
<pre><code>start on (net-device-up and local-filesystems and runlevel [2345])
stop on runlevel [016]
respawn
console output
exec /opt/keter/bin/keter /opt/keter/etc/keter-config.yaml</code></pre>
<p>Now you can start <em>keter</em> with (don’t do it just yet, as we still need to write the <em>keter</em> configuration file):</p>
<pre><code>$ sudo start keter</code></pre>
<h1 id="configuration">Configuration</h1>
<h2 id="server-side">Server Side</h2>
<p>The <em>Keter</em> configuration at <code>/opt/keter/etc/keter-config.yaml</code> is pretty straight forward:</p>
<pre><code>root: ..

listeners:
    # HTTP
    - host: &quot;*4&quot; # Listen on all IPv4 hosts
      port: 80
    # HTTPS
    #- host: &quot;*4&quot;
      #port: 443
      #key: key.pem
      #certificate: certificate.pem

# env:
#    key: value</code></pre>
<p>The <code>root</code> option points, as expected, to <code>/opt/keter</code>.</p>
<p>Make sure to change the <code>port</code> option if you’re reverse forwarding from a fronted server like <em>Nginx</em> or <em>Apache</em> (more on this later).</p>
<p>If you’re serving your application over SSL (and you should), uncomment the <em>HTTPS</em> section, then point the <code>key</code> option to your <code>privkey.pem</code> file, and the <code>certificate</code> option to your <code>fullchain.pem</code> file.</p>
<p>The <code>env</code> option, keeps pairs of <em>keys</em> and <em>values</em>. The main set of values you’ll need here are your Database credentials. You’ve probably already configured database credentials in the <code>database</code> section in the <code>config/settings.yaml</code> file, so you’ll notice you need some environment variables like <code>MYSQL_USER</code>, <code>MYSQL_PASSWORD</code>, etc. If you’re using MySQL/MariaDB; Or <code>PGUSER</code>, <code>PGPASS</code>, etc. If you’re using PostgreSQL. You get the idea.</p>
<p>This is how it will look like for a PostgreSQL Database where only the user and password are different between the development and production servers (be sure to keep the quotes!).</p>
<pre><code>env:
    PGUSER: &quot;user&quot;
    PGPASS: &quot;password&quot;</code></pre>
<h2 id="yesod-application-side">Yesod application side</h2>
<p>The Keter configuration file for your Yesod application lives in <code>config/keter.yml</code>. Set <code>user-edited</code> to <code>true</code>, so you’re able to execute <code>yesod keter</code> later on.</p>
<p>Locate the <code>copy-to</code> option and configure it to use the <code>keter</code> user and your server domain (or IP address):</p>
<pre><code>copy-to: keter@example.com:/opt/keter/incoming/</code></pre>
<p>This will allow you to deploy your application with:</p>
<pre><code>$ stack -- exec yesod keter</code></pre>
<h4 id="hosts-configuration">Hosts Configuration</h4>
<p>The most important part of the Keter configuration is perhaps the <code>hosts</code> option of the <code>webapp</code> stanza, the hosts you declare here are the ones that your application is going to respond to. Unless you’re using a separate domain for serving static files, be sure to keep the <code>hosts</code> option of the <code>static-files</code> stanza in sync with the <code>webapp</code> one.</p>
<p>This one here is a pretty common error message when trying to deploy a Yesod application (and failing miserably):</p>
<p><img src="/img/keter/shot1.png" class="img-responsive" /></p>
<p>There is more than one reason for this, but the main one is that the domain name or IP address doesn’t exactly match one of the hosts provided in the <code>hosts</code> option.</p>
<p>If you’re serving only one application and using <em>Keter</em> as the main server listening on port <code>80</code>, then having your domain name in <code>hosts</code> will pretty much suffice, BUT most of the time, even if your serving only one application, you’re probably using a frontend server like <em>Nginx</em> or <em>Apache</em>, in which case you have to consider the port the reverse proxy is pointing to.</p>
<p>Take for instance this <em>Nginx</em> reverse proxy configuration for an app that lives on <code>blog.example.com</code></p>
<pre><code>server {
    listen 80;
    server_name blog.example.com;
    location / {
            proxy_pass http://127.0.0.1:4321;
    }</code></pre>
<p>With a <em>Keter</em> configuration that has:</p>
<pre><code>listeners:
    - host: &quot;*4&quot; # Listen on all IPv4 hosts
      port: 4321</code></pre>
<p>Then you have a problem. If you try to connect to <code>http://blog.example.com</code> you’ll get the aforementioned error message, telling you that “127.0.0.1:4321, is not recognized”. It makes sense if you think about it, <em>Nginx</em> will redirect the connection to <code>127.0.0.1:4321</code> so <em>Keter</em> can handle it, but there is no application that responds to <code>127.0.0.1:4321</code>, and notice the port number here, as it is significant for <em>Keter</em> when trying to find a corresponding application!</p>
<p>To fix this, we must allow our application to respond to <code>127.0.0.1:4321</code> as well:</p>
<pre><code>hosts:
    - blog.example.com
    - blog.example.com:4321
    - 127.0.0.1:4321</code></pre>
<p>Restart <em>Ngnix</em> and <em>Keter</em> on the server to allow the configuration to take effect and redeploy the application:</p>
<pre><code>$ stack -- exec yesod keter</code></pre>
<h4 id="redirections">Redirections</h4>
<p>If you’re going to use the <code>redirect</code> stanza to automatically redirect any connection to, lets say <code>example.com</code> to <code>wwww.example.com</code>:</p>
<pre><code>- type: redirect
  hosts:
      - example.com
  actions:
      - host: www.example.com</code></pre>
<p>Then be completely sure to have <code>www.example.com</code> in the <code>hosts</code> option of the <code>webapp</code> stanza as well, failing to do this will take you to the same error message.</p>
<h1 id="other-sources-of-error">Other sources of error</h1>
<h2 id="welcome-to-keter">“Welcome to Keter”</h2>
<p>If you’re still reaching this error:</p>
<p><img src="/img/keter/shot1.png" class="img-responsive" /></p>
<p>Unfortunately, the same error message appears if an application that responds to that host is actually found, but is failing to start.</p>
<p>Check the <code>/opt/keter/log/app-yourapp/current.log</code> log file, chances are you have changes in your persistent models that can’t be reflected in your database without user intervention, so be sure to manually fix them the same way you have to do in your development database.</p>
<h2 id="changes-in-new-deployed-version-not-taking-effect">Changes in new deployed version not taking effect</h2>
<p>It is pretty common to forget changes in persistent models that need manual user intervention after deploying, similarly to the error above, this will prevent the app to start. If you currently have a version of your app working, <em>Keter</em> will use it instead of the new one if it fails to start, so if the latest deployed changes seem to not be taking effect, this can also be the source of the problem.</p>]]></summary>
</entry>
<entry>
    <title>What's wrong with Java?</title>
    <link href="http://www.sillybytes.net/posts/whats_wrong_with_java.html" />
    <id>http://www.sillybytes.net/posts/whats_wrong_with_java.html</id>
    <published>2017-04-14T00:00:00Z</published>
    <updated>2017-04-14T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/javawrong/thumbnail.png" id="thumbnail" /><br />
</p>
<p>I’ve spitted out quite a bit of rant about Java before in <a href="http://www.sillybytes.net/2016/03/why-do-i-hate-java.html">this post</a>, in which I basically list the annoyances that the ecosystem around Java imposes and how those problems are pretty much a big intersection with the problems of IDEs.</p>
<p>Here I’d like to talk about the problems of Java as a language. Although there are a few problems with Java, I can live with them if I have no other option but to write Java code; My <em>hate</em> to Java doesn’t really arise from Java being a bad <em>language</em> but rather from its <a href="http://www.sillybytes.net/2016/03/why-do-i-hate-java.html">surroundings</a>.</p>
<!--more-->
<h1 id="pointers-pointers-everywhere">Pointers, Pointers everywhere</h1>
<p>Java claims to be a <em>pointers free language</em>. Pointers, although elegant and very powerful, are a low level construct that should not be present in a higher level language, that’s for sure. Most of the time I want to be as far away as possible from pointers when programming unless I really need them, in which case I will just write in <em>C</em>.</p>
<p>The problem is Java does have pointers; Moreover, it manages to keep most of the inconveniences of having pointers while giving almost none of the benefits of not having them. If you’re not giving me the power of pointers, at least be kind enough to remove the problems they arise!</p>
<h2 id="everything-is-a-reference-everything-is-a-pointer">Everything is a reference, everything is a pointer</h2>
<p>Java loves to call pointers as “references”, which is only a way to pretend that there are no pointers.</p>
<p>Java makes pretty much everything a pointer, thus the heavy usage of the <code>new</code> keyword. Making everything a pointer gives <em>JVM</em> the ability to manage memory with the Garbage Collector of course, but the consequences of this are not as shallow and beneficial as you’d like to think.</p>
<p>Having no means to manipulate an object other than via <em>references</em> weakens data locality (a problem that other high level languages actually does manage to solve), and thus cache misses become bread and butter for a Java programmer which, most likely, isn’t aware of it or don’t even know what I’m talking about or how is it important. Which takes us to the problems of Java as a first programming language, but we’ll talk about that latter.</p>
<h2 id="nullpointerexception">NullPointerException</h2>
<p>The book <em>Elegant Objects</em> by Yegor Bugayenko says:</p>
<blockquote>
<p>In a nutshell, you’re making a big mistake if you use NULL anywhere in your code. Anywhere – I mean it.</p>
</blockquote>
<p>And I completely agree with that. The problem is having to take into account the possibility of <em>NULL</em> in a high level language that supposedly doesn’t have pointers.</p>
<p>In <em>C</em> or <em>C++,</em> when you dereference a <em>NULL</em> pointer, you get a <em>Segmentation Fault</em> and your program crashes. In Java, when you try to use a <em>NULL</em> reference you get a <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/NullPointerException.html">NullPointerException</a> and your program crashes as well. So what gives?</p>
<p>You may say that the sources of these crashes are different, the <em>Segmentation Fault</em> comes from the OS trying to stop you from crashing the entire system, while the <em>NullPointerException</em> comes from the JVM that… Well, has nothing left to do but crash… I don’t see how is that any better.</p>
<p><em>NullPointerException</em>s are terribly common in Java, and you have to hunt them down just as any null pointer dereference bug. And if you’re thinking the actual benefit of this is having the <em>GC</em> taking care of the memory instead of having to remember to manually free memory, then you’re wrong, there are ways to statically take care of that, without having the <em>GC</em> behemoth eating your CPU time, but I’ll get to that in a moment.</p>
<p>By the way, Tony Hoare himself calls <em>NULL</em> the <a href="https://en.wikipedia.org/wiki/Nullable_type#Compared_with_null_pointers">“Billion-Dollar mistake”</a>.</p>
<h2 id="useless-pointers">Useless pointers</h2>
<p>So java is cluttered with pointers, useless pointers. In <em>C/C++</em> pointers are one of the most powerful constructs, they allow you to get closer to the machine and control its actions with scalpel precision; In Java you get your programs to crash due to <em>NULL</em> pointers while getting nothing on exchange.</p>
<p>But pointers in Java percolates in even more creative ways, take for instance the Equality comparison problem: When you perform equality comparison <code>==</code> what you’re actually comparing is <em>pointers equality</em>, not <em>values equality</em> for which you need a special method <code>equal()</code>, this is a low level language trait as its best, not to mention terribly counterintuitive.</p>
<h1 id="the-bad-the-worst-and-the-ugly">The bad, the worst and the ugly</h1>
<p>Java has a lot of additional traits that make it not only a low level language in disguise, but also a bad language in general.</p>
<p><img src="/img/javawrong/good_bad_ugly.jpg" class="img-responsive" /></p>
<h2 id="portability">Portability</h2>
<p>People usually get confused by the “Java is portable” thing. When we say that “Java is portable” what we actually mean is that Java <em>Bytecode</em> can be ported.</p>
<p>Lower level languages as <em>C</em> or <em>C++</em> are portable too, the difference is that these need to be recompiled for the target system. You don’t believe me? Take a look at <a href="https://www.gimp.org/">Gimp</a>, <a href="https://gcc.gnu.org/">GCC</a> and <a href="https://inkscape.org/en/">Inkscape</a>, just to mention a few.</p>
<p>When you distribute <em>C/C++</em> software for multiple platforms you distribute the binaries compiled for each platform, while with Java you just distribute one <em>Bytecode</em> executable for every platform, sure, it is a benefit, but no where near enough to make up for the inconvenience of having to write Java.</p>
<h2 id="awful-verbosity">Awful Verbosity</h2>
<p>Most of the Java ugly verbosity is attributed to its static, strong typing discipline that forces you to annotate the types of everything, everywhere. But this is not the type discipline fault.</p>
<p>In Java, you declare, for instance, a vector of integers:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="bu">Vector</span>&lt;<span class="bu">Integer</span>&gt; vector = <span class="kw">new</span> <span class="bu">Vector</span>&lt;<span class="bu">Integer</span>&gt;();</a></code></pre></div>
<p>Or a vector of vectors of integers (a Matrix of integers):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="bu">Vector</span>&lt;<span class="bu">Vector</span>&lt;<span class="bu">Integer</span>&gt;&gt; vector = <span class="kw">new</span> <span class="bu">Vector</span>&lt;<span class="bu">Vector</span>&lt;<span class="bu">Integer</span>&gt;&gt;();</a></code></pre></div>
<p>Java’s way of dealing with this to some extent, is the <em>diamond</em> operator <code>&lt;&gt;</code>, so instead we could write:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="bu">Vector</span>&lt;<span class="bu">Vector</span>&lt;<span class="bu">Integer</span>&gt;&gt; vector = <span class="kw">new</span> <span class="bu">Vector</span>&lt;&gt;();</a></code></pre></div>
<p>But that’s pretty much as far as it gets. <em>C++11</em> on the other hand has the <code>auto</code> keyword to let the compiler do what compilers are good at: mechanical, repetitive, deterministic tasks; Type inference is one of those tasks.</p>
<p>Every time, everywhere a time annotation is needed, you provide one only if it’s absolutely needed to avoid ambiguity, otherwise, just use <code>auto</code> and let the compiler do it for you.</p>
<h2 id="resources-un-safety">Resources un-safety</h2>
<p>One of the main Java selling points is <em>Memory Safety</em>, you see, in <em>C</em> you have to free your memory with <code>free()</code> in the right place, at the right time after every memory allocation with <code>malloc()</code> and friends. If you forget to free your memory you’ll have memory leaks, if you free it twice, or if you free it at the wrong time you’ll have a segmentation fault.</p>
<p>Java on the other hand leverages the Garbage Collector to do it for you, the problem is, this works for memory only!</p>
<p>Whenever you initialize a socket, or a database connection, or open a file, you still need to <em>close</em> it at the right time; So you still can and will have resources leakage.</p>
<p><img src="/img/javawrong/leak.jpg" class="img-responsive" /></p>
<p><em>C++</em> solves all of those problems beautifully by using <a href="http://en.cppreference.com/w/cpp/language/raii">Resource Acquisition Is Initialization</a> or RAII for short. And by the way, if you hit the same kind of problems you face in <em>C</em> with <code>malloc()</code> and <code>free()</code> but with <em>C++</em>’s <code>new</code> and <code>delete</code>, then you’re doing it wrong.</p>
<p>By using <em>C++</em>’s RAII mechanisms you’ll never have to remember to free memory, close files, sockets, database connections or anything else. Java is supposed to be a higher level language than <em>C++</em> isn’t it?</p>
<h2 id="exceptions-driven-programming">Exceptions Driven Programming</h2>
<p><em>C++</em> and a lot of other imperative and OOP languages suffer form the <em>Exceptions</em> problems as well, but Java manages to screw it up even further.</p>
<p>The heavy use of exceptions forces the programmer to write tons of</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">try</span> {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    ...</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">catch</span>(someExcetption e) {</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    ...</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">catch</span>(someOtherExcetption e) {</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    ...</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="kw">catch</span>(yetAnotherExcetption e) {</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">    ...</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">}</a></code></pre></div>
<p>The usual alternative is just:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">try</span> {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">    ...</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="kw">catch</span>(Excetption e) {</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;An exception has occurred, sorry ¯\_(ツ)_/¯&quot;</span>);</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">}</a></code></pre></div>
<p>The result of this is that the code that matters, the actual logic we’re trying to encode in the program gets deeply buried in there, making it hard to read, hard to understand, hard to maintain, hard to modify and awfully ugly. Although most languages suffer from a variant of this issue, some other languages handle it gracefully by encoding the possibility of failure in the type system.</p>
<p>Most programming languages break equational reasoning, but that’s pretty much normal; Exceptions go further by even breaking the imperative sequentiality (<em>cough</em> GOTO <em>cough</em>).</p>
<h1 id="everything-is-an-object">Everything is an object</h1>
<p>As I have already said in my <a href="http://www.sillybytes.net/2016/03/why-do-i-hate-java.html">previous post</a>, No, not everything is a object. OOP has a lot of problems on its own, and it deserves its own post. Here I’m talking about the way Java forces OOP.</p>
<p>Most OOP languages have this paradigm as a <em>feature</em>, but still allow for free functions, free data and so on. The problem with Java being strictly OOP is that it forces objects even when they don’t fit, even when they adversely affect compostability, modularity or readability.</p>
<blockquote>
<p>The problem with object-oriented languages is they’ve got all this implicit environment that they carry around with them. You wanted a banana but what you got was a gorilla holding the banana and the entire jungle. – Joe Armstrong</p>
</blockquote>
<p>In most languages you can perform <em>actions</em>, but in Java, having objects as the only mean of abstraction, you must have <em>“actioners”</em> to perform any <em>actions</em>, and you must force them into existent to do anything. OOP is usually bad in general, although useful in certain contexts; Java makes it soul up from everything that is wrong with OOP.</p>
<p>Those and more are the common pains of Javaland, that Steve Yegge describes wonderfully in <a href="http://steve-yegge.blogspot.com/2006/03/execution-in-kingdom-of-nouns.html">Execution in the Kingdom of Nouns</a>.</p>
<h1 id="performance">Performance</h1>
<p>Java is both fast and slow, depending on what language you compare it with. When you compare it with higher level languages, Java is reasonably faster, but when you compare it with C or C++, Java is miserably slow and heavy on resources.</p>
<p>Taking into account that Java is more of a low level language rather than a high level one as we have seen, it should be compared to is closes cousins C and C++, in which case you inevitably conclude it’s just slow, very slow.</p>
<h1 id="java-sits-in-a-dead-spot">Java sits in a dead spot</h1>
<p>As we’ve seen, Java is mostly a low level programming language that doesn’t really provides the benefits of one, while at the same time it pretends to be a high level language and fails miserably.</p>
<p>This leads to the current situation:</p>
<pre><code>| C | C++ | Rust | Java | Ruby | Python | PHP | Perl | Earlang | OCaml | Haskell

|--- Low Level --| ???  |---                  High Level                    ---|</code></pre>
<h2 id="java-is-a-bad-low-level-language">Java is a bad low level language</h2>
<p>From the low level languages, Java can perfectly be replaced by <em>C++</em>, <em>RUST</em> and others. Both of these languages provides low level capabilities (like writing operating systems, real time systems and such), while at the same time providing better high level traits like <em>C++</em>’s RAII or <em>RUST</em>’s statically guaranteed thread safety, both of these languages will avoid Java’s stupid <code>NullPointerException</code>.</p>
<h2 id="java-is-a-bad-high-level-language">Java is a bad high level language</h2>
<p>From the high level languages, Java can be replaced by virtually <strong>any</strong> other language. Almost any other language will provide a nicer syntax, better and more powerful ways of abstraction, more terseness, better tooling, better everything.</p>
<p>This makes Java completely replaceable by any other language, it serves no particular purpose and is particularly good at nothing.</p>
<h1 id="stupid-programmers-abstractfactory">Stupid programmers abstractFactory</h1>
<p>Professors in computer science Robert B.K. Dewar and Edmond Schonberg, published <a href="http://static1.1.sqspcdn.com/static/f/702523/9242013/1288741087497/200801-Dewar.pdf?token=%2B5Thxkc7TmMcmP0qpas4Xaozf%2Bg%3D">an article</a> in the “Journal of Defense Software Engineering” discussing how Java is a bad programming language for CS education, and how it produces programmers that are incapable of doing actual problem solving.</p>
<p>Java produces programmers that have no idea about how the computer actually works, how to face complex problems, and the intrinsic need of an IDE only makes the problem 10 times worst. These people will be completely incompetent if their IDEs would be taken away for one second.</p>
<p>Moreover, programmers that are only capable of writing Java are notoriously ignorant in programming languages theory or even CS in general for that matter, no computation theory knowledge, no algorithms knowledge, no nothing. The issue goes much more further into the same direction when you take into account IDE.</p>
<p>As Joel puts it in his article <a href="https://www.joelonsoftware.com/2005/12/29/the-perils-of-javaschools-2/">“The Perils of JavaSchools”</a></p>
<blockquote>
<p>I’ve seen that the 100% Java schools have started churning out quite a few CS graduates who are simply not smart enough to work as programmers on anything more sophisticated than Yet Another Java Accounting Applications</p>
</blockquote>
<p>Ah… Java Accounting Applications… It pretty much sums up the skills of Java-only programmers.</p>]]></summary>
</entry>
<entry>
    <title>Using Cassius (Shakespearean template) with Hakyll</title>
    <link href="http://www.sillybytes.net/posts/using_hakyll_with_cassius.html" />
    <id>http://www.sillybytes.net/posts/using_hakyll_with_cassius.html</id>
    <published>2017-04-11T00:00:00Z</published>
    <updated>2017-04-11T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/hakyllcassius/thumbnail.png" id="thumbnail" /><br />
</p>
<p>As a user of the <a href="http://www.yesodweb.com/">Yesod</a> framework, I’ve came to know and love the <a href="https://www.stackage.org/haddock/lts-8.4/shakespeare-2.0.12.1/Text-Cassius.html#v:cassius">Cassius</a> CSS templating language, although its reliance on Template Haskell is meant to fit better with the Yesod’s needs and makes it a bit cumbersome to use everywhere else, I still like the templating language itself and its features a lot.</p>
<p>That’s why I used it for styles generation in <a href="http://www.sillybytes.net">Silly Bytes</a> together with <a href="https://jaspervdj.be/hakyll/">Hakyll</a>. In this post I will describe the process.<br />
<br />
<br />
</p>
<!--more-->
<h1 id="cassius-files">Cassius files</h1>
<p>Our <code>.cassius</code> files will live inside the <code>css</code> directory, together with a <code>Gen.hs</code> Haskell module that will take the <em>Cassius</em> sources and compile them to <em>CSS</em>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">module</span> <span class="dt">Gen</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Text.Cassius</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Data.Text.Lazy</span> (unpack)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    writeFile <span class="st">&quot;default.css&quot;</span> <span class="fu">$</span> unpack <span class="fu">$</span> renderCss def</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    writeFile <span class="st">&quot;post.css&quot;</span> <span class="fu">$</span> unpack <span class="fu">$</span> renderCss post</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    writeFile <span class="st">&quot;post-list.css&quot;</span> <span class="fu">$</span> unpack <span class="fu">$</span> renderCss postList</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">def <span class="fu">=</span> <span class="fu">$</span>(cassiusFile <span class="st">&quot;default.cassius&quot;</span>) ()</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">post <span class="fu">=</span> <span class="fu">$</span>(cassiusFile <span class="st">&quot;post.cassius&quot;</span>) ()</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">postList <span class="fu">=</span> <span class="fu">$</span>(cassiusFile <span class="st">&quot;post-list.cassius&quot;</span>) ()</a></code></pre></div>
<p>This module, when executed (<code>runhaskell Gen.hs</code>), will compile the <em>Cassius</em> sources <code>default.cassius</code>, <code>post.cassius</code> and <code>post-list.cassius</code> to the corresponding <em>CSS</em> files that the -untouched- <em>CSS</em> rule in <code>site.hs</code> will take and use in the generated site.</p>
<h1 id="compiling">Compiling</h1>
<p>The <em>Cassius</em> compilation doesn’t happen when we <code>stack exec site build</code>, as we haven’t defined a rule, nor a compiler for them in <code>site.hs</code> and we won’t, because the Template Haskell requirements mess things up.</p>
<p>So instead we are going to have a <code>Makefile</code> that will watch for changes in all the <code>css/*.cassius</code> files and perform the recompilation by executing <code>Gen.hs</code>:</p>
<pre class="make"><code>.PHONY: build test css

build: css
    stack build
	stack exec site rebuild

css:
	cd css &amp;&amp; stack runhaskell Gen.hs

watch:
	while true; do make css; inotifywait -qre close_write css/*.cassius; done</code></pre>
<p>This way, we can execute <code>make watch</code> and it will recompile the <em>Cassius</em> files when needed. A normal <code>stack exec site watch</code> can be running along the side to take care of everything else.</p>]]></summary>
</entry>
<entry>
    <title>From Blogger to Hakyll</title>
    <link href="http://www.sillybytes.net/posts/from_blogger_to_hakyll.html" />
    <id>http://www.sillybytes.net/posts/from_blogger_to_hakyll.html</id>
    <published>2017-04-10T00:00:00Z</published>
    <updated>2017-04-10T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/bloggerhakyll/thumbnail.png" id="thumbnail" /><br />
</p>
<p><a href="https://jaspervdj.be/hakyll/">Hakyll</a> is an amazing static site generator written in Haskell, it allows for blog posts to be written in <em>markdown</em>, that are then compiled with <em>pandoc</em>, and is very well suited to be used with <em>GitHub pages</em>; It’s everything I wanted and more.</p>
<p><a href="http://www.sillybytes.net">Silly Bytes</a> went through its first 5 years of existence hosted on Google’s <a href="https://www.blogger.com">Blogger</a> service, and it did well. Although Blogger offers a fair amount of flexibility, you can’t have total control over it, and having to write posts with the built in <em>WYSIWYG</em> interface or pasting the HTML output is one of the bigger pain points of it. I solved most of that by writing a <a href="http://www.sillybytes.net/2016/09/how-do-i-blog-blogger-posts-from.html">CLI tool</a> that allows me to write my posts offline in <em>markdown</em>, compile them, and deploy them from my terminal leveraging the Blogger’s convenient API. But I still have the feeling that it isn’t good enough.</p>
<p>In this post I will describe the process of porting an existing Blogger blog to <em>Hakyll</em> and <em>GitHub pages</em> using <em>Silly Bytes</em> itself as a case study.</p>
<!--more-->
<h1 id="expectations">Expectations</h1>
<p>So here is what I want instead:</p>
<ol type="1">
<li>Completely port <em>Silly Bytes</em> to <em>Hakyll</em> and <em>GitHub pages</em></li>
</ol>
<p>Write every post in <em>markdown</em> only, and have them generated automatically.</p>
<ol start="2" type="1">
<li>Further customize the design</li>
</ol>
<p>While I’ve managed to get pretty far with Blogger’s custom CSS option, there are still some aspects that doesn’t quite fit what I want.</p>
<ol start="3" type="1">
<li>Preserve all the links to my previous posts</li>
</ol>
<p>There are quite a few links to my posts all over the place: Reddit, Taringa, ElHacker.net, Facebook, etc. I want them to keep them working just fine.</p>
<h1 id="the-initial-setup">The initial setup</h1>
<p>We’ll strive to keep the old blog completely functional till the last moment when we finally change where the domain name points to.</p>
<h2 id="github-page">GitHub page</h2>
<p><em>GitHub pages</em> will host the blog, so we must first create a repository that will keep it.</p>
<p>The <em>GitHub pages</em> <a href="https://help.github.com/articles/user-organization-and-project-pages/">naming convections</a> state that, in order to create a dedicated repo for a personal or organizational page, we must have a repository named <code>user.github.io</code> or <code>organization.github.io</code> respectively, this way GitHub will read and serve any <em>index</em> file in the repository root; This supposes a problem though, We want to keep our generated site inside a directory to keep them isolated from the sources files.</p>
<p>There are a couple of solutions for this, but they all use some Git branches trickery, juggling with a CI service, or both; It feels to hacky to me, not to say that my solution is more elegant, but it just fits better to the work flow I’m looking for.</p>
<p><em>GitHub pages</em> offers project specific pages as well, those are served from a dedicated <code>docs</code> directory on it, so this is what we’re going to use instead.</p>
<p>I’ve created a <code>sillybytes</code> <a href="https://github.com/sillybytes/sillybytes">repository</a> in the <code>sillybytes</code> organization. Then in <code>settings -&gt; GitHub Pages -&gt; Source</code> I’ve selected <code>master branch /docs folder</code> as the page source.</p>
<h2 id="hakyll-site">Hakyll site</h2>
<p>For the content of that repository, this will create the initial Hakyll scaffolding:</p>
<pre><code>$ hakyll-init sillybytes
$ cd sillybytes
$ stack init
$ stack build</code></pre>
<p>By default, Hakyll outputs the generated site in a <code>_site</code> directory, but <em>GitHub pages</em> will read the site from a <code>docs</code> directory, so let’s fix that by editing the <code>site.hs</code> file.</p>
<p>The default <code>main</code> function in <code>site.hs</code> uses the <code>hakyll</code> function, which uses the default configuration, so we must change that to use a custom one:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1">main <span class="fu">=</span> hakyllWith config <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">    <span class="fu">...</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="fu">...</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="ot">config ::</span> <span class="dt">Configuration</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">config <span class="fu">=</span> <span class="dt">Configuration</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    { destinationDirectory <span class="fu">=</span> <span class="st">&quot;docs&quot;</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">    , storeDirectory       <span class="fu">=</span> <span class="st">&quot;_cache&quot;</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    , tmpDirectory         <span class="fu">=</span> <span class="st">&quot;_cache/tmp&quot;</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    , providerDirectory    <span class="fu">=</span> <span class="st">&quot;.&quot;</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    , ignoreFile           <span class="fu">=</span> ignoreFile&#39;</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    , deployCommand        <span class="fu">=</span> <span class="st">&quot;echo &#39;No deploy command specified&#39; &amp;&amp; exit 1&quot;</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">    , deploySite           <span class="fu">=</span> system <span class="fu">.</span> deployCommand</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">    , inMemoryCache        <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">    , previewHost          <span class="fu">=</span> <span class="st">&quot;127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">    , previewPort          <span class="fu">=</span> <span class="dv">8000</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    }</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    ignoreFile&#39; path</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">        <span class="fu">|</span> <span class="st">&quot;.&quot;</span>    <span class="ot">`isPrefixOf`</span> fileName <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">        <span class="fu">|</span> <span class="st">&quot;#&quot;</span>    <span class="ot">`isPrefixOf`</span> fileName <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">        <span class="fu">|</span> <span class="st">&quot;~&quot;</span>    <span class="ot">`isSuffixOf`</span> fileName <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">        <span class="fu">|</span> <span class="st">&quot;.swp&quot;</span> <span class="ot">`isSuffixOf`</span> fileName <span class="fu">=</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">        <span class="fu">|</span> otherwise                    <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">        fileName <span class="fu">=</span> takeFileName path</a></code></pre></div>
<p>Here I’ve pretty much left the default configuration intact and only changed the <code>destinationDirectory</code> field to be <code>docs</code>.</p>
<p>Now recompile and regenerate the site:</p>
<pre><code>$ stack build
$ stack exec site rebuild</code></pre>
<p>And the generated site will now be on <code>docs</code>.</p>
<h2 id="deploying">Deploying</h2>
<p>The deployment process boils down to regenerating the site:</p>
<pre><code>$ stack exec site rebuild</code></pre>
<p>Committing the changes on <code>docs</code>:</p>
<pre><code>$ git add docs
$ git commit -m &quot;Build&quot;</code></pre>
<p>And pushing:</p>
<pre><code>$ git push origin master</code></pre>
<p>No need for esoteric spells here.</p>
<h1 id="dont-shatter-my-links">Don’t shatter my links!</h1>
<p><img src="/img/bloggerhakyll/links.png" class="img-responsive" /></p>
<p>It is imperative to preserve the links to my previous posts that were originally published on Blogger, so they keep pointing to the right post.</p>
<h2 id="preserve-legacy-paths">Preserve legacy paths</h2>
<p>Blogger paths convention is as follows:</p>
<p>Every post is on the corresponding <em>year</em> and <em>month</em> of publication name space like <code>year/month/post.html</code>. So we must preserve this structure at least for the legacy posts.</p>
<p>In order to achieve this, keep a <code>legacy</code> directory inside the <code>posts</code> directory, that will keep a directory tree for every year and month where posts exist.</p>
<pre><code>sillybytes/posts/legacy
|
+---2012
|   |
|   +----01
|   |    +---- post.md
|   |
|   +----02
|   |
|   +---- ...
|
|
+---2013
|   |
|   +----01
|   |
|   +----02
|   |
|   +---- ...
|
|
+--- ...
    |
    +----01
    |
    +----02
    |
    +---- ...</code></pre>
<p>Then we need an additional rule in <code>site.hs</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1">match <span class="st">&quot;posts/legacy/**&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">    route <span class="fu">$</span> customRoute <span class="fu">$</span> (flip replaceExtension <span class="st">&quot;html&quot;</span>) <span class="fu">.</span> joinPath</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">        <span class="fu">.</span> (drop <span class="dv">2</span>) <span class="fu">.</span> splitPath <span class="fu">.</span> toFilePath</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    compile <span class="fu">$</span> pandocCompiler</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">        <span class="fu">&gt;&gt;=</span> saveSnapshot <span class="st">&quot;content&quot;</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">        <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/post.html&quot;</span>    postCtx</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">        <span class="fu">&gt;&gt;=</span> loadAndApplyTemplate <span class="st">&quot;templates/default.html&quot;</span> postCtx</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">        <span class="fu">&gt;&gt;=</span> relativizeUrls</a></code></pre></div>
<p>This will ensure that the <code>year/month/post.html</code> directory structure is preserved on the resulting generated site.</p>
<h2 id="port-legacy-posts">Port legacy posts</h2>
<p>From here, a pretty much manual porting process is required. Most of my legacy posts were originally published right in the Blogger interface, so the must first be ported to <em>markdow</em>.</p>
<p>The porting process is as follows:</p>
<ol type="1">
<li>Visit the legacy post and copy the trailing name of it from the URL.</li>
<li>Create the appropriate directory structure inside <code>posts/legacy</code> to preserve the same <code>year/month/post.html</code> path.</li>
<li>Create a <em>markdown</em> file with the same name as it appears in the URL, but with the <code>.md</code> extension.</li>
<li>Create a dedicated directory for the post inside the <code>images</code> directory and put all the post images on it.</li>
<li>Paste and format the post content in the <em>markdown</em> file.</li>
</ol>
<p>Any newer posts that are created after the porting can live in the <code>posts</code> directory, there is no need to keep the <code>year/month/post.html</code> any more.</p>
<h1 id="the-migration">The migration</h1>
<p><img src="/img/bloggerhakyll/migration.jpg" class="img-responsive" /></p>
<p>The only thing that is left is the actual migration by pointing the domain name to the new location.</p>
<p>This arises a bigger problem though, given that we are serving the blog from <code>sillybytes/docs</code> we’ll need a <em>URL Redirect</em> record pointing to <code>sillybytes.github.io/sillybytes</code> rather than a <em>CNAME</em> to just <code>sillybytes.github.io</code>. If you’re fine with that, then you’re done.</p>
<p>I really wanted a proper <em>CNAME</em> record, so I had to change the setup a bit:</p>
<ul>
<li>Have two repositories: <code>sillybytes</code> for the sources, and <code>sillybytes.github.io</code> for the generated page.</li>
<li>A <em>deployment</em> consists of copying the content of the <code>docs</code> directory to the <code>sillybytes.github.io</code> repository.</li>
<li>Point the domain name with a <em>CNAME</em> record to <code>sillybytes.github.io</code>.</li>
</ul>
<h1 id="new-cli-tool">New CLI tool</h1>
<p><img src="/img/bloggerhakyll/shot.png" class="img-responsive" /></p>
<p>The <a href="https://github.com/sillybytes/sillybytes_tool">CLI tool</a> I was using before for Blogger deployment is no longer useful, but I can still adapt it to the new deployment schema:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="fu">cp</span> -rfv _site/* ../sillybytes.github.io/</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="bu">cd</span> ../sillybytes.github.io</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="ex">display_info</span> <span class="st">&quot;Deploying...&quot;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="fu">git</span> add .</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="fu">git</span> commit -m <span class="st">&quot;Deploy&quot;</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="fu">git</span> push origin master</a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="ex">display_success</span> <span class="st">&quot;Deployed!&quot;</span></a></code></pre></div>
<p>As well as aliasing common <em>Hakyll</em> commands:</p>
<p><img src="/img/bloggerhakyll/shot1.png" class="img-responsive" /></p>]]></summary>
</entry>
<entry>
    <title>How do I blog? - Blogger posts from markdown and CLI</title>
    <link href="http://www.sillybytes.net/2016/09/how-do-i-blog-blogger-posts-from.html" />
    <id>http://www.sillybytes.net/2016/09/how-do-i-blog-blogger-posts-from.html</id>
    <published>2016-09-23T00:00:00Z</published>
    <updated>2016-09-23T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/blogger/thumbnail.png" id="thumbnail" /><br />
</p>
<p>There are plans to migrate <a href="http://sillybytes.net">Silly Bytes</a> to <a href="https://jaspervdj.be/hakyll/">Hakyll</a> and GitHub pages, but till then I’m still using <a href="http://www.blogger.com">Blogger</a> and I wanted to make the posting process as painless and automatic as possible.</p>
<p>Every post I write is currently a separate git repo hosted on the <a href="https://github.com/sillybytes">Silly Bytes GitHub organization</a>. The post is written and maintained in Markdown using Pandoc and a convenient Makefile generated by the <a href="https://github.com/alx741/made">made script</a>.</p>
<p>Writing posts in Markdown is nice but is not very useful if you still have to mess around with Blogger’s web interface, so here is the plan:</p>
<ul>
<li>Write post in <em>Markdown</em></li>
<li>Use <em>made</em> to generate a <em>Makefile</em></li>
<li>Generate HTML with the <em>Makefile</em> <code>$ make</code></li>
<li>Push the HTML post to Blogger using Google APIs</li>
</ul>
<!--more-->
<p>The first 3 steps are already covered so lets dig into the Blogger negotiation part.</p>
<h2 id="api-script">API script</h2>
<p><a href="https://developers.google.com/api-client-library/python/start/installation">Google APIs</a> come in handy here, the best language option was Python (<a href="http://www.sillybytes.net/2016/03/why-do-i-hate-java.html">I refuse tu use Java</a>). So starting from an <a href="https://github.com/google/google-api-python-client/tree/master/samples/blogger">example</a> I came up with this <sub>ugly</sub> code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">#!/usr/bin/env python</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co"># -*- coding: utf-8 -*-</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="im">from</span> __future__ <span class="im">import</span> print_function</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="im">from</span> googleapiclient <span class="im">import</span> discovery</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="im">from</span> oauth2client <span class="im">import</span> client</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="im">from</span> oauth2client <span class="im">import</span> <span class="bu">file</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="im">from</span> oauth2client <span class="im">import</span> tools</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="im">import</span> sys</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="im">import</span> os</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="im">import</span> httplib2</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="im">import</span> argparse</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">SILLYBYTESID<span class="op">=</span><span class="st">&quot;1318550761233559867&quot;</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw">def</span> main(argv):</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    <span class="cf">if</span> (<span class="bu">len</span>(argv) <span class="op">&lt;</span> <span class="dv">3</span>):</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">        <span class="bu">print</span>(<span class="st">&quot;Post title must be provided as the first argument and html file as the second&quot;</span>)</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">        exit(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    post_title <span class="op">=</span> argv[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">    input_file <span class="op">=</span> argv[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb1-23" data-line-number="23"></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">    scope <span class="op">=</span> <span class="st">&#39;https://www.googleapis.com/auth/blogger&#39;</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"></a>
<a class="sourceLine" id="cb1-26" data-line-number="26">    parent_parsers <span class="op">=</span> [tools.argparser]</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">    parent_parsers.extend([])</a>
<a class="sourceLine" id="cb1-28" data-line-number="28">    parser <span class="op">=</span> argparse.ArgumentParser(</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">        description<span class="op">=</span>__doc__,</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">        formatter_class<span class="op">=</span>argparse.RawDescriptionHelpFormatter,</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">        parents<span class="op">=</span>parent_parsers)</a>
<a class="sourceLine" id="cb1-32" data-line-number="32">    flags <span class="op">=</span> parser.parse_args(<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb1-33" data-line-number="33"></a>
<a class="sourceLine" id="cb1-34" data-line-number="34">    <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb1-35" data-line-number="35">        client_secrets <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&quot;~&quot;</span>) <span class="op">+</span> <span class="st">&#39;/.sillybytes/&#39;</span>,</a>
<a class="sourceLine" id="cb1-36" data-line-number="36">                                    <span class="st">&#39;secrets.json&#39;</span>)</a>
<a class="sourceLine" id="cb1-37" data-line-number="37">    <span class="cf">except</span>:</a>
<a class="sourceLine" id="cb1-38" data-line-number="38">        <span class="bu">print</span>(<span class="st">&quot;Can&#39;t find secrets.json file maybe?&quot;</span>)</a>
<a class="sourceLine" id="cb1-39" data-line-number="39">        exit(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-40" data-line-number="40"></a>
<a class="sourceLine" id="cb1-41" data-line-number="41">    flow <span class="op">=</span> client.flow_from_clientsecrets(client_secrets,</a>
<a class="sourceLine" id="cb1-42" data-line-number="42">                                        scope<span class="op">=</span>scope,</a>
<a class="sourceLine" id="cb1-43" data-line-number="43">                                        message<span class="op">=</span>tools.message_if_missing(client_secrets))</a>
<a class="sourceLine" id="cb1-44" data-line-number="44"></a>
<a class="sourceLine" id="cb1-45" data-line-number="45">    storage <span class="op">=</span> <span class="bu">file</span>.Storage(<span class="st">&#39;auth_data&#39;</span> <span class="op">+</span> <span class="st">&#39;.dat&#39;</span>)</a>
<a class="sourceLine" id="cb1-46" data-line-number="46">    credentials <span class="op">=</span> storage.get()</a>
<a class="sourceLine" id="cb1-47" data-line-number="47">    <span class="cf">if</span> credentials <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> credentials.invalid:</a>
<a class="sourceLine" id="cb1-48" data-line-number="48">        credentials <span class="op">=</span> tools.run_flow(flow, storage, flags)</a>
<a class="sourceLine" id="cb1-49" data-line-number="49"></a>
<a class="sourceLine" id="cb1-50" data-line-number="50">    http <span class="op">=</span> credentials.authorize(http <span class="op">=</span> httplib2.Http())</a>
<a class="sourceLine" id="cb1-51" data-line-number="51">    service <span class="op">=</span> discovery.build(<span class="st">&#39;blogger&#39;</span>, <span class="st">&#39;v3&#39;</span>, http<span class="op">=</span>http)</a>
<a class="sourceLine" id="cb1-52" data-line-number="52"></a>
<a class="sourceLine" id="cb1-53" data-line-number="53">    <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb1-54" data-line-number="54">        content <span class="op">=</span> <span class="bu">open</span>(input_file, <span class="st">&#39;r&#39;</span>).read()</a>
<a class="sourceLine" id="cb1-55" data-line-number="55">    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</a>
<a class="sourceLine" id="cb1-56" data-line-number="56">        <span class="bu">print</span>(<span class="st">&quot;Input file not found&quot;</span>)</a>
<a class="sourceLine" id="cb1-57" data-line-number="57">        exit(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-58" data-line-number="58"></a>
<a class="sourceLine" id="cb1-59" data-line-number="59">    body <span class="op">=</span> {</a>
<a class="sourceLine" id="cb1-60" data-line-number="60">        <span class="st">&quot;kind&quot;</span>: <span class="st">&quot;blogger#post&quot;</span>,</a>
<a class="sourceLine" id="cb1-61" data-line-number="61">        <span class="st">&quot;title&quot;</span>: post_title,</a>
<a class="sourceLine" id="cb1-62" data-line-number="62">        <span class="st">&quot;content&quot;</span>: content</a>
<a class="sourceLine" id="cb1-63" data-line-number="63">    }</a>
<a class="sourceLine" id="cb1-64" data-line-number="64"></a>
<a class="sourceLine" id="cb1-65" data-line-number="65">    <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb1-66" data-line-number="66">        posts <span class="op">=</span> service.posts()</a>
<a class="sourceLine" id="cb1-67" data-line-number="67">        request <span class="op">=</span> posts.insert(blogId<span class="op">=</span>SILLYBYTESID, body<span class="op">=</span>body, isDraft<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb1-68" data-line-number="68">        result <span class="op">=</span> request.execute()</a>
<a class="sourceLine" id="cb1-69" data-line-number="69">        <span class="bu">print</span>(<span class="st">&quot;Live: &quot;</span> <span class="op">+</span> result[<span class="st">&#39;url&#39;</span>])</a>
<a class="sourceLine" id="cb1-70" data-line-number="70">    <span class="cf">except</span>:</a>
<a class="sourceLine" id="cb1-71" data-line-number="71">        <span class="bu">print</span>(<span class="st">&quot;Can&#39;t execute request&quot;</span>)</a>
<a class="sourceLine" id="cb1-72" data-line-number="72">        exit(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-73" data-line-number="73"></a>
<a class="sourceLine" id="cb1-74" data-line-number="74"><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</a>
<a class="sourceLine" id="cb1-75" data-line-number="75">main(sys.argv)</a></code></pre></div>
<p>The script will initiate a OAuth negotiation when needed and store the authentication tokens in the <code>auth_data.dat</code> file.</p>
<p>Install some python dependencies (Arch):</p>
<pre><code>$ pacman -S python-google-api-python-client
$ pacman -S python-oauth2client</code></pre>
<h2 id="api-project">API project</h2>
<p>Before we’re able to use this we need to create a new <em>API project</em>, configure it and get the <code>client_secrets.json</code> that the script will use to start the OAuth negotiation.</p>
<p>First enable the <em>Blogger</em> API at: https://console.developers.google.com/apis/library</p>
<p>Then create a new project, create a new credential and download the JSON file from it. Don’t worry you’ll find your way in the interface. If you read the script you’ll notice my <code>client_secrets.json</code> file will be located at <code>~/.sillybytes</code>.</p>
<p>Now doing:</p>
<pre><code>$ python deploy.py &quot;post title&quot; &quot;post HTML&quot;</code></pre>
<p>Will push the post to Blogger! So we’re done (?) not yet.</p>
<h2 id="cli-tool">CLI tool</h2>
<p>This is good enough already, we could invoke <code>deploy.py</code> from the Makefile, but it can be better.</p>
<p>I wrote a tool: <a href="https://github.com/sillybytes/sillybytes_tool/tree/blogger">silly</a>.</p>
<pre><code>$ silly help</code></pre>
<p><img src="/img/blogger/shot.png" class="img-responsive" /></p>
<p>I think the screenshot explains all by it self… Now i can create all the post boilerplate by doing <code>silly new</code> and deploying the current post with <code>silly deploy</code> how cool is that?</p>]]></summary>
</entry>
<entry>
    <title>Gentle introduction to STM32 ARM Cortex microcontrollers and boards programming</title>
    <link href="http://www.sillybytes.net/2016/09/gentle-introduction-to-stm32-arm-cortex.html" />
    <id>http://www.sillybytes.net/2016/09/gentle-introduction-to-stm32-arm-cortex.html</id>
    <published>2016-09-11T00:00:00Z</published>
    <updated>2016-09-11T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/stm32/thumbnail.png" id="thumbnail" /><br />
</p>
<p>So you have been using AVR, PIC or some other microcontroller for a while and discover that ST Microelectronics offers some pretty cheap 32 bit ARM and feature rich microcontrollers: <a href="http://www.st.com/content/st_com/en/products/microcontrollers/stm32-32-bit-arm-cortex-mcus.html?querycriteria=productId=SC1169">STM32</a>, and want to start playing with them but don’t know how or where to start; I’m here to help.</p>
<p><a href="https://en.wikipedia.org/wiki/ARM_architecture">ARM</a> is taking over the embedding wold, they’re ubiquitous in smart phones, tablets, laptops, other computers, cars, refrigerators, microwave ovens, monitors, printers, you name it!</p>
<p>Note: Be aware that <em>ARM</em> is an <strong>architecture</strong> that manufacturers can <em>implement</em>. Is a common mistake to think <em>ARM</em> is a microcontroller on itself, it is not.</p>
<!--more-->
<p>ST Microelectronics’s implementation of ARM are the STM32 microcontrollers: inexpensive, powerful and with great free software/hardware support.</p>
<p>Various series are available: F0, F1, F2, …, F7; From less to more powerful. You can identify your chip series after the <em>STM32</em> prefix, I’m using a board with the “STM32F103C8” chip, so the series is <em>F1</em>.</p>
<h2 id="hardware">Hardware</h2>
<p>As I mentioned STM32 chips are very inexpensive and widely available as individual chips, mounted in convenient development boards or breakout boards.</p>
<p>Individual chips can be bought from electronic stores like Digi-Key or Mauser, but for the current purposes making your own PCB to mount them is quite inconvenient.</p>
<p>The other option is to get one of the nice development boards ST offers:</p>
<ul>
<li><a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-eval-boards.html?querycriteria=productId=LN1199">Eval</a></li>
<li><a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-nucleo.html?querycriteria=productId=LN1847">Nucleo</a></li>
<li><a href="http://www.st.com/content/st_com/en/products/evaluation-tools/product-evaluation-tools/mcu-eval-tools/stm32-mcu-eval-tools/stm32-mcu-discovery-kits.html?querycriteria=productId=LN1848">Discovery</a></li>
</ul>
<p><img src="/img/stm32/shot1.png" class="img-responsive" /></p>
<p>Although these are cheap and amazing, we can go even cheaper with the great breakout boards available on Ebay. You can get a STM32F103 chip in a nice board for less than $5 (USD).</p>
<p><img src="/img/stm32/shot2.png" class="img-responsive" /> <img src="/img/stm32/shot3.png" class="img-responsive" /></p>
<h3 id="programmer">Programmer</h3>
<p>STM32 chips are programmed using a <a href="https://en.wikipedia.org/wiki/ARM_architecture">ST-LINK</a> device, which is an in-circuit debugger and programmer that interfaces with the chip using JTAG or Serial Wire Debugging (<a href="http://www.arm.com/products/system-ip/debug-trace/coresight-soc-components/serial-wire-debug.php">SWD</a>). This is similar to the USBASP for AVR or the PICkit for PIC.</p>
<p>Development boards like the <em>Nucleo</em> include the st-link hardware directly into the board, so you can connect it to a host computer using USB and program/debug the target chip on the board without any additional external hardware.</p>
<p><img src="/img/stm32/shot4.png" class="img-responsive" /></p>
<p>If you’re using another breakout board (like the Ebay ones) or if you mounted a chip in a custom PCB, you will need an external st-link hardware. Fortunately they are also available for cheap on Ebay or you can buy the official one for a few extra bucks if you prefer, they both will work exactly the same with the flashing software.</p>
<p><img src="/img/stm32/shot5.png" class="img-responsive" /> <img src="/img/stm32/shot6.png" class="img-responsive" /></p>
<h4 id="connections">Connections</h4>
<p>If you’re using a ST development board with the st-link built in just connect it to your computer and you’re ready to go, but for breakout boards and a dongle st-link you’ll need to connect four wires to it:</p>
<ul>
<li>VCC (3.3V)</li>
<li>GND</li>
<li>SWCLK</li>
<li>SWDIO</li>
</ul>
<p><strong>WARNING:</strong> STM32 chips run on 3.3V, most breakout boards will include a voltage regulator so it can be powered from USB, and st-link dongles will provide a 3.3V VCC PIN to power up the chip. <strong>DON’T</strong> Connect the board to the PC using USB while the chip is powered up using the st-link programmer! Connect one or the other but not both simultaneously. The st-link dongle provides a 5V PIN as well, <strong>DON’T</strong> use it, the STM32 chips are not 5V tolerant, use the 3.3V PIN only.</p>
<p>ST-Link dongles have labeling on the front, just connect the right pins. On the board side, follow the labeling printed on the pins or use a JTAG/SWD pin out diagram if your board has a JTAG/SWD connector like mine. The connections for the st-link on the breakout board I’m using looks like this:</p>
<p><img src="/img/stm32/scheme1.jpg" class="img-responsive" /> <img src="/img/stm32/shot7.jpg" class="img-responsive" /> <img src="/img/stm32/shot8.jpg" class="img-responsive" /></p>
<h2 id="software">Software</h2>
<h3 id="host-pc">Host PC</h3>
<p>You’ll need a compiler, a debugger, some utilities to manage your binaries and the necessary software to flash your firmware using the ST-LINK device (dongle or built-in):</p>
<ul>
<li>arm-none-eabi-gcc</li>
<li>arm-none-eabi-gdb</li>
<li>arm-none-eabi-binutils</li>
<li>stlink</li>
</ul>
<p>You should be able to install them all of from your distribution repositories. But in case you can’t find <code>stlink</code> on them, get it from the <a href="https://github.com/texane/stlink">github repo</a>.</p>
<p>The <code>stlink</code> package provides these executables:</p>
<ul>
<li>st-flash (Write and Read a program from the target chip)</li>
<li>st-util (Creates a GDB server so you can load, run and debug a program on the target chip)</li>
<li>st-info (Search and provides information about the st-link device and the target chip)</li>
<li>st-term (Allows to get log-like reports from the program on the target chip)</li>
</ul>
<h4 id="test-the-setup">Test the setup</h4>
<p>With the hardware connected and the PC software installed we can try it out and see if everything is working OK. Not example program yet though.</p>
<p>Connect your st-link device (connected to the breakout board) or you development board to the host PC using USB and run:</p>
<pre><code>$ st-info --probe</code></pre>
<p>You’ll get some neat information about the chip that is hooked up to the st-link device:</p>
<pre><code>Found 1 stlink programmers
serial: 543f6a06663f505130531567
openocd: &quot;\x54\x3f\x6a\x06\x66\x3f\x50\x51\x30\x53\x15\x67&quot;
flash: 65536 (pagesize: 1024)
sram: 20480
chipid: 0x0410
descr: F1 Medium-density device</code></pre>
<p>Fantastic! Everything is working fine, lets move on.</p>
<h3 id="chip">Chip</h3>
<p>ARM provides a Cortex Microcontroller Software Interface Standard (<a href="http://www.arm.com/products/processors/cortex-m/cortex-microcontroller-software-interface-standard.php">SMSIS</a>) as an abstraction layer for the ARM Cortex core to increase software portability. Think of it as an standard API that you can use to interface with ARM chips in a standard and vendor independent way.</p>
<p>On top of that you might want to have a Hardware Abstraction Layer (HAL) to interface with the peripherals the chip provides (UART, USB, I2C, SPI, TIMERS, etc).</p>
<p>We have two options of libraries that provide those abstraction layers:</p>
<ul>
<li><a href="http://libopencm3.github.io/">LibOpenCM3</a> (The one we are going to use)</li>
<li><a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32cube-embedded-software/stm32cubef1.html">STM32Cube</a></li>
</ul>
<p>LibOpenCM3 uses the LGPL licence (which I prefer), and STM32Cube uses the lax BSD licence. Balau covered the licensing topic in more detail in his <a href="https://balau82.wordpress.com/2015/04/12/libopencm3-for-the-license-sensitive-cortex-m-developer/">blog post</a>.</p>
<h4 id="stm32cube">STM32Cube</h4>
<p>ST provides the so called “STM32Cube”, which is a bundle of software and libraries for STM32 development. It contains a graphical software for basic C code generation, software layers of abstraction like HAL and middleware, software layers for built-in peripherals on ST’s development boards and examples.</p>
<p>The <em>STM32Cube</em> is available per chip series, so for development boards with STM32F4xx chips you’ll need the <em>STM32CubeF4</em>. I have a breakout board with the STM32F103C8 chip, so I would use the <a href="http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32cube-embedded-software/stm32cubef1.html"><em>STM32CubeF1</em></a>, you get the idea.</p>
<p>STM32Cube provides 3 layers:</p>
<h5 id="level-0">Level 0</h5>
<ul>
<li>Board Support Package (BSP) for interfacing with devices on the board that are not in the STM32 chip.</li>
<li>Hardware Abstraction Layer (HAL) for low-level hardware interfacing (UART, USB, I2C, SPI, TIMERS, etc).</li>
</ul>
<h5 id="level-1">Level 1</h5>
<p>Middleware software components like USB Host and Device libraries or FAT file system for SD cards interfacing</p>
<h5 id="level-2">Level 2</h5>
<p>Graphical demonstration that uses the level 1 Middleware.</p>
<p>You can read more about it on the STM32Cube user manual. Here is the STM32CubeF1 <a href="http://www.st.com/content/ccc/resource/technical/document/user_manual/a4/ae/25/45/76/ca/40/b1/DM00151047.pdf/files/DM00151047.pdf/jcr:content/translations/en.DM00151047.pdf">manual</a>.</p>
<h4 id="libopencm3">LibOpenCM3</h4>
<p>LibOpenCM3 aims to provide a free (as in freedom) library for various ARM Cortex-M3 microcontrollers, including the STM32 chips.</p>
<p>Using this library is more or less straight forward, there is no layers here. You can read more about it in the <a href="http://libopencm3.org/wiki/Main_Page">wiki</a>. They have a fantastic Doxygen documentation for the API <a href="http://libopencm3.github.io/docs/latest/html/">here</a>.</p>
<h2 id="first-program">First program</h2>
<p>The LibOpenCM3 project provides very useful examples, lets use one of those as the first program. I’m Using the STM32F103C8T6 so I need the <em>F1</em> series examples and libraries, adjust the steps to use the appropriate one for your chip/board.</p>
<p>Notice that the examples are organized to correspond to various development boards, but it doesn’t really matter, the reason for this is the distribution of LED’s and Push buttons in those boards, but as long as you’re using the same chip series you just need to pickup one and connect LED’s, buttons, etc in the right pins as needed. I’m going to use the examples for the <em>“stm32-h103”</em> board from Olimex, even though I’m using a breakout board from Ebay; The <strong>F1</strong> is the important thing here.</p>
<pre><code>$ git clone --recursive &#39;https://github.com/libopencm3/libopencm3-examples&#39;
$ cd libopencm3-examples
$ make
$ cd examples/stm32
$ cd f1
$ cd stm32-h103/miniblink</code></pre>
<p>This example will BLINK a LED connected in the PIN 12 of the GPIO port C, but my chip doesn’t have it! No problem, I’m going to change it (you can use your favorite editor here):</p>
<pre><code>$ vim miniblink.c</code></pre>
<p>Now change all appearances of <code>GPIOC</code> to <code>GPIOB</code> so the program uses the GPIO port B instead. (Use an available pin in your specific chip/board).</p>
<p>In Vim:</p>
<pre><code>:%s/GPIOC/GPIOB</code></pre>
<p>Save the file and compile:</p>
<pre><code>$ make</code></pre>
<p>Generate the binary:</p>
<pre><code>$ arm-none-eabi-objcopy -O binary miniblink.elf miniblink.bin</code></pre>
<p>Flash it:</p>
<pre><code>$ st-flash write miniblink.bin 0x8000000</code></pre>
<p>Connect a LED to the GND and PB12 pins through a 330 Ohm resistor and watch it blink with great joy.</p>
<h2 id="using-gdb">Using GDB</h2>
<p>You can also interface with the target device using GDB: Upload firmware, run, stop, set break points, etc. I’m going to assume you know how to use GDB and only going to explain how to upload the firmware from it.</p>
<p>Create a GDB server to interface with the connected target:</p>
<pre><code>$ st-util -p 4444</code></pre>
<p>Run ARM GDB:</p>
<pre><code>$ arm-none-eabi-gdb</code></pre>
<p>Connect to the server</p>
<pre><code>(gdb) target extended-remote localhost:4444</code></pre>
<p>Flash the firmware (notice we’re using the ELF file here not the BIN one):</p>
<pre><code>(gdb) load miniblink.elf</code></pre>
<p>Run the firmware:</p>
<pre><code>(gdb) continue</code></pre>
<p>You can stop it with <code>C-c</code>.</p>
<p><img src="/img/stm32/shot9.jpg" class="img-responsive" /></p>]]></summary>
</entry>
<entry>
    <title>TDD (Test-Driven Development) Physical Traffic Light</title>
    <link href="http://www.sillybytes.net/2016/08/tdd-test-driven-development-physical.html" />
    <id>http://www.sillybytes.net/2016/08/tdd-test-driven-development-physical.html</id>
    <published>2016-08-28T00:00:00Z</published>
    <updated>2016-08-28T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/tddlight/thumbnail.jpg" id="thumbnail" /><br />
</p>
<p>Robert C. Martin <em>(Uncle Bob)</em> said in a talk:</p>
<blockquote>
<p>Imagine you have a button that you can push, it will test your code and if everything is working a green light will come up, but if something is broken, a red light will come up […]</p>
</blockquote>
<p>He was of course talking about TDD. I got inspired to build this little toy.</p>
<p>Hardware schematics, firmware and host software is available in <a href="https://github.com/alx741/tdd_traffic-light">this Github repo</a>. Along with information on how to compile and use.</p>
<blockquote>
<p>This is a physical toy traffic light to be used with software development TDD (and testing in general) tools. It will not boost your productivity nor make you a better programmer or TDD practitioner, but it looks cool :)</p>
</blockquote>
<p>Lets explain how it works, it’s very simple: <!--more--></p>
<h1 id="hardware">Hardware</h1>
<p>The <strong>atmega328p</strong> AVR microcontroller is very popular and cheap, but if you buy them on Ebay for example, chances are it comes with an Arduino bootloader, which gets in the way because we can perfectly use the internal oscillator instead of an external 16Mhz crystal. So the first thing to do is change the fuses to the default ones:</p>
<pre class="shell"><code># avrdude -p m328p -c usbasp -U lfuse:w:0x62:m -U hfuse:w:0xd9:m</code></pre>
<p>Now we are using the internal 1MHz oscillator, perfect!</p>
<p>I don’t have a PCB yet (although it should be pretty easy as I made the circuit schematic using <em>kicad</em>) but the circuit is small and simple so it’s easy to build it with prototype PCB. Additionally I added some small neodymium magnets in the back to stick it easily close to my monitors.</p>
<p><img src="/img/tddlight/img1.jpg" class="img-responsive" /> <img src="/img/tddlight/img2.jpg" class="img-responsive" /> <img src="/img/tddlight/img3.jpg" class="img-responsive" /> <img src="/img/tddlight/img4.jpg" class="img-responsive" /> <img src="/img/tddlight/img5.jpg" class="img-responsive" /> <img src="/img/tddlight/img6.jpg" class="img-responsive" /> <img src="/img/tddlight/img7.jpg" class="img-responsive" /> <img src="/img/tddlight/img8.jpg" class="img-responsive" /></p>
<h1 id="software">Software</h1>
<p>The firmware is no more than UART boilerplate with <code>4800</code> baud rate so it is stable with at 1MHz clock speed.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;avr/io.h&gt;</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;util/delay.h&gt;</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="pp">#define F_CPU 1000000</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="pp">#define BAUD 4800</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="pp">#define BAUD_PRESCALE ((((F_CPU/16) + (BAUD/2)) / (BAUD)) - 1)</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="dt">char</span> getchar(<span class="dt">void</span>)</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">{</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">    <span class="cf">while</span> ((UCSR0A &amp; (<span class="dv">1</span> &lt;&lt; RXC0)) == <span class="dv">0</span>) {}</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    <span class="cf">return</span> UDR0;</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">}</a></code></pre></div>
<p>The main loop will wait for a command <code>r</code>, <code>y</code> or <code>g</code> and turn on the pin corresponding to the color LED.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;avr/io.h&gt;</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;util/delay.h&gt;</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="pp">#define F_CPU 1000000</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="pp">#define BAUD 4800</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="pp">#define BAUD_PRESCALE ((((F_CPU/16) + (BAUD/2)) / (BAUD)) - 1)</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="dt">char</span> getchar(<span class="dt">void</span>)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">{</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="cf">while</span> ((UCSR0A &amp; (<span class="dv">1</span> &lt;&lt; RXC0)) == <span class="dv">0</span>) {}</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">    <span class="cf">return</span> UDR0;</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">}</a></code></pre></div>
<p>Notice how if another character is received the output is cleared so all the LEDs are off.</p>
<p>The host software configures the serial port with a <code>4800</code> baud rate:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="dt">void</span> serial_init(<span class="dt">char</span>* port)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">{</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="cf">if</span> (COM_FD &gt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    {</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">        <span class="cf">return</span>;</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    }</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="co">// Open serial port file</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">    <span class="dt">int</span> fd = open(port, O_RDWR | O_NOCTTY | O_NDELAY);</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">    <span class="co">// Configure serial port</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">    <span class="kw">struct</span> termios config;</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">    <span class="cf">if</span> (tcgetattr(fd, &amp;config) != <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">    {</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">        COM_FD = <span class="dv">-1</span>;</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">        printf(<span class="st">&quot;Error while configing serial port&quot;</span>);</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">        exit(<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">    }</a>
<a class="sourceLine" id="cb4-19" data-line-number="19"></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">    cfsetispeed(&amp;config, B4800);</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">    cfsetospeed(&amp;config, B4800);</a>
<a class="sourceLine" id="cb4-22" data-line-number="22"></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">    config.c_cflag |= (CLOCAL | CREAD | CS8);</a>
<a class="sourceLine" id="cb4-24" data-line-number="24">    config.c_cflag &amp;= ~(PARENB | PARODD);</a>
<a class="sourceLine" id="cb4-25" data-line-number="25">    config.c_iflag = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-26" data-line-number="26">    config.c_oflag = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-27" data-line-number="27">    config.c_lflag &amp;= ~(ICANON | ECHO | ECHOE | ISIG);</a>
<a class="sourceLine" id="cb4-28" data-line-number="28">    config.c_cc[VTIME] = <span class="dv">5</span>;</a>
<a class="sourceLine" id="cb4-29" data-line-number="29">    config.c_cc[VMIN] = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-30" data-line-number="30"></a>
<a class="sourceLine" id="cb4-31" data-line-number="31">    <span class="cf">if</span> (tcsetattr(fd, TCSANOW, &amp;config) != <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-32" data-line-number="32">    {</a>
<a class="sourceLine" id="cb4-33" data-line-number="33">        COM_FD = <span class="dv">-1</span>;</a>
<a class="sourceLine" id="cb4-34" data-line-number="34">        printf(<span class="st">&quot;Error while configing serial port&quot;</span>);</a>
<a class="sourceLine" id="cb4-35" data-line-number="35">        exit(<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb4-36" data-line-number="36">    }</a>
<a class="sourceLine" id="cb4-37" data-line-number="37"></a>
<a class="sourceLine" id="cb4-38" data-line-number="38">    COM_FD = fd;</a></code></pre></div>
<p>From then controlling the LEDs is as simple as</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" data-line-number="1">write(COM_FD, <span class="st">&quot;r&quot;</span>, <span class="dv">1</span>);</a></code></pre></div>
<p>Find more information about how to use it in the <a href="https://github.com/alx741/tdd_traffic-light">Github repo</a>.</p>]]></summary>
</entry>
<entry>
    <title>Vim + Haskell</title>
    <link href="http://www.sillybytes.net/2016/08/vim-haskell_11.html" />
    <id>http://www.sillybytes.net/2016/08/vim-haskell_11.html</id>
    <published>2016-08-11T00:00:00Z</published>
    <updated>2016-08-11T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/vimhask/thumbnail.png" id="thumbnail" /><br />
</p>
<p>So you’re writing in the right language using the right tool already, but let’s put some extra magic under our sleeves.<br />
<br />
<br />
<br />
</p>
<h2 id="expectations">Expectations</h2>
<ul>
<li>Omnicompletion</li>
<li>Compilation and testing
<ul>
<li>Building</li>
<li>Testing</li>
</ul></li>
<li>GHCI integration</li>
<li>Hoogle integration</li>
<li>Convenient mappings
<ul>
<li>Argument text object</li>
<li>Jump to importations</li>
<li>Jump between functions</li>
</ul></li>
<li>Ghc-mod integration
<ul>
<li>Type inserting</li>
<li>Case splitting</li>
<li>Type asserting</li>
</ul></li>
<li>Hlint integration
<ul>
<li>Linting</li>
<li>Managing the locationlist</li>
</ul></li>
<li>Code formatting
<ul>
<li>Hindent integration</li>
<li>Trailing white space</li>
<li>Trailing blank lines</li>
<li>Spaces over tabs</li>
</ul></li>
<li>Easy arrows generation</li>
<li>Types abbreviations</li>
<li>Yesod Haskell web framework</li>
</ul>
<!--more-->
<p>Most of this functionality is achieved by using already available tools and already available Vim plugins for those tools. So I’ll assume you have your way to install the plugins (I’m using <a href="https://github.com/junegunn/vim-plug">vim-plug</a>).</p>
<p>Here is my complete <a href="https://github.com/alx741/dotfiles/blob/master/nvim/.config/nvim/init.vim">.vimrc</a>.</p>
<p><strong>Important</strong>: Every line of vimrc used should be enclosed in an <code>:h :augroup</code>:</p>
<pre class="vim"><code>augroup ft_haskell
    au!

    ...

augroup END</code></pre>
<h3 id="omnicompletion">Omnicompletion</h3>
<p>The <a href="https://github.com/eagletmt/neco-ghc">neco-ghc</a> plugin declares a complete omnifunction. Use it by defining the local <code>omnifunc</code>:</p>
<pre class="vim"><code>au FileType haskell setlocal omnifunc=necoghc#omnifunc</code></pre>
<p><img src="/img/vimhask/shot1.gif" class="img-responsive" /></p>
<h3 id="compilation-and-testing">Compilation and testing</h3>
<p>I’ve contributed the GHC compiler plugin to upstream Vim recently, but it may take a while before you get the latest vim runtime from your distribution. So in the meantime you can install it like any other plugin from the GitHub repository here: https://github.com/alx741/ghc.vim</p>
<p>Then load it for the Haskell <em>filetype</em> in you <em>vimrc</em>:</p>
<pre class="vim"><code>au FileType haskell compiler ghc</code></pre>
<p>Taking advantage of vim 8 asynchronous job control using the <a href="https://github.com/skywind3000/asyncrun.vim">asyncrun.vim</a> plugin, we can define some convenient mappings for building and testing using Haskell <em>stack</em>:</p>
<pre class="vim"><code>au FileType haskell setlocal makeprg=stack
au FileType haskell nnoremap &lt;buffer&gt; gj :write&lt;CR&gt; :exec &quot;AsyncRun &quot; . &amp;makeprg . &quot; build&quot;&lt;CR&gt;
au FileType haskell nnoremap &lt;buffer&gt; gk :write&lt;CR&gt; :exec &quot;AsyncRun &quot; . &amp;makeprg . &quot; test&quot;&lt;CR&gt;</code></pre>
<p>After running one of those the results will be loaded into the <em>quickfix</em> list.</p>
<h3 id="ghci-integration">GHCI integration</h3>
<p>There are plugins that offer much more tight integration, but for me it is enough to start GHCI from the current vim instance in a Tmux pane loaded with the current project or Haskell source, so taking advantage of the <a href="https://github.com/benmills/vimux">vimux</a> Tmux integration plugin, lets define a function:</p>
<pre class="vim"><code>function! RunGhci(type)
    call VimuxRunCommand(&quot; stack ghci &amp;&amp; exit&quot;)
    if a:type
        call VimuxSendText(&quot;:l &quot; . bufname(&quot;%&quot;))
        call VimuxSendKeys(&quot;Enter&quot;)
    endif
endfunction</code></pre>
<p>And some mappings:</p>
<pre class="vim"><code>au FileType haskell nmap &lt;silent&gt;&lt;buffer&gt; &lt;leader&gt;gg :call RunGhci(1)&lt;CR&gt;
au FileType haskell nmap &lt;silent&gt;&lt;buffer&gt; &lt;leader&gt;gs :call RunGhci(0)&lt;CR&gt;</code></pre>
<p>So doing <code>\gg</code> will start a GHCI session loaded with the current file and <code>\gs</code> will load a GHCI session for the current stack project.</p>
<h3 id="hoogle-integration">Hoogle integration</h3>
<p>Vim uses <code>K</code> (upper case k) to lookup a keyword under the cursor, so we can leverage that and just define the right <code>keywordprg</code>:</p>
<pre class="vim"><code>au FileType haskell set kp=hoogle</code></pre>
<p>Or, if you prefer having your results within Vim, you can use the [vim-hoogle](https://github.com/Twinside/vim-hoogle] plugin, and remap <code>K</code>:</p>
<pre class="vim"><code>au FileType haskell nnoremap K :HoogleInfo&lt;CR&gt;</code></pre>
<h3 id="convenient-mappings">Convenient mappings</h3>
<p>When editing a function’s arguments we would like to have a text object so doing <code>cia</code> (change inner argument) or <code>daa</code> (delete all argument) will work; These will to the trick:</p>
<pre class="vim"><code>au FileType haskell onoremap &lt;silent&gt; ia :&lt;c-u&gt;silent execute &quot;normal! ?-&gt;\r:nohlsearch\rwvf-ge&quot;&lt;CR&gt;
au FileType haskell onoremap &lt;silent&gt; aa :&lt;c-u&gt;silent execute &quot;normal! ?-&gt;\r:nohlsearch\rhvEf-ge&quot;&lt;CR&gt;</code></pre>
<p>In order to easily jump between functions we could define a function:</p>
<pre class="vim"><code>function! JumpHaskellFunction(reverse)
    call search(&#39;\C[[:alnum:]]*\s*::&#39;, a:reverse ? &#39;bW&#39; : &#39;W&#39;)
endfunction</code></pre>
<p>And some mappings, so doing <code>[[</code> or <code>]]</code> will take us to the previous or next function:</p>
<pre class="vim"><code>au FileType haskell nnoremap &lt;buffer&gt;&lt;silent&gt; ]] :call JumpHaskellFunction(0)&lt;CR&gt;
au FileType haskell nnoremap &lt;buffer&gt;&lt;silent&gt; [[ :call JumpHaskellFunction(1)&lt;CR&gt;</code></pre>
<p>Let’s add some extra convenience and use <code>gI</code> for jumping to the first <em>import</em> statement and <code>gC</code> to edit the <em>.cabal</em> file:</p>
<pre class="vim"><code>au FileType haskell nnoremap &lt;buffer&gt; gI gg /\cimport&lt;CR&gt;&lt;ESC&gt;:noh&lt;CR&gt;
au FileType haskell nnoremap &lt;buffer&gt; gC :e *.cabal&lt;CR&gt;</code></pre>
<h3 id="ghc-mod-integration">Ghc-mod integration</h3>
<p><a href="https://hackage.haskell.org/package/ghc-mod">ghc-mod</a> is the <em>Happy Haskell Programming package</em>! With a bunch of functionality, here we will be using just a few:</p>
<ul>
<li>Type inserting</li>
<li>Case splitting</li>
<li>Type asserting</li>
</ul>
<p>You need the <em>ghc-mod</em> package: <code>stack install ghc-mod</code> and the <a href="https://github.com/eagletmt/ghcmod-vim">ghcmod-vim plugin</a>.</p>
<pre class="vim"><code>au FileType haskell nnoremap &lt;silent&gt;&lt;buffer&gt; git :GhcModTypeInsert&lt;CR&gt;
au FileType haskell nnoremap &lt;silent&gt;&lt;buffer&gt; gfs :GhcModSplitFunCase&lt;CR&gt;
au FileType haskell nnoremap &lt;silent&gt;&lt;buffer&gt; gtt :GhcModType&lt;CR&gt;</code></pre>
<p><code>git</code> (<em>g insert type</em>) will insert the missing type declaration of an expression, take for instance this Haskell code:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Hello</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">f (<span class="dt">Just</span> a) <span class="fu">=</span> <span class="dt">Left</span> a</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">f <span class="dt">Nothing</span> <span class="fu">=</span> <span class="dt">Right</span> ()</a></code></pre></div>
<p>With the cursor in the first <code>f</code> (the function name) using the <code>tt</code> mapping will produce:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Hello</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="ot">f ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Either</span> a ()</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">f (<span class="dt">Just</span> a) <span class="fu">=</span> <span class="dt">Left</span> a</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">f <span class="dt">Nothing</span> <span class="fu">=</span> <span class="dt">Right</span> ()</a></code></pre></div>
<p><img src="/img/vimhask/shot2.gif" class="img-responsive" /></p>
<p>Neat!, go ahead and play around with the other mappings, you’ll be not disappointed.</p>
<h3 id="hlint-integration">Hlint integration</h3>
<p>By default, <a href="https://github.com/neomake/neomake">Neomake</a> will use <em>hlint</em> on the current file when the <code>:Neomake</code> command is invoked on a Haskell source file, so by adding a mapping:</p>
<pre class="vim"><code>au FileType haskell nnoremap &lt;buffer&gt; gll :Neomake&lt;CR&gt;</code></pre>
<p><code>gll</code> will open the location list with the lints, which takes us to some convenience mappings:</p>
<pre class="vim"><code>au FileType haskell nnoremap &lt;buffer&gt;&lt;silent&gt; gl&lt;space&gt; :call ToggleLocationList()&lt;CR&gt;
au FileType haskell nnoremap &lt;buffer&gt;&lt;silent&gt; glc :sign unplace *&lt;CR&gt;</code></pre>
<p>So now is possible to toggle the location list with <code>gl&lt;space&gt;</code> and clear it with <code>glc</code>.</p>
<p>You will need the Stack tool of course, and <em>hlint</em> that you can install with <code>stack install hlint</code>.</p>
<h3 id="code-formatting-and-beautifying">Code formatting and beautifying</h3>
<p><em>Hindent</em> allows beautifying Haskell code, you could use it by setting the <code>formatprg</code> option and then trigger it with the <code>=</code> command, but there is a problem: if your code happens to have any syntax errors, it will be replaced with a nasty error message. To handle this we’re going to use the <a href="https://github.com/alx741/vim-hindent">vim-hindent</a> plugin instead, so each time we save a Haskell source file it will be automatically beatified.</p>
<p>Don’t forget to configure it:</p>
<pre class="vim"><code>let g:hindent_on_save = 1
let g:hindent_line_length = 80
let g:hindent_indent_size = 4</code></pre>
<p>One extra thing left is to align stuff in the code so it looks nicer</p>
<pre class="vim"><code>au FileType haskell nmap &lt;silent&gt;&lt;buffer&gt; g&lt;space&gt; vii&lt;ESC&gt;:silent!&#39;&lt;,&#39;&gt; EasyAlign /-&gt;/&lt;CR&gt;</code></pre>
<p>Take for instance this very dumb example for the sake of the argument:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Test</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="ot">f ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4">f x <span class="fu">=</span> <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5">    <span class="dv">1</span>   <span class="ot">-&gt;</span> <span class="st">&quot;1&quot;</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">    <span class="dv">2</span> <span class="ot">-&gt;</span>   <span class="st">&quot;2&quot;</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7">    <span class="dv">3</span> <span class="ot">-&gt;</span> <span class="st">&quot;3&quot;</span></a></code></pre></div>
<p>Using <code>g&lt;space&gt;</code> we got:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Test</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="ot">f ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb21-4" data-line-number="4">f x <span class="fu">=</span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5">  <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6">    <span class="dv">1</span> <span class="ot">-&gt;</span> <span class="st">&quot;1&quot;</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7">    <span class="dv">2</span> <span class="ot">-&gt;</span> <span class="st">&quot;2&quot;</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8">    <span class="dv">3</span> <span class="ot">-&gt;</span> <span class="st">&quot;3&quot;</span></a></code></pre></div>
<p><img src="/img/vimhask/shot3.gif" class="img-responsive" /></p>
<p>So much better!</p>
<h3 id="easy-arrows-generation">Easy arrows generation</h3>
<p>In Haskell, operators like <code>-&gt;</code> and <code>=&gt;</code> are very common and I find it cumbersome to type them manually. Let’s define a function:</p>
<pre class="vim"><code>function! Make_arrow(type)
    if a:type
        if (matchstr(getline(&#39;.&#39;), &#39;\%&#39; . col(&#39;.&#39;) . &#39;c.&#39;) ==? &#39; &#39;)
            exe &quot;norm! a-&gt;  &quot;
        else
            exe &quot;norm! a -&gt;  &quot;
        endif
        exe &quot;startreplace&quot;
    else
        if (matchstr(getline(&#39;.&#39;), &#39;\%&#39; . col(&#39;.&#39;) . &#39;c.&#39;) ==? &#39; &#39;)
            exe &quot;norm! a=&gt;  &quot;
        else
            exe &quot;norm! a =&gt;  &quot;
        endif
        exe &quot;startreplace&quot;
    endif
endfunction</code></pre>
<p>And some insert mode mappings:</p>
<pre class="vim"><code>au FileType haskell inoremap &lt;buffer&gt; ;; &lt;ESC&gt;:call Make_arrow(1)&lt;CR&gt;
au FileType haskell inoremap &lt;buffer&gt; ;: &lt;ESC&gt;:call Make_arrow(0)&lt;CR&gt;</code></pre>
<p>So while in insert mode typing <code>;;</code> or <code>;:</code> will insert <code>-&gt;</code> or <code>=&gt;</code> respectively. Additionally, it will avoid duplicated spaces between the types and the arrows.</p>
<h3 id="types-abbreviations">Types abbreviations</h3>
<p>Maybe I’m a terrible typist, but writing the first upper case letter of the most common types hurts my pinkie. So by using some insert mode abbreviations:</p>
<pre class="vim"><code>au FileType haskell inoreab &lt;buffer&gt; int Int
au FileType haskell inoreab &lt;buffer&gt; integer Integer
au FileType haskell inoreab &lt;buffer&gt; string String
au FileType haskell inoreab &lt;buffer&gt; double Double
au FileType haskell inoreab &lt;buffer&gt; float Float
au FileType haskell inoreab &lt;buffer&gt; true True
au FileType haskell inoreab &lt;buffer&gt; false False
au FileType haskell inoreab &lt;buffer&gt; maybe Maybe
au FileType haskell inoreab &lt;buffer&gt; just Just
au FileType haskell inoreab &lt;buffer&gt; nothing Nothing
au FileType haskell inoreab &lt;buffer&gt; io IO ()</code></pre>
<p>Now I can type all lower case without having to bother with the <em>shift</em> key and the capitalized version will be inserted instead.</p>
<h3 id="yesod-haskell-web-framework">Yesod Haskell web framework</h3>
<p>Some neat integration with Yesod can be achieved by using the <a href="https://github.com/alx741/vim-yesod">vim-yesod</a> plugin which, by default, gives you some mappings:</p>
<p><code>gh</code> - Jump to the handler of the route under the cursor in the <code>config/routes</code> file.</p>
<p><code>gH</code> - Create a new handler for the route under the cursor in the <code>config/routes</code> file.</p>
<p><code>gm</code> - Jump to or create the i18n message under the cursor in a template file.</p>
<p><em>vim-yesod</em> gives you <code>config/routes</code>, <code>config/models</code> and i18n <code>messages/</code> syntax highlighting, but it doesn’t support shakesperean templates syntax so be sure to install the <a href="https://github.com/pbrisbin/vim-syntax-shakespeare">vim-syntax-shakespeare</a> as well.</p>]]></summary>
</entry>
<entry>
    <title>PIC16F876A conversión analógica digital + UART (Ensamblador)</title>
    <link href="http://www.sillybytes.net/2016/07/pic16f876a-conversion-analogica-digital.html" />
    <id>http://www.sillybytes.net/2016/07/pic16f876a-conversion-analogica-digital.html</id>
    <published>2016-07-14T00:00:00Z</published>
    <updated>2016-07-14T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/picuart/thumbnail.png" id="thumbnail" /><br />
</p>
<p>NOTE: This post is available in Spanish only. Please use a software translator.</p>
<p>He dejado de usar microcontroladores PIC por los motivos explicados <a href="http://www.sillybytes.net/2016/06/from-pic-to-avr.html">aquí</a>; Pero voy a dedicar este post para escribir y explicar un programa sencillo escrito en ensamblador para el <strong>PIC16F876A</strong>.</p>
<p>El objetivo es el siguiente:</p>
<p>Se desea usar el microcontrolador para llevar a cabo la conversión analógica-digital de una tensión variable (un LDR o un potenciómetro por ejemplo) y transmitir el resultado usando la UART. Además debe ser posible recibir por la UART un byte que debe alterar la configuración del Conversor Análogo Digital (DAC) interno del microcontrolador para, por ejemplo, cambiar el canal de entrada de la señal analógica o modificar la velocidad del reloj de conversión.</p>
<!--more-->
<p>El código ha sido ensamblado con el ensamblador de GNU <em>gpasm</em> del juego de herramientas <a href="http://gputils.sourceforge.net/">gputils</a>, pero debería ser perfectamente compatible con las herramientas MPLAB de Microchip que no uso porque <a href="http://silly-bytes.blogspot.com/2016/03/why-do-i-hate-ides.html">odio los IDEs</a>. En cualquier caso la explicación y el 99% del código debería ser útil sin modificación alguna.</p>
<p>Este post se deberá leer en paralelo junto con el <em>datasheet</em> del microcontrolador en cuestión <strong>PIC16F876A</strong> que se puede encontrar aquí: http://ww1.microchip.com/downloads/en/DeviceDoc/39582C.pdf</p>
<p>Además tener en cuenta los pines del microcontrolador:</p>
<p><img src="/img/picuart/scheme.jpg" class="img-responsive" /></p>
<p>El código completo <a href="https://github.com/Silly-Bytes/pic_asm_uart-adc/blob/master/code.asm">se encuentra aquí</a>.</p>
<h2 id="declaración-de-registros-y-variables">Declaración de registros y variables</h2>
<p>Empezamos examinando y explicando el código:</p>
<pre><code>list p=16f876A</code></pre>
<p>La primera linea le dirá al ensamblador los mapas de memoria que el enlazador deberá usar (el microcontrolador que estamos usando).</p>
<pre><code>; Declaración de direcciones de memoria
; Datasheet pagina 17, figura 2-3
PORTA      EQU 0x05
PORTB      EQU 0x06
TRISA      EQU H&#39;85&#39;
TRISB      EQU H&#39;86&#39;
TRISC      EQU H&#39;87&#39;
RP0        EQU H&#39;05&#39;
RP1        EQU H&#39;06&#39;
STATUS     EQU H&#39;03&#39;
DATO       EQU H&#39;21&#39;
ADCON0     EQU H&#39;1F&#39;
ADCON1     EQU H&#39;9F&#39;
PIR1       EQU H&#39;0C&#39;
INTCON     EQU H&#39;0B&#39;
PIE1       EQU H&#39;8C&#39;
ADRESH     EQU H&#39;1E&#39;
ADRESL     EQU H&#39;9E&#39;
SPBRG      EQU H&#39;99&#39;
TXSTA      EQU H&#39;98&#39;
RCSTA      EQU H&#39;18&#39;
TXREG      EQU H&#39;19&#39;
RCREG      EQU H&#39;1A&#39;
OPTION_REG EQU H&#39;81&#39;
IRP        EQU H&#39;07&#39;</code></pre>
<p>En el Datasheet, pagina 17, figura 2-3 se puede ver el mapa completo de memoria del microcontrolador. En estas lineas declaramos los nombres y direcciones (en hexadecimal) de los mismos para usarlos en el código con más facilidad. La palabra <code>EQU</code> asigna el nombre de la izquierda al valor de la derecha. Para declarar un valor hexadecimal se usa el prefijo <code>0x</code>.</p>
<h2 id="inicialización-y-configuración">Inicialización y configuración</h2>
<pre><code>INIT
    org 0

    ; Selección BANCO 1
    ; Datasheet pagina 16, sección 2.2
    BSF STATUS,RP0
    BCF STATUS,RP1</code></pre>
<p>La palabra <code>INIT</code> es la declaración de una <em>etiqueta</em> y se puede cambiar por cualquier palabra que se desee, es el nombre con el cual nos vamos a referir a esta sección de código desde otras partes del programa y que podremos invocar usando dicha etiqueta.</p>
<p>La directiva <code>org 0</code> indica al enlazador que el código a continuación deberá ser colocado desde la dirección <strong>0</strong> de la memoria de programa.</p>
<p>Las instrucciones <code>BSF STATUS,RP0</code> y <code>BCF STATUS,RP1</code> hacen un cambio al <strong>banco de memoria 1</strong>. La memoria del microcontrolador está dividida en <strong>bancos</strong> y es necesario <em>cambiarnos</em> al banco donde reside el registro que queremos modificar en cada momento.</p>
<h3 id="configuración-de-los-puertos-de-entradasalida">Configuración de los puertos de entrada/salida</h3>
<pre><code>;;; Configuración de puertos IO
;;; Datasheet pagina 41
; El puerto A es de entrada
MOVLW   B&#39;00111111&#39;
MOVWF   TRISA
; El puerto B es de salida
MOVLW   B&#39;00000000&#39;
MOVWF   TRISB
; Puerto C: pin TX es salida, pin RX es entrada
MOVLW   B&#39;10001111&#39;
MOVWF   TRISC</code></pre>
<p>La instrucción <code>MOVLW</code> se usa para mover un valor <strong>literal</strong> al registro de trabajo <strong>W</strong>.</p>
<p>La instrucción <code>MOVWF</code> se usa para mover el valor que se encuentra en el registro de trabajo <strong>W</strong> a un registro.</p>
<p>De esta forma para colocar un valor arbitrario en un registro es necesario colocarlo primero en el registro de trabajo <strong>W</strong> usando la instrucción <code>MOVLW</code> y luego moverlo al registro deseado con la instrucción <code>MOVWF</code>.</p>
<p>Para indicar que el valor usado es <strong>binario</strong> se usa como prefijo una <strong>B</strong>.</p>
<p>El <strong>puerto A</strong> contiene los pines del conversor ADC por lo que se configuran como entradas. El <strong>puerto B</strong> se configura como salida para, opcionalmente, colocar LEDs que sirvan como indicadores visuales. El <strong>puerto C</strong> contiene los pines <strong>TX</strong> y <strong>RX</strong> usados para la comunicación UART con lo cual se configuran para salida y entrada respectivamente.</p>
<h3 id="configuración-del-conversor-adc">Configuración del conversor ADC</h3>
<pre><code>;;; Configuración de puerto ADC
; Todas las entradas son analógicas
; Datasheet pagina 128
MOVLW   B&#39;10000000&#39;
MOVWF   ADCON1</code></pre>
<p>La configuración del conversor ADC será recibida usando la comunicación UART, sin embargo es necesario configurar de antemano que pines serán analógicos y que pines serán digitales. No usaremos pines digitales en este puerto, así que se configuran todos como analógicos según la tabla de la pagina 128 del Datasheet.</p>
<h3 id="configuración-de-la-uart">Configuración de la UART</h3>
<p>La comunicación serial UART puede usarse para comunicar el microcontrolador con una computadora u otro dispositivo como un modulo bluetooth que a su vez se puede usar para comunicar con un teléfono inteligente. El dispositivo con el que se comunique es irrelevante para este post y el código es el mismo en cualquier caso.</p>
<p>Nótese que los registros que se configuran se encuentran en bancos distintos con lo cual es necesario hacer el <em>cambio de banco</em> en cada paso.</p>
<pre><code>;;; Configuración UART
; Banco 1
BSF STATUS,RP0
BCF STATUS,RP1
; 19200 Baudios
; Datasheet pagina 114, tabla 10-4
MOVLW   .12
MOVWF   SPBRG</code></pre>
<p>El registro <code>SPBRG</code> o “Generador de baudios” recibe un valor (listado en la tabla) dependiendo de la velocidad a la cual nos queremos comunicar, de la frecuencia a la que se use el microcontrolador y el porcentaje de error que estamos dispuestos a tolerar en la comunicación. Dada la frecuencia de un reloj de 4Mhz usado y la necesidad de una comunicación a 19200 Baudios, la tabla indica usar un valor <strong>decimal</strong> de <code>12</code>. Para indicar que el valor usado es <strong>decimal</strong> se usa como prefijo un punto <code>.</code>.</p>
<pre><code>; Registro de transmisión
MOVLW   B&#39;10100100&#39;
MOVWF   TXSTA</code></pre>
<p>El registro <code>TXSTA</code> de la pagina 111 se configura con los valores adecuados para configurar una comunicación de 8 bits de alta velocidad, asíncrona y para activar los mecanismos de transmisión.</p>
<pre><code>; Banco 0
BCF STATUS,RP0
BCF STATUS,RP1
; Registro de recepción
MOVLW   B&#39;10010000&#39;
MOVWF   RCSTA
BSF RCSTA,4</code></pre>
<p>El registro <code>RCSTA</code> (en el banco 0) de la pagina 112 se configura para una comunicación de 8 bits, asíncrona y se activan los mecanismos de recepción.</p>
<h2 id="programa-principal">Programa principal</h2>
<p>El programa principal deberá esperar a que un byte para configurar el conversor ADC llegue por la UART, tomar un valor de tensión y llevar a cabo la conversión para finalmente transmitir el resultado por la UART enviando primero el byte bajo <code>ADRESL</code> y luego el byte alto <code>ADRESH</code>.</p>
<h3 id="configuración">Configuración</h3>
<pre><code>;;; Esperar primer byte de configuración
ESPERAR_CONFIG
    BTFSS   PIR1,5
    GOTO    ESPERAR_CONFIG</code></pre>
<p>El pin numero <code>5</code> del registro <code>PIR1</code> indicará que un dato ha llegado por la UART.</p>
<p>La instrucción <code>BTFSS</code> verificará el bit numero <code>5</code> del registro <code>PIR1</code> y se <strong>saltará</strong> la siguiente instrucción si el bit es igual a <code>1</code>. De esta forma mientras no llegue el dato necesario la instrucción <code>GOTO</code> se ejecuta y el microcontrolador se queda en un bucle, pero cuando un dato es recibido la instrucción <code>GOTO</code> es <strong>saltada</strong> y el programa puede continuar.</p>
<pre><code>    ; Colocar byte recibido en la configuración ADCON0 del conversor ADC
    BCF   STATUS,RP0
    BCF   STATUS,RP1
    MOVF  RCREG,W
    MOVWF ADCON0
    ; Vaciar el bit de recepción
    BCF   PIR1,6</code></pre>
<p>El registro <code>RCREG</code> contiene el dato recibido por la UART, el cual se coloca en el registro de trabajo <code>W</code> para luego colocarlo en el registro de configuración <code>ADCON0</code> del conversor ADC. Así el conversor quedará configurado con el canal y velocidad que se haya indicado en el dato que recibió y se puede proceder a la conversión. Usando la instrucción <code>BCF</code> se vacía el contenido del bit numero <code>6</code> del registro <code>PIR1</code> para indicar que hemos leído el dato recibido.</p>
<h3 id="conversión">Conversión</h3>
<pre><code>;;; Esperar tiempo de adquisición e iniciar conversión
CONVERTIR
    ; Instrucciones de espera
    NOP
    NOP
    NOP
    NOP
    NOP</code></pre>
<p>Antes de realizar la conversión es necesario esperar un tiempo para que el microcontrolador pueda recoger el valor de tensión en el pin, según la pagina 129 del Datasheet. Se puede lograr esto usando la instrucción <code>NOP</code>, aunque sería más adecuado usar un bucle que espere un tiempo más prudente, pero se mantiene de esta forma por simplicidad.</p>
<pre><code>    ; Activar conversor
    BSF ADCON0,2</code></pre>
<p>Activando el bit numero <code>2</code> del registro <code>ADCON0</code> usando la instrucción <code>BSF</code> inicia la conversión.</p>
<pre><code>ESPERAR_CONVERSION
    BTFSS   PIR1,6
    GOTO    ESPERAR_CONVERSION
    BCF PIR1,6</code></pre>
<p>La conversión toma tiempo, por lo que se entra en un bucle hasta que el bit numero 6 del registro <code>PIR1</code> indique que se ha finalizado.</p>
<h3 id="transmitir-el-resultado">Transmitir el resultado</h3>
<pre><code>; Transmitir el resultado mediante la UART
TRANSMITIR_RESULTADO
    BSF STATUS,RP0
    BCF STATUS,RP1
    ; Transmitir byte bajo del resultado (ADRESL)
    MOVF    ADRESL,W
    BCF STATUS,RP0
    BCF STATUS,RP1
    MOVWF   TXREG
    BSF STATUS,RP0
    BCF STATUS,RP1</code></pre>
<p>El resultado de la conversión se encuetra repartido en dos bytes: <code>ADRESL</code> y <code>ADRESH</code>.</p>
<p>Colocamos el byte <code>ADRESL</code> en el registro de trabajo <code>W</code> para luego colocarlo en el registro <code>TXREG</code> lo cual causará que sea transmitido usando al UART.</p>
<pre><code>; Esperar que el primer byte se transmita
ESPERAR_1
    BTFSS   TXSTA,1
    GOTO    ESPERAR_1
    BCF STATUS,RP0
    BCF STATUS,RP1
    ; Transmitir byte alto del resultado (ADRESH)
    MOVF    ADRESH,W
    MOVWF   TXREG
    BSF STATUS,RP0
    BCF STATUS,RP1

; Esperar que el segundo byte se transmita
ESPERAR_2
    BTFSS   TXSTA,1
    GOTO    ESPERAR_2
    BCF TXSTA,1</code></pre>
<p>El bit numero <code>1</code> del registro <code>TXSTA</code> indica que el dato se ha transmitido.</p>
<p>Esperamos en un bucle hasta que el byte bajo termine de ser transmitido y podemos repetirlo para el byte alto.</p>
<pre><code>GOTO    CONVERTIR

END</code></pre>
<p>Finalmente se salta a la etiqueta <code>CONVERTIR</code> para convertir y transmitir datos infinitamente. El programa se termina con la directiva <code>END</code>.</p>]]></summary>
</entry>
<entry>
    <title>Ratpoison, Fuzzy window selection</title>
    <link href="http://www.sillybytes.net/2016/07/ratpoison-fuzzy-window-selection.html" />
    <id>http://www.sillybytes.net/2016/07/ratpoison-fuzzy-window-selection.html</id>
    <published>2016-07-13T00:00:00Z</published>
    <updated>2016-07-13T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/ratfuzzy/thumbnail.png" id="thumbnail" /><br />
</p>
<p>A nice feature to have is the ability to jump to an arbitrary window by performing a quick fuzzy search with just a few characters. We can achieve this by using Ratpoison’s flexibility and the fantastic <a href="https://github.com/junegunn/fzf">FZF tool</a>.</p>
<p>The <a href="https://github.com/alx741/dotfiles/blob/master/scripts/.scripts/ratpoison/window_select.sh">window_select.sh</a> script will do the trick using <strong>FZF</strong> <!--more--><br />
<br />
<br />
</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">function</span><span class="fu"> fzf_select</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">{</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="va">pattern=$(</span><span class="ex">ratpoison</span> -c <span class="st">&quot;prompt &gt; &quot;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$pattern</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;&quot;</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">        <span class="bu">exit</span> 0</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="va">window_list=$(</span><span class="ex">ratpoison</span> -c <span class="st">&quot;windows %c&quot;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="va">selected=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$window_list</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="ex">fzf</span> -q <span class="st">&quot;</span><span class="va">$pattern</span><span class="st">&quot;</span> -1 -0<span class="va">)</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$selected</span><span class="st">&quot;</span> <span class="ot">!=</span> <span class="st">&quot;&quot;</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">        <span class="ex">ratpoison</span> -c <span class="st">&quot;select </span><span class="va">$selected</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">        <span class="ex">ratpoison</span> -c <span class="st">&quot;echo [!] There is no a matching window for </span><span class="dt">\&quot;</span><span class="va">$pattern</span><span class="dt">\&quot;</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="kw">}</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="kw">case</span> <span class="va">$1</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">    <span class="st">&#39;ratmen&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">        <span class="ex">ratmen_select</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25">    <span class="st">&#39;fzf&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26">        <span class="ex">fzf_select</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="kw">esac</span></a></code></pre></div>
<p>This will use Ratpoison to prompt for a fuzzy string and will take you immediately to the matched window.</p>
<p>But in order to invoke this, a Ratpoison mapping is required:</p>
<pre><code>bind w exec window_select.sh fzf</code></pre>]]></summary>
</entry>
<entry>
    <title>Aprende Haskell rápido y difícil</title>
    <link href="http://www.sillybytes.net/2016/06/aprende-haskell-rapido-y-dificil_29.html" />
    <id>http://www.sillybytes.net/2016/06/aprende-haskell-rapido-y-dificil_29.html</id>
    <published>2016-06-29T00:00:00Z</published>
    <updated>2016-06-29T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/haskellhard/thumbnail.jpg" id="thumbnail" /><br />
</p>
<p>Esta es la traducción al español del artículo <a href="http://yannesposito.com/Scratch/en/blog/Haskell-the-Hard-Way/">Haskell the hard way</a> por Yann Esposito.</p>
<p>TL;DR*: Un corto y denso tutorial para aprender Haskell.</p>
<h1 id="asómbrate-con-haskell">Asómbrate con Haskell</h1>
<p>De verdad pienso que todos los desarrolladores deberían aprender Haskell. No creo que todos necesitan convertirse en ninjas de Haskell, pero deberían al menos descubrir que es lo que Haskell tiene para ofrecer. Aprender Haskell abre tu mente. <!--more--></p>
<p>Los lenguajes comunes comparten los mismos fundamentos:</p>
<ul>
<li>variables</li>
<li>loops</li>
<li>punteros[^1]</li>
<li>estructuras de datos, objetos y clases</li>
</ul>
<p>Haskell es muy diferente. El lenguaje usa muchos conceptos que nunca he escuchado antes. Muchos de esos conceptos te ayudarán a convertirte en un mejor programador.</p>
<p>Pero aprender Haskell puede ser difícil. Lo fue para mi. En este artículo intentaré proveer lo que me faltó durante mi aprendizaje.</p>
<p>Este artículo será ciertamente difícil de seguir. Esto es intencional. No hay atajo alguno para aprender Haskell. Es difícil y retador. Pero creo que es algo bueno. Debido a que es difícil es que Haskell es interesante.</p>
<p>El método convencional de aprender Haskell es leer dos libros. Primero <a href="http://learnyouahaskell.com/">“Learn You a Haskell”</a> y justo después <a href="http://www.realworldhaskell.org/">“Real World Haskell”</a>. También pienso que esta es la forma correcta. Pero aprender de que se trata Haskell, deberás leerlos en detalle.</p>
<p>En contraste, este artículo es un resumen muy breve y denso de los principales aspectos de Haskell. También he agregado información que a mi me faltó mientras aprendía Haskell.</p>
<p>El artículo contiene cinco partes:</p>
<ul>
<li>Introducción: un corto ejemplo para mostrar que Haskell puede ser amigable.</li>
<li>Haskell básico: sintaxis de Haskell, y algunas nociones esenciales.</li>
<li>Parte muy difícil:
<ul>
<li>Estilo funcional; un ejemplo progresivo, desde estilo imperativo al</li>
<li>funcional</li>
<li>Tipos; tipos y el ejemplo estándar del árbol binario</li>
<li>Estructuras infinitas; manipulando un árbol binario infinito!</li>
</ul></li>
<li>Parte infernalmente difícil:
<ul>
<li>Lidiar con IO; un ejemplo reducido</li>
<li>El truco de IO explicado; el detalle ocultó que yo no tuve para entender IO</li>
<li>Monads; increíble como podemos generalizar</li>
</ul></li>
<li>Apéndice:
<ul>
<li>Más sobre arboles infinitos; una discusión más matemática sobre arboles</li>
<li>infinitos</li>
</ul>
Nota: El código de ejemplo se almacena en ficheros con un nombre específico que termina en la extensión <code>.hs</code> (Haskell), y por eso en los ejemplos se escribre la ejecución de los mismos como <code>$ runhaskell   algo.hs</code> pero el nombre puede ser cualquiera.</li>
</ul>
<h1 id="introducción">Introducción</h1>
<h2 id="instalación">Instalación</h2>
<p><img src="/img/haskellhard/shot1.jpg" class="img-responsive" /><br />
</p>
<ul>
<li><a href="https://www.haskell.org/platform/">La plataforma de Haskell</a> es la forma estándar de instalar Haskell.</li>
</ul>
<p>Herramientas:</p>
<p><code>ghc</code>: Compilador similar a <em>gcc</em> para <code>C</code>. <code>ghci</code>: Haskell interactivo (REPL) <code>runhaskell</code>: Ejecutar un programa sin compilarlo. Conveniente pero muy lento comparado a programas compilados</p>
<h2 id="no-tengas-miedo">No tengas miedo</h2>
<p><img src="/img/haskellhard/shot2.jpg" class="img-responsive" /><br />
</p>
<p>Muchos libros/artículos sobre Haskell empiezan por introducir alguna formula esotérica (quick sort, Fibonacci, etc…). Yo lo haré justamente al revés. Al principio no mostraré ningún super poder de Haskell. Empezaré por las similaridades entre Haskell y otros lenguajes de programación. Saltemos al “Hola Mundo” obligatorio.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1">main <span class="fu">=</span> putStrLn <span class="st">&quot;Hola Mundo!&quot;</span></a></code></pre></div>
<p>Para ejecutarlo, puedes guardar el código en un fichero <code>hola.hs</code> y:</p>
<pre><code>$ runhaskell ./hola.hs
Hola Mundo!</code></pre>
<p>Ahora, un programa que pregunte tu nombre y responda “Hola” usando el nombre ingresado:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    print <span class="st">&quot;Cuál es tu nombre?&quot;</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    name <span class="ot">&lt;-</span> getLine</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    print (<span class="st">&quot;Hola &quot;</span> <span class="fu">++</span> name <span class="fu">++</span> <span class="st">&quot;!&quot;</span>)</a></code></pre></div>
<p>Primero, comparemos esto con programas similares en algunos lenguajes imperativos:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Python</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="bu">print</span> <span class="st">&quot;What is your name?&quot;</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">name <span class="op">=</span> <span class="bu">raw_input</span>()</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="bu">print</span> <span class="st">&quot;Hello </span><span class="sc">%s</span><span class="st">!&quot;</span> <span class="op">%</span> name</a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Ruby</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">puts <span class="st">&quot;What is your name?&quot;</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">name = gets.chomp</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">puts <span class="st">&quot;Hello </span><span class="ot">#{</span>name<span class="ot">}</span><span class="st">!&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">// In C</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="dt">int</span> main (<span class="dt">int</span> argc, <span class="dt">char</span> **argv) {</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="dt">char</span> name[<span class="dv">666</span>]; <span class="co">// &lt;- An Evil Number!</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    <span class="co">// What if my name is more than 665 character long?</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    printf(<span class="st">&quot;What is your name?</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    scanf(<span class="st">&quot;%s&quot;</span>, name);</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    printf(<span class="st">&quot;Hello %s!</span><span class="sc">\n</span><span class="st">&quot;</span>, name);</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">}</a></code></pre></div>
<p>La estructura es la misma, pero hay diferencias en la sintaxis. La parte principal de este tutorial será dedicada a explicar por qué.</p>
<p>En Haskell hay una función <code>main</code> y todo elemento tiene un tipo. El tipo de <code>main</code> es <code>IO ()</code>. Esto significa que <code>main</code> causará efectos secundarios.</p>
<p>Solamente recuerda que Haskell puede lucir mucho como los lenguajes imperativos populares.</p>
<h2 id="haskell-básico">Haskell básico</h2>
<p><img src="/img/haskellhard/shot3.jpg" class="img-responsive" /><br />
</p>
<p>Antes de continuar debes ser advertido sobre algunas propiedades esenciales de Haskell.</p>
<p><strong>Funcional</strong></p>
<p>Haskell es un lenguaje funcional. Si tienes experiencia con lenguajes imperativos, deberás aprender muchas cosas nuevas. Con suerte muchos de estos nuevos conceptos te ayudarán a programas incluso en lenguajes imperativos.</p>
<p><strong>Tipado estático inteligente</strong></p>
<p>En lugar de meterse en tu camino como en <code>C</code>, <code>C++</code> o <code>Java</code>, el sistema de tipos está aquí para ayudarte.</p>
<p><strong>Pureza</strong></p>
<p>Generalmente tus funciones no modificarán nada en el mundo exterior. Esto significa que no pueden modificar el valor de una variable, no pueden obtener entrada del usuario, no pueden escribir en la pantalla, no pueden lanzar un misil. Por otro lado, el paralelismo será muy fácil de lograr. Haskell hace deja claro donde los efectos secundarios pueden ocurrir y donde el código es puro. También, será mucho más fácil razonar sobre el programa. La mayoría de los errores serán prevenidos en las partes puras del programa.</p>
<p>Además, las funciones puras siguen una ley fundamental en Haskell:</p>
<pre><code>Aplicar una funcion con los mismos parámetros siempre producirá los
mismos valores.</code></pre>
<p><strong>Perezoso (laziness)</strong></p>
<p>Laziness por defecto es un diseño de lenguaje muy poco común. Por defecto, Haskell evalúa algo solamente cuando lo necesita. En consecuencia, provee una forma muy elegante de manipular estructuras infinitas, por ejemplo.</p>
<p>Una ultima advertencia sobre como deberías leer código Haskell. Para mi, es como leer artículos científicos. Algunas partes son muy claras, pero cuando vez una formula, enfócate y lee más despacio. También, mientras se lee código Haskell, en realidad no importa mucho si no se comprenden los detalles de la sintaxis. Si encuentras algo como <code>&gt;&gt;=</code>, <code>&lt;$&gt;</code>, <code>&lt;-</code> o cualquier símbolo extraño, solamente ignóralos y continua el flujo del código.</p>
<h3 id="declaración-de-funciones">Declaración de funciones</h3>
<p>Seguramente estarás acostumbrado a funciones como:</p>
<p>En <code>C</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="dt">int</span> f(<span class="dt">int</span> x, <span class="dt">int</span> y) {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">    <span class="cf">return</span> x*x + y*y;</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">}</a></code></pre></div>
<p>En <code>JavaScript</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">function</span> <span class="at">f</span>(x<span class="op">,</span>y) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">    <span class="cf">return</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y<span class="op">;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="op">}</span></a></code></pre></div>
<p>En Python:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">def</span> f(x,y):</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="cf">return</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y</a></code></pre></div>
<p>En Ruby:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">def</span> f(x,y)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">    x*x + y*y</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">end</span></a></code></pre></div>
<p>En Scheme:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode scheme"><code class="sourceCode scheme"><a class="sourceLine" id="cb12-1" data-line-number="1">(<span class="kw">define</span><span class="fu"> </span>(f x y)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    (<span class="kw">+</span> (* x x) (* y y)))</a></code></pre></div>
<p>Finalmente, en Haskell es:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1">f x y <span class="fu">=</span> x<span class="fu">*</span>x <span class="fu">+</span> y<span class="fu">*</span>y</a></code></pre></div>
<p>Muy limpio. No paréntesis, no <code>def.</code></p>
<p>No olvides, Haskell usa funciones y tipos un montón. Por lo que es muy fácil definirlos. La sintaxis fuer particularmente pensada para estos elementos.</p>
<h3 id="un-ejemplo-de-tipo">Un ejemplo de tipo</h3>
<p>Aunque no es obligatorio, la información sobre los tipos para las funciones usualmente se hace explicita. No es obligatorio por que el compilador es lo bastante inteligente para descubrirlo por ti. Es una buena idea hacerlo de todas formas por que indica la intensión y facilita la comprensión.</p>
<p>Juguemos un poco. Declaramos el tipo usando <code>::</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="ot">f ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">f x y <span class="fu">=</span> x<span class="fu">*</span>x <span class="fu">+</span> y<span class="fu">*</span>y</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">main <span class="fu">=</span> print (f <span class="dv">2</span> <span class="dv">3</span>)</a></code></pre></div>
<pre><code>$ runhaskell 20_very_basic.lhs
13</code></pre>
<p>Ahora intenta</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="ot">f ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">f x y <span class="fu">=</span> x<span class="fu">*</span>x <span class="fu">+</span> y<span class="fu">*</span>y</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">main <span class="fu">=</span> print (f <span class="fl">2.3</span> <span class="fl">4.2</span>)</a></code></pre></div>
<p>Deberías obtener este error:</p>
<pre><code>21_very_basic.lhs:6:23:
    No instance for (Fractional Int)
    arising from the literal `4.2&#39;
    Possible fix: add an instance declaration for (Fractional Int)
    In the second argument of `f&#39;, namely `4.2&#39;
    In the first argument of `print&#39;, namely `(f 2.3 4.2)&#39;
    In the expression: print (f 2.3 4.2)</code></pre>
<p>El problema: 4.2 no es un <code>Int</code>.</p>
<p>La solución: No declarar un tipo para <code>f</code> por el momento y dejar a Haskell inferir el tipo más general por nosotros:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" data-line-number="1">f x y <span class="fu">=</span> x<span class="fu">*</span>x <span class="fu">+</span> y<span class="fu">*</span>y</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">main <span class="fu">=</span> print (f <span class="fl">2.3</span> <span class="fl">4.2</span>)</a></code></pre></div>
<p>Funciona! Afortunadamente, no tenemos que declarar una nueva función para cada tipo. Por ejemplo, in <code>C</code>, deberíamos declarar una función para <code>int</code>, para <code>float</code> para <code>long</code>, para <code>double</code>, etc…</p>
<p>Pero, que tipo deberíamos declarar? Para descubrir el tipo que Haskell a usado por nosotros ejecutaremos <strong>ghci</strong>:</p>
<pre><code>% ghci

GHCi, version 7.0.4: http://www.haskell.org/ghc/  :? for help
Loading package ghc-prim ... linking ... done.
Loading package integer-gmp ... linking ... done.
Loading package base ... linking ... done.
Loading package ffi-1.0 ... linking ... done.
Prelude&gt;</code></pre>
<p>Y escribimos:</p>
<pre><code>let f x y = x*x + y*y
Prelude&gt;
:type f
f :: Num a =&gt; a -&gt; a -&gt; a</code></pre>
<p>Uh? Que es ese tipo extraño?</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>Primero, enfoquémonos en la parte de la derecha <code>a -&gt; a -&gt; a</code>. Para comprenderlo, solo mira una lista de ejemplos progresivos:</p>
<table>
<thead>
<tr class="header">
<th>El tipo</th>
<th>Su significado</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Int</td>
<td>El tipo Int</td>
</tr>
<tr class="even">
<td>Int -&gt; Int</td>
<td>El tipo de función de Int a Int</td>
</tr>
<tr class="odd">
<td>Float -&gt; Int</td>
<td>El tipo de función de Float a Int</td>
</tr>
<tr class="even">
<td>a -&gt; Int</td>
<td>El tipo de función de cualquier tipo a Int</td>
</tr>
<tr class="odd">
<td>a -&gt; a</td>
<td>El tipo de función de cualquier tipo al mismo tipo a</td>
</tr>
<tr class="even">
<td>a -&gt; a -&gt; a</td>
<td>El tipo de función de dos argumentos de cualquier tipo a al</td>
</tr>
<tr class="odd">
<td>mismo tipo a</td>
<td></td>
</tr>
</tbody>
</table>
<p>En el tipo <code>a -&gt; a -&gt; a</code>, la letra <code>a</code> es una <em>variable de tipo</em>. Significa que <code>f</code> es una función con dos argumentos y esos dos argumentos y el resultado tienen que ser del mismo tipo, La variable de tipo <code>a</code> puede ser cualquier tipo. Por ejemplo <code>Int</code>, <code>Integer</code>, <code>Float</code>…</p>
<p>Así que en lugar de forzar un tipo en particular como en <code>C</code> y tener que declarar una función para <code>int</code>, <code>long</code>, <code>float</code>, <code>double</code>, etc., podemos declarar una sola función como en un lenguaje de tipado dinámico.</p>
<p>Esto es algunas veces llamado polimorfismo paramétrico.</p>
<p>Generalmente <code>a</code> puede ser cualquier tipo, por ejemplo un <code>String</code> a un <code>Int</code>, pero también puede ser tipos más complejos, como <code>Trees</code>, otras funciones, etc. Pero en este caso nuestro tipo tiene como prefijo <code>Num a =&gt;</code>.</p>
<p><code>Num</code> es una <em>clase de tipo</em> (type class). Una clase de tipo puede ser vista como un conjunto de tipos. <code>Num</code> contiene solamente los tipos que pueden comportarse como números. Más concretamente, <code>Num</code> es una clase que contiene tipos que implementan una lista especifica de funciones, en particular <code>(+)</code> y <code>(*)</code>.</p>
<p>Las clases de tipos son un aspecto muy potente del lenguaje. Podemos hacer cosas increíbles con esto. Más sobre el tema luego.</p>
<p>Finalmente, <code>Num a =&gt; a -&gt; a -&gt; a</code> significa:</p>
<p>Sea <code>a</code> un tipo que pertenece a la clase de tipo <code>Num</code>. Esto es una función de tipo <code>a</code> a (<code>a -&gt; a</code>).</p>
<p>Si, extraño. De hecho, en Haskell ninguna función tiene dos argumentos. En lugar de eso todas las funciones pueden tener un solo argumento. Pero notaremos que tomar dos argumentos es equivalente a tomar un argumento y retornar una función que toma el segundo argumento como parámetro.</p>
<p>Más concretamente <code>f 3 4</code> es equivalente a <code>(f 3) 4</code>. Nótese que <code>f 3</code> es una función:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="ot">f ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="ot">g ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">g <span class="fu">=</span> f <span class="dv">3</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"></a>
<a class="sourceLine" id="cb22-6" data-line-number="6">g y ⇔ <span class="dv">3</span><span class="fu">*</span><span class="dv">3</span> <span class="fu">+</span> y<span class="fu">*</span>y</a></code></pre></div>
<p>Existe otra notación para funciones. La notación <em>lambda</em> nos permite crear funciones sin asignarles un nombre. Llamamos a estas funciones anónimas. Podemos escribirlas como:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" data-line-number="1">g <span class="fu">=</span> \y <span class="ot">-&gt;</span> <span class="dv">3</span><span class="fu">*</span><span class="dv">3</span> <span class="fu">+</span> y<span class="fu">*</span>y</a></code></pre></div>
<p>El <code>\\</code> es usado por que se parece a <code>λ</code> (símbolo lambda) y es ASCII.</p>
<p>Si no estás acostumbrado a la programación funcional tu cerebro debería estar empezando a calentarse. Es tiempo de hacer una aplicación real.</p>
<p>Pero antes de eso, deberíamos verificar que el sistema de tipos funciona según lo esperado.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="ot">f ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">f x y <span class="fu">=</span> x<span class="fu">*</span>x <span class="fu">+</span> y<span class="fu">*</span>y</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"></a>
<a class="sourceLine" id="cb24-4" data-line-number="4">main <span class="fu">=</span> print (f <span class="dv">3</span> <span class="fl">2.4</span>)</a></code></pre></div>
<p>Funciona, porque, <code>3</code> es una representación valida para números fraccionarios como <code>Float</code> así como para <code>Integer</code>. Como <code>2.4</code> es una numero fraccionario, <code>3</code> es interpretado también como un numero fraccionario.</p>
<p>Si forzamos nuestra función a trabajar con tipos diferentes, fallará.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="ot">f ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">f x y <span class="fu">=</span> x<span class="fu">*</span>x <span class="fu">+</span> y<span class="fu">*</span>y</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="ot">x ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5">x <span class="fu">=</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="ot">y ::</span> <span class="dt">Float</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7">y <span class="fu">=</span> <span class="fl">2.4</span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8"><span class="co">-- No funcionará por que el tipo x ≠ tipo y</span></a>
<a class="sourceLine" id="cb25-9" data-line-number="9">main <span class="fu">=</span> print (f x y)</a></code></pre></div>
<p>El compilador se queja. Los dos parámetros deben ser del mismo tipo.</p>
<p>Si piensas que esto es una mala idea, y que el compilador debería hacer la transformación de un tipo al otro por ti, deberías ver este fantástico (y divertido) vídeo: <a href="https://www.destroyallsoftware.com/talks/wat">WAT</a></p>
<h1 id="haskell-esencial">Haskell esencial</h1>
<p><img src="/img/haskellhard/shot4.jpg" class="img-responsive" /><br />
</p>
<p>Sugiero que leas con ligereza esta parte. Mírala como una referencia. Haskell tiene un montón de características. Regresa aquí cada vez que la notación te parezca extraña.</p>
<p>Uso el símbolo <code>⇔</code> para indicar que dos expresiones son equivalentes. Es una meta notación, <code>⇔</code> no existe en Haskell. También usaré <code>⇒</code> para indicar cual es el valor de retorno de una expresión.</p>
<h2 id="notaciones">Notaciones</h2>
<p><strong>Aritmética</strong></p>
<pre><code>3 + 2 * 6 / 3 ⇔ 3 + ((2*6)/3)</code></pre>
<p><strong>Lógica</strong></p>
<pre><code>True || False ⇒ True
True &amp;&amp; False ⇒ False
True == False ⇒ False
True /= False ⇒ True  (/=) es el operador diferencia</code></pre>
<p><strong>Potencias</strong></p>
<pre><code>x^n     para un n entero (Int o Integer)
x**y    para cualquier tipo de numero y (como un Float)</code></pre>
<p><code>Integer</code> no tiene ningún limite además de la capacidad de tu máquina.</p>
<pre><code>4^103
102844034832575377634685573909834406561420991602098741459288064</code></pre>
<p>Si! También hay números racionales! Pero hay que importar el modulo <code>Data.Ratio</code>:</p>
<pre><code>$ ghci
....
Prelude&gt; :m Data.Ratio
Data.Ratio&gt; (11 % 15) * (5 % 3)
11 % 9</code></pre>
<p><strong>Listas</strong></p>
<pre><code>[]                      ⇔ Lista vacia
[1,2,3]                 ⇔ Lista de enteros
[&quot;foo&quot;,&quot;bar&quot;,&quot;baz&quot;]     ⇔ Lista de cadenas
1:[2,3]                 ⇔ [1,2,3], (:) anteponer un elemento
1:2:[]                  ⇔ [1,2]
[1,2] ++ [3,4]          ⇔ [1,2,3,4], (++) concatenar
[1,2,3] ++ [&quot;foo&quot;]      ⇔ ERROR String ≠ Integral
[1..4]                  ⇔ [1,2,3,4]
[1,3..10]               ⇔ [1,3,5,7,9]
[2,3,5,7,11..100]       ⇔ ERROR! No soy tan inteligente!
[10,9..1]               ⇔ [10,9,8,7,6,5,4,3,2,1]</code></pre>
<p><strong>Cadenas</strong></p>
<p>En Haskell las cadenas son listas de <code>Char</code>.</p>
<pre><code>&#39;a&#39; :: Char
&quot;a&quot; :: [Char]
&quot;&quot;  ⇔ []
&quot;ab&quot; ⇔ [&#39;a&#39;,&#39;b&#39;] ⇔  &#39;a&#39;:&quot;b&quot; ⇔ &#39;a&#39;:[&#39;b&#39;] ⇔ &#39;a&#39;:&#39;b&#39;:[]
&quot;abc&quot; ⇔ &quot;ab&quot;++&quot;c&quot;


En código real no se debería usar una lista de `Char` para
representar texto. Se debería usar `Data.Text`. Si quieres
representar un flujo de caracteres ASCII, deberías usar
`Data.ByteString`.</code></pre>
<p><strong>Tuplas</strong></p>
<p>El tipo de una tupla es <code>(a,b)</code>. Los elementos dentro de una tupla pueden tener diferentes tipos.</p>
<pre><code>-- Todas estas tuplas son validas
(2,&quot;foo&quot;)
(3,&#39;a&#39;,[2,3])
((2,&quot;a&quot;),&quot;c&quot;,3)

fst (x,y)       ⇒  x
snd (x,y)       ⇒  y

fst (x,y,z)     ⇒  ERROR: fst :: (a,b) -&gt; a
snd (x,y,z)     ⇒  ERROR: snd :: (a,b) -&gt; b</code></pre>
<p><strong>Controlar los paréntesis</strong></p>
<p>Para remover algunos paréntesis se pueden usar dos funciones: <code>($)</code> y <code>(.)</code>.</p>
<pre><code>-- Por defecto:
f g h x         ⇔  (((f g) h) x)

-- el $ reemplaza los paréntessis desde el $
-- hasta el final de la expresión
f g $ h x       ⇔  f g (h x) ⇔ (f g) (h x)
f $ g h x       ⇔  f (g h x) ⇔ f ((g h) x)
f $ g $ h x     ⇔  f (g (h x))

-- (.) composición de funciones
(f . g) x       ⇔  f (g x)
(f . g . h) x   ⇔  f (g (h x))</code></pre>
<h2 id="notaciones-útiles-para-funciones">Notaciones útiles para funciones</h2>
<p>Solo un recordatorio:</p>
<pre><code>x :: Int            ⇔ x es de tipo Int
x :: a              ⇔ x puede ser de cualquier tipo
x :: Num a =&gt; a     ⇔ x puede ser cualquier tipo a
                    que pertenezca a la class de typo Num
f :: a -&gt; b         ⇔ f es una función de a hacia b
f :: a -&gt; b -&gt; c    ⇔ f es una función de a hacia (b→c)
f :: (a -&gt; b) -&gt; c  ⇔ f es una función de (a→b) hacia c</code></pre>
<p>Recuerda que definir el tipo de una función antes de su declaración no es obligatorio. Haskell infiere el tipo más general por ti. Pero es considerado una buena practica hacerlo de todos modos.</p>
<p><strong>Notación infijo</strong></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="ot">square ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">square x <span class="fu">=</span> x<span class="fu">^</span><span class="dv">2</span></a></code></pre></div>
<p>Nótese que <code>^</code> usa notación infijo. Para cada operador infijo hay una notación prefijo asociada. Solo debe ponerse entre paréntesis.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb37-1" data-line-number="1">square&#39; x <span class="fu">=</span> (<span class="fu">^</span>) x <span class="dv">2</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">square&#39;&#39; x <span class="fu">=</span> (<span class="fu">^</span><span class="dv">2</span>) x</a></code></pre></div>
<p>Podemos remover <code>x</code> en el lado izquierdo y derecho! Eso se llama reducción η.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb38-1" data-line-number="1">square&#39;&#39;&#39; <span class="fu">=</span> (<span class="fu">^</span><span class="dv">2</span>)</a></code></pre></div>
<p>Nótese que podemos declarar funciones con un <code>'</code> en su nombre:</p>
<pre><code>square ⇔ square&#39; ⇔ square&#39;&#39; ⇔ square&#39;&#39;&#39;</code></pre>
<p><strong>Tests</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="ot">absolute ::</span> (<span class="dt">Ord</span> a, <span class="dt">Num</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb40-2" data-line-number="2">absolute x <span class="fu">=</span> <span class="kw">if</span> x <span class="fu">&gt;=</span> <span class="dv">0</span> <span class="kw">then</span> x <span class="kw">else</span> <span class="fu">-</span>x</a></code></pre></div>
<p>Nota: el <code>if .. then .. else</code> en Haskell es como el <code>algo ? algo : algo</code> en C. No puedes olvidar el <code>else</code></p>
<p>Otra versión equivalente:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb41-1" data-line-number="1">absolute&#39; x</a>
<a class="sourceLine" id="cb41-2" data-line-number="2">    <span class="fu">|</span> x <span class="fu">&gt;=</span> <span class="dv">0</span> <span class="fu">=</span> x</a>
<a class="sourceLine" id="cb41-3" data-line-number="3">    <span class="fu">|</span> otherwise <span class="fu">=</span> <span class="fu">-</span>x</a></code></pre></div>
<pre><code>Advertencia: la indentación es importante en Haskell. Como en
Python, una mala indentación pueden dañar el código!</code></pre>
<h1 id="parte-difícil">Parte difícil</h1>
<p>La parte difícil puede empezar ahora.</p>
<h2 id="estilo-funcional">Estilo funcional</h2>
<p><img src="/img/haskellhard/shot5.jpg" class="img-responsive" /><br />
</p>
<p>En esta sección, proporcionaré un ejemplo corto de la impresionante habilidad para refactorizar de Haskell. Seleccionaremos un problema y los resolveremos en la forma imperativa estándar. Luego desarrollaremos el código. Al final el resultado será más elegante y más sencillo de adaptar.</p>
<p>Solucionemos el siguiente problema:</p>
<pre><code>Dada una lista de enteros, retornar la suma de numeros pares en la lita.
ejemplo: `[1,2,3,4,5] ⇒ 2 + 4 ⇒ 6`</code></pre>
<p>Para mostrar las diferencias entre los enfoques funcional e imperativo, Empezaré con la solución imperativa (en JavaScript):</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw">function</span> <span class="at">evenSum</span>(list) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2">    <span class="kw">var</span> result <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3">    <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span> <span class="va">list</span>.<span class="at">length</span> <span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4">        <span class="cf">if</span> (list[i] <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span><span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5">            result <span class="op">+=</span> list[i]<span class="op">;</span></a>
<a class="sourceLine" id="cb44-6" data-line-number="6">        <span class="op">}</span></a>
<a class="sourceLine" id="cb44-7" data-line-number="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-8" data-line-number="8">    <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb44-9" data-line-number="9"><span class="op">}</span></a></code></pre></div>
<p>En Haskell, en contraste, no tenemos variables ni un loop <code>for</code>. Una solución para lograr el mismo resultado sin loops es usando recursión.</p>
<pre><code>Nota: La recursión es generalmente persivida como lenta en los lengajes
imperativos. Pero generalmente no es el caso en la programación funcional.
La mayor parte del tiempo Haskell manejará funciones recursivas de forma
eficiente.</code></pre>
<p>Aquí esta la versión en <code>C</code> de la función recursiva. Por simplicidad asumí que la lista de <code>int</code> termina con el primer valor de <code>0</code>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="dt">int</span> evenSum(<span class="dt">int</span> *list) {</a>
<a class="sourceLine" id="cb46-2" data-line-number="2">    <span class="cf">return</span> accumSum(<span class="dv">0</span>,list);</a>
<a class="sourceLine" id="cb46-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb46-4" data-line-number="4"></a>
<a class="sourceLine" id="cb46-5" data-line-number="5"><span class="dt">int</span> accumSum(<span class="dt">int</span> n, <span class="dt">int</span> *list) {</a>
<a class="sourceLine" id="cb46-6" data-line-number="6">    <span class="dt">int</span> x;</a>
<a class="sourceLine" id="cb46-7" data-line-number="7">    <span class="dt">int</span> *xs;</a>
<a class="sourceLine" id="cb46-8" data-line-number="8">    <span class="cf">if</span> (*list == <span class="dv">0</span>) { <span class="co">// si la lista está vacia</span></a>
<a class="sourceLine" id="cb46-9" data-line-number="9">        <span class="cf">return</span> n;</a>
<a class="sourceLine" id="cb46-10" data-line-number="10">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb46-11" data-line-number="11">        x = list[<span class="dv">0</span>]; <span class="co">// x es el primer elemento de la lista</span></a>
<a class="sourceLine" id="cb46-12" data-line-number="12">        xs = list+<span class="dv">1</span>; <span class="co">// xs es la lista sin el elemento x</span></a>
<a class="sourceLine" id="cb46-13" data-line-number="13">        <span class="cf">if</span> ( <span class="dv">0</span> == (x%<span class="dv">2</span>) ) { <span class="co">// si x es par</span></a>
<a class="sourceLine" id="cb46-14" data-line-number="14">            <span class="cf">return</span> accumSum(n+x, xs);</a>
<a class="sourceLine" id="cb46-15" data-line-number="15">        } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb46-16" data-line-number="16">            <span class="cf">return</span> accumSum(n, xs);</a>
<a class="sourceLine" id="cb46-17" data-line-number="17">        }</a>
<a class="sourceLine" id="cb46-18" data-line-number="18">    }</a>
<a class="sourceLine" id="cb46-19" data-line-number="19">}</a></code></pre></div>
<p>Mantén este código en mente. Lo vamos a traducir a Haskell. Sin embargo, vamos a necesitar primero introducir tres simples pero útiles funciones que usaremos:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb47-1" data-line-number="1">even<span class="ot"> ::</span> <span class="dt">Integrall</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2">head<span class="ot"> ::</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb47-3" data-line-number="3">tail<span class="ot"> ::</span> [a] <span class="ot">-&gt;</span> [a]</a></code></pre></div>
<p><code>even</code> verifica si un numero es par.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb48-1" data-line-number="1">even<span class="ot"> ::</span> <span class="dt">Integral</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2">even <span class="dv">3</span>  <span class="ot">⇒</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb48-3" data-line-number="3">even <span class="dv">2</span>  <span class="ot">⇒</span> <span class="dt">True</span></a></code></pre></div>
<p><code>head</code> retorna el primer elemento de la lista:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb49-1" data-line-number="1">head<span class="ot"> ::</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb49-2" data-line-number="2">head [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">⇒</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb49-3" data-line-number="3">head []      <span class="ot">⇒</span> <span class="dt">ERROR</span></a></code></pre></div>
<p><code>tail</code> retorna todos los elementos de la lista, excepto el primero:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb50-1" data-line-number="1">tail<span class="ot"> ::</span> [a] <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb50-2" data-line-number="2">tail [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">⇒</span> [<span class="dv">2</span>,<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb50-3" data-line-number="3">tail [<span class="dv">3</span>]     <span class="ot">⇒</span> []</a>
<a class="sourceLine" id="cb50-4" data-line-number="4">tail []      <span class="ot">⇒</span> <span class="dt">ERROR</span></a></code></pre></div>
<p>Nótese que para cualquier lista no vacía <code>l</code>, <code>l ⇔ (head l):(tail l)</code></p>
<p>La primera solución en Haskell. La función <code>evenSum</code> retorna la suma de todos los números pares en la lista:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="co">-- Version 1</span></a>
<a class="sourceLine" id="cb51-2" data-line-number="2"><span class="ot">evenSum ::</span> [<span class="dt">Integer</span>] <span class="ot">-&gt;</span> <span class="dt">Integer</span></a>
<a class="sourceLine" id="cb51-3" data-line-number="3"></a>
<a class="sourceLine" id="cb51-4" data-line-number="4">evenSum l <span class="fu">=</span> accumSum <span class="dv">0</span> l</a>
<a class="sourceLine" id="cb51-5" data-line-number="5"></a>
<a class="sourceLine" id="cb51-6" data-line-number="6">accumSum n l <span class="fu">=</span> <span class="kw">if</span> l <span class="fu">==</span> []</a>
<a class="sourceLine" id="cb51-7" data-line-number="7">                  <span class="kw">then</span> n</a>
<a class="sourceLine" id="cb51-8" data-line-number="8">                  <span class="kw">else</span> <span class="kw">let</span> x <span class="fu">=</span> head l</a>
<a class="sourceLine" id="cb51-9" data-line-number="9">                           xs <span class="fu">=</span> tail l</a>
<a class="sourceLine" id="cb51-10" data-line-number="10">                       <span class="kw">in</span> <span class="kw">if</span> even x</a>
<a class="sourceLine" id="cb51-11" data-line-number="11">                              <span class="kw">then</span> accumSum (n<span class="fu">+</span>x) xs</a>
<a class="sourceLine" id="cb51-12" data-line-number="12">                              <span class="kw">else</span> accumSum n xs</a></code></pre></div>
<p>Para probar la función puedes usar <code>ghci</code>:</p>
<pre><code>% ghci
GHCi, version 7.0.3: http://www.haskell.org/ghc/  :? for help
Loading package ghc-prim ... linking ... done.
Loading package integer-gmp ... linking ... done.
Loading package base ... linking ... done.
Prelude&gt; :load 11_Functions.lhs
[1 of 1] Compiling Main             ( 11_Functions.lhs, interpreted )
Ok, modules loaded: Main.
*Main&gt; evenSum [1..5]
6</code></pre>
<p>Aquí un ejemplo de la ejecución[^2]:</p>
<pre><code>*Main&gt; evenSum [1..5]
accumSum 0 [1,2,3,4,5]
1 is odd
accumSum 0 [2,3,4,5]
2 is even
accumSum (0+2) [3,4,5]
3 is odd
accumSum (0+2) [4,5]
2 is even
accumSum (0+2+4) [5]
5 is odd
accumSum (0+2+4) []
l == []
0+2+4
0+6
6</code></pre>
<p>Viniendo de un lenguaje imperativo todo debería parecer correcto. De hecho, muchas cosas se pueden mejorar. Primero, podemos generalizar el tipo.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="ot">evenSum ::</span> <span class="dt">Integral</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>Luego, podemos usar sub-funciones usando <code>where</code> o <code>let</code>. De esta forma la función <code>accumSum</code> no llenará el espacio de nombres de nuestro modulo.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb55-1" data-line-number="1"><span class="co">-- Version 2</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2"><span class="ot">evenSum ::</span> <span class="dt">Integral</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb55-3" data-line-number="3"></a>
<a class="sourceLine" id="cb55-4" data-line-number="4">evenSum l <span class="fu">=</span> accumSum <span class="dv">0</span> l</a>
<a class="sourceLine" id="cb55-5" data-line-number="5">    <span class="kw">where</span> accumSum n l <span class="fu">=</span></a>
<a class="sourceLine" id="cb55-6" data-line-number="6">            <span class="kw">if</span> l <span class="fu">==</span> []</a>
<a class="sourceLine" id="cb55-7" data-line-number="7">                <span class="kw">then</span> n</a>
<a class="sourceLine" id="cb55-8" data-line-number="8">                <span class="kw">else</span> <span class="kw">let</span> x <span class="fu">=</span> head l</a>
<a class="sourceLine" id="cb55-9" data-line-number="9">                         xs <span class="fu">=</span> tail l</a>
<a class="sourceLine" id="cb55-10" data-line-number="10">                     <span class="kw">in</span> <span class="kw">if</span> even x</a>
<a class="sourceLine" id="cb55-11" data-line-number="11">                            <span class="kw">then</span> accumSum (n<span class="fu">+</span>x) xs</a>
<a class="sourceLine" id="cb55-12" data-line-number="12">                            <span class="kw">else</span> accumSum n xs</a></code></pre></div>
<p>Luego podemos usar pattern matching.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="co">-- Version 3</span></a>
<a class="sourceLine" id="cb56-2" data-line-number="2">evenSum l <span class="fu">=</span> accumSum <span class="dv">0</span> l</a>
<a class="sourceLine" id="cb56-3" data-line-number="3">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb56-4" data-line-number="4">        accumSum n [] <span class="fu">=</span> n</a>
<a class="sourceLine" id="cb56-5" data-line-number="5">        accumSum n (x<span class="fu">:</span>xs) <span class="fu">=</span></a>
<a class="sourceLine" id="cb56-6" data-line-number="6">             <span class="kw">if</span> even x</a>
<a class="sourceLine" id="cb56-7" data-line-number="7">                <span class="kw">then</span> accumSum (n<span class="fu">+</span>x) xs</a>
<a class="sourceLine" id="cb56-8" data-line-number="8">                <span class="kw">else</span> accumSum n xs</a></code></pre></div>
<p>Qué es pattern matching? Usar valores en lugar de nombres de parámetro generales[^3].</p>
<p>En lugar de decir: <code>foo l = if l == [] then &lt;x&gt; else &lt;y&gt;</code> simplemente se declara:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb57-1" data-line-number="1">foo [] <span class="fu">=</span>  <span class="fu">&lt;</span>x<span class="fu">&gt;</span></a>
<a class="sourceLine" id="cb57-2" data-line-number="2">foo l  <span class="fu">=</span>  <span class="fu">&lt;</span>y<span class="fu">&gt;</span></a></code></pre></div>
<p>Pero el pattern matching va más lejos. También es capaz de inspeccionar el elemento interno de un valor complejo. Podemos reemplazar</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb58-1" data-line-number="1">foo l <span class="fu">=</span>  <span class="kw">let</span> x  <span class="fu">=</span> head l</a>
<a class="sourceLine" id="cb58-2" data-line-number="2">             xs <span class="fu">=</span> tail l</a>
<a class="sourceLine" id="cb58-3" data-line-number="3">         <span class="kw">in</span> <span class="kw">if</span> even x</a>
<a class="sourceLine" id="cb58-4" data-line-number="4">             <span class="kw">then</span> foo (n<span class="fu">+</span>x) xs</a>
<a class="sourceLine" id="cb58-5" data-line-number="5">             <span class="kw">else</span> foo n xs</a></code></pre></div>
<p>Con</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb59-1" data-line-number="1">foo (x<span class="fu">:</span>xs) <span class="fu">=</span> <span class="kw">if</span> even x</a>
<a class="sourceLine" id="cb59-2" data-line-number="2">                 <span class="kw">then</span> foo (n<span class="fu">+</span>x) xs</a>
<a class="sourceLine" id="cb59-3" data-line-number="3">                 <span class="kw">else</span> foo n xs</a></code></pre></div>
<p>Esto es una característica muy útil. Hace nuestro código más conciso y fácil de leer.</p>
<p>En Haskell se puede simplificar las definiciones de las funciones usando reducción η. Por ejemplo, en lugar de escribir:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb60-1" data-line-number="1">f x <span class="fu">=</span> (una expresion) x</a></code></pre></div>
<p>Se puede escribir</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb61-1" data-line-number="1">f <span class="fu">=</span> una expression</a></code></pre></div>
<p>Usamos este método para remover el <code>l</code>:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb62-1" data-line-number="1"><span class="co">-- Version 4</span></a>
<a class="sourceLine" id="cb62-2" data-line-number="2"><span class="ot">evenSum ::</span> <span class="dt">Integral</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb62-3" data-line-number="3"></a>
<a class="sourceLine" id="cb62-4" data-line-number="4">evenSum <span class="fu">=</span> accumSum <span class="dv">0</span></a>
<a class="sourceLine" id="cb62-5" data-line-number="5">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb62-6" data-line-number="6">        accumSum n [] <span class="fu">=</span> n</a>
<a class="sourceLine" id="cb62-7" data-line-number="7">        accumSum n (x<span class="fu">:</span>xs) <span class="fu">=</span></a>
<a class="sourceLine" id="cb62-8" data-line-number="8">             <span class="kw">if</span> even x</a>
<a class="sourceLine" id="cb62-9" data-line-number="9">                <span class="kw">then</span> accumSum (n<span class="fu">+</span>x) xs</a>
<a class="sourceLine" id="cb62-10" data-line-number="10">                <span class="kw">else</span> accumSum n xs</a></code></pre></div>
<h3 id="funciones-de-orden-superior">Funciones de orden superior</h3>
<p><img src="/img/haskellhard/shot6.jpg" class="img-responsive" /><br />
</p>
<p>Para mejorarlo aún más podemos usar funciones de orden superior. Qué son esas bestias? Las funciones de orden superior son funciones que toman funciones como parámetros.</p>
<p>Aquí algunos ejemplos:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb63-1" data-line-number="1">filter<span class="ot"> ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb63-2" data-line-number="2">map<span class="ot"> ::</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [b]</a>
<a class="sourceLine" id="cb63-3" data-line-number="3">foldl<span class="ot"> ::</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> [b] <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>Procedamos con pequeños pasos.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb64-1" data-line-number="1"><span class="co">-- Version 5</span></a>
<a class="sourceLine" id="cb64-2" data-line-number="2">evenSum l <span class="fu">=</span> mysum <span class="dv">0</span> (filter even l)</a>
<a class="sourceLine" id="cb64-3" data-line-number="3">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb64-4" data-line-number="4">      mysum n [] <span class="fu">=</span> n</a>
<a class="sourceLine" id="cb64-5" data-line-number="5">      mysum n (x<span class="fu">:</span>xs) <span class="fu">=</span> mysum (n<span class="fu">+</span>x) xs</a></code></pre></div>
<p>Donde</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb65-1" data-line-number="1">filter even [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>] ⇔  [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">10</span>]</a></code></pre></div>
<p>La función <code>filter</code> toma una función de tipo (<code>a -&gt; Bool</code>) y una lista de tipo <code>[a]</code>. Retorna una lista que contiene solamente los elementos para los cuales la función retornó <code>true</code>.</p>
<p>El siguiente paso es usar otra técnica para lograr el mismo resultado que un loop. Usaremos la función <code>foldl</code> para acumular los valores mientras recorremos la lista. La función <code>foldl</code> captura un patrón común:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb66-1" data-line-number="1">myfunc list <span class="fu">=</span> foo initialValue list</a>
<a class="sourceLine" id="cb66-2" data-line-number="2">foo accumulated []     <span class="fu">=</span> accumulated</a>
<a class="sourceLine" id="cb66-3" data-line-number="3">foo tmpValue    (x<span class="fu">:</span>xs) <span class="fu">=</span> foo (bar tmpValue x) xs</a></code></pre></div>
<p>Que se puede reemplazar con:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb67-1" data-line-number="1">myfunc list <span class="fu">=</span> foldl bar initialValue list</a></code></pre></div>
<p>Si realmente quieres saber como funciona la magia, aquí está la definición de <code>foldl</code>:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb68-1" data-line-number="1">foldl f z [] <span class="fu">=</span> z</a>
<a class="sourceLine" id="cb68-2" data-line-number="2">foldl f z (x<span class="fu">:</span>xs) <span class="fu">=</span> foldl f (f z x) xs</a></code></pre></div>
<div class="sourceCode" id="cb69"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb69-1" data-line-number="1">foldl f z [x1,<span class="fu">...</span>xn]</a>
<a class="sourceLine" id="cb69-2" data-line-number="2">⇔  f (<span class="fu">...</span> (f (f z x1) x2) <span class="fu">...</span>) xn</a></code></pre></div>
<p>Pero como Haskell es <em>perezoso</em>, no evalúa <code>(f z x)</code> y simplemente lo empuja en la pila. Por eso generalmente usamos <code>foldl'</code> en lugar de <code>foldl</code>; <code>foldl'</code> es una versión estricta de <code>foldl</code>. Si no comprendes que significa <em>perezoso</em> o <em>estricto</em>, no te preocupes, solo sigue el código como si <code>fold</code> y <code>foldl'</code> fueran idénticos.</p>
<p>Ahora la nueva versión de <code>evenSum</code> será:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb70-1" data-line-number="1"><span class="co">-- Version 6</span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2"><span class="co">-- foldl&#39; isn&#39;t accessible by default</span></a>
<a class="sourceLine" id="cb70-3" data-line-number="3"><span class="co">-- we need to import it from the module Data.List</span></a>
<a class="sourceLine" id="cb70-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Data.List</span></a>
<a class="sourceLine" id="cb70-5" data-line-number="5">evenSum l <span class="fu">=</span> foldl&#39; mysum <span class="dv">0</span> (filter even l)</a>
<a class="sourceLine" id="cb70-6" data-line-number="6">  <span class="kw">where</span> mysum acc value <span class="fu">=</span> acc <span class="fu">+</span> value</a></code></pre></div>
<p>También podemos simplificar eso usando notación lambda. Así no tendremos que crear un nombre temporal <code>mysum</code>.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb71-1" data-line-number="1"><span class="co">-- Version 7</span></a>
<a class="sourceLine" id="cb71-2" data-line-number="2"><span class="co">-- Generally it is considered a good practice</span></a>
<a class="sourceLine" id="cb71-3" data-line-number="3"><span class="co">-- to import only the necessary function(s)</span></a>
<a class="sourceLine" id="cb71-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Data.List</span> (foldl&#39;)</a>
<a class="sourceLine" id="cb71-5" data-line-number="5">evenSum l <span class="fu">=</span> foldl&#39; (\x y <span class="ot">-&gt;</span> x<span class="fu">+</span>y) <span class="dv">0</span> (filter even l)</a></code></pre></div>
<p>Y por supuesto, notamos que</p>
<p><code>(\x y -&gt; x+y) ⇔ (+)</code></p>
<p>Finalmente</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb72-1" data-line-number="1"><span class="co">-- Version 8</span></a>
<a class="sourceLine" id="cb72-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Data.List</span> (foldl&#39;)</a>
<a class="sourceLine" id="cb72-3" data-line-number="3"><span class="ot">evenSum ::</span> <span class="dt">Integral</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb72-4" data-line-number="4">evenSum l <span class="fu">=</span> foldl&#39; (<span class="fu">+</span>) <span class="dv">0</span> (filter even l)</a></code></pre></div>
<p><code>foldl'</code> no es la función más sencilla de comprender. Si no estas acostumbrado, deberías estudiarlo un poco.</p>
<p>Para ayudar a comprender que está sucediendo aquí, miremos la evaluación paso por paso:</p>
<pre><code>evenSum [1,2,3,4]
⇒ foldl&#39; (+) 0 (filter even [1,2,3,4])
⇒ foldl&#39; (+) 0 [2,4]
⇒ foldl&#39; (+) (0+2) [4]
⇒ foldl&#39; (+) 2 [4]
⇒ foldl&#39; (+) (2+4) []
⇒ foldl&#39; (+) 6 []
⇒ 6</code></pre>
<p>Otra función de orden superior útil es <code>(.)</code>. La función <code>(.)</code> corresponde a la composición matemática de funciones.</p>
<p><code>(f . g . h) x ⇔  f ( g (h x))</code></p>
<p>Podemos tomar ventaja de este operador para hacer una reducción η en nuestra función:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb74-1" data-line-number="1"><span class="co">-- Version 9</span></a>
<a class="sourceLine" id="cb74-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Data.List</span> (foldl&#39;)</a>
<a class="sourceLine" id="cb74-3" data-line-number="3"><span class="ot">evenSum ::</span> <span class="dt">Integral</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb74-4" data-line-number="4">evenSum <span class="fu">=</span> (foldl&#39; (<span class="fu">+</span>) <span class="dv">0</span>) <span class="fu">.</span> (filter even)</a></code></pre></div>
<p>También, podemos renombrar algunas partes para hacerlo más claro:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="co">-- Version 10</span></a>
<a class="sourceLine" id="cb75-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Data.List</span> (foldl&#39;)</a>
<a class="sourceLine" id="cb75-3" data-line-number="3"><span class="ot">sum&#39; ::</span> (<span class="dt">Num</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">sum&#39; <span class="fu">=</span> foldl&#39; (<span class="fu">+</span>) <span class="dv">0</span></a>
<a class="sourceLine" id="cb75-5" data-line-number="5"><span class="ot">evenSum ::</span> <span class="dt">Integral</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb75-6" data-line-number="6">evenSum <span class="fu">=</span> sum&#39; <span class="fu">.</span> (filter even)</a></code></pre></div>
<p>Es tiempo de hablar sobre la dirección hacia la cual se ha movido nuestro código mientras introducimos más de la forma funcional. Qué hemos ganado al usar funciones de orden superior?</p>
<p>Al principio podrías pensar que la principal diferencia es la brevedad. Pero en realidad tiene más que ver con la forma en la que se piensa. Supongamos que se quiere modificar un poco la función, por ejemplo, para obtener la suma de los cuadrados de los elementos pares de la lista.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb76-1" data-line-number="1">[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>] ▷ [<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">16</span>] ▷ [<span class="dv">4</span>,<span class="dv">16</span>] ▷ <span class="dv">20</span></a></code></pre></div>
<p>Actualizar la versión 10 es muy fácil:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb77-1" data-line-number="1">squareEvenSum <span class="fu">=</span> sum&#39; <span class="fu">.</span> (filter even) <span class="fu">.</span> (map (<span class="fu">^</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb77-2" data-line-number="2">squareEvenSum&#39; <span class="fu">=</span> evenSum <span class="fu">.</span> (map (<span class="fu">^</span><span class="dv">2</span>))</a></code></pre></div>
<p>Solamente agregamos otra “función de transformación”.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb78-1" data-line-number="1">map (<span class="fu">^</span><span class="dv">2</span>) [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>] ⇔ [<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">9</span>,<span class="dv">16</span>]</a></code></pre></div>
<p>La función <code>map</code> simplemente aplica una función sobre todos los elementos de una lista.</p>
<p>No tuvimos que modificar nada <em>dentro</em> de la definición de la función. Esto hace el código más modular. Pero también permite pensar en la función de forma más matemática. También se puede usar la función intercambiablemente con otras, según se necesite. Esto es, se puede hacer compose, map, fold, filter usando la nueva función.</p>
<p>Modificar la versión 1 se deja como ejercicio para el lector ☺.</p>
<p>Si piensas que hemos llegado al final de la generalización, entonces enterate que estas muy equivocado. Por ejemplo, hay una forma de usar esta fucnion no solo en listas, sino ademas sobre cualquier tipo recursivo. Si quieres saber como, recomiendo que leas este <a href="http://eprints.eemcs.utwente.nl/7281/01/db-utwente-40501F46.pdf">artículo</a></p>
<p>Este ejemplo debería demostrar cuan genial es la programación funcional. Desafortunadamente, usar programación funcional pura no es adecuado para todos los usos. O al menos un lenguaje que lo permite no se a logrado aún.</p>
<p>Uno de los mayores poderes de Haskell es la habilidad de crear DSLs (Lenguaje de dominio específico) haciendo sencillo cambiar el paradigma de programación.</p>
<p>De hecho, Haskell también es grandioso cuando se quiere escribir en estilo imperativo. Comprender esto fue muy difícil para mi cuando aprendía Haskell. Gran parte del esfuerzo se va intentando explicar la superioridad del enfoque funcional. Luego cuando empiezas a usar estilo imperativo con Haskell, puede ser difícil entender dónde y cómo usarlo.</p>
<p>Pero antes de hablar sobre este super poder de Haskell, debemos hablar sobre otro aspecto esencial de Haskell: Tipos.</p>
<h2 id="tipos">Tipos</h2>
<p><img src="/img/haskellhard/shot7.jpg" class="img-responsive" /><br />
</p>
<p>TL;DR*:</p>
<ul>
<li><p><code>type Nombre = OtroTipo</code> es solamente un alias y no hay ninguna diferencia entre <code>Nombre</code> y <code>OtroTipo</code>.</p></li>
<li><p><code>data Nombre = NombreConstructor OtroTipo</code> tiene diferencia</p></li>
<li><p><code>data</code> puede construir estructuras que pueden ser recursivas</p></li>
<li><p><code>deriving</code> es mágico y crea funciones por ti</p></li>
</ul>
<p>En Haskell, los tipos son fuertes y estáticos.</p>
<p>Por qué es importante? Permitirá en <em>gran</em> medida evitar errores. En Haskell, la mayoría de los errores se capturan durante la compilación del programa. Y la razón principal es debido a la inferencia de tipos durante la compilación. La inferencia de tipos hace sencillo detectar donde se usó el parámetro incorrecto en el lugar incorrecto, por ejemplo.</p>
<h3 id="inferencia-de-tipos">Inferencia de tipos</h3>
<p>El tipado estático es generalmente esencial para la ejecución veloz. Pero la mayoría de lenguajes estáticamente tipado son malos generalizando conceptos. La ventaja de Haskell es su capacidad para inferir tipos.</p>
<p>Aquí un ejemplo simple, la función <code>square</code> en Haskell:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb79-1" data-line-number="1">square x <span class="fu">=</span> x <span class="fu">*</span> x</a></code></pre></div>
<p>Esta función puede elevar al cuadrado cualquier tipo Numérico. Se puede pasar a <code>square</code> un <code>Int</code>, un <code>Integer</code>, un <code>Float</code>, un <code>Fractional</code> e incluso un <code>Complex</code>. Por ejemplo:</p>
<pre><code>% ghci
GHCi, version 7.0.4:
...
Prelude&gt; let square x = x*x
Prelude&gt; square 2
4
Prelude&gt; square 2.1
4.41
Prelude&gt; -- load the Data.Complex module
Prelude&gt; :m Data.Complex
Prelude Data.Complex&gt; square (2 :+ 1)
3.0 :+ 4.0</code></pre>
<p><code>x :+ y</code> es la notación para el complejo (x + iy).</p>
<p>Ahora compáralo con la cantidad de código necesario en <code>C</code>:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb81-1" data-line-number="1"><span class="dt">int</span>     int_square(<span class="dt">int</span> x) { <span class="cf">return</span> x*x; }</a>
<a class="sourceLine" id="cb81-2" data-line-number="2"></a>
<a class="sourceLine" id="cb81-3" data-line-number="3"><span class="dt">float</span>   float_square(<span class="dt">float</span> x) {<span class="cf">return</span> x*x; }</a>
<a class="sourceLine" id="cb81-4" data-line-number="4"></a>
<a class="sourceLine" id="cb81-5" data-line-number="5"><span class="dt">complex</span> complex_square (<span class="dt">complex</span> z) {</a>
<a class="sourceLine" id="cb81-6" data-line-number="6">    <span class="dt">complex</span> tmp;</a>
<a class="sourceLine" id="cb81-7" data-line-number="7">    tmp.real = z.real * z.real - z.img * z.img;</a>
<a class="sourceLine" id="cb81-8" data-line-number="8">    tmp.img = <span class="dv">2</span> * z.img * z.real;</a>
<a class="sourceLine" id="cb81-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb81-10" data-line-number="10"></a>
<a class="sourceLine" id="cb81-11" data-line-number="11"><span class="dt">complex</span> x,y;</a>
<a class="sourceLine" id="cb81-12" data-line-number="12">y = complex_square(x);</a></code></pre></div>
<p>Para cada tipo, se necesita escribir una nueva función. La única forma de solucionar esto es usando algún truco de meta-programación, por ejemplo usando el pre-procesador. En C++ hay una mejor forma usando templates:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></a>
<a class="sourceLine" id="cb82-2" data-line-number="2"><span class="pp">#include </span><span class="im">&lt;complex&gt;</span></a>
<a class="sourceLine" id="cb82-3" data-line-number="3"><span class="kw">using</span> <span class="kw">namespace</span> std;</a>
<a class="sourceLine" id="cb82-4" data-line-number="4"></a>
<a class="sourceLine" id="cb82-5" data-line-number="5"><span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;</a>
<a class="sourceLine" id="cb82-6" data-line-number="6">T square(T x)</a>
<a class="sourceLine" id="cb82-7" data-line-number="7">{</a>
<a class="sourceLine" id="cb82-8" data-line-number="8">    <span class="cf">return</span> x*x;</a>
<a class="sourceLine" id="cb82-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb82-10" data-line-number="10"></a>
<a class="sourceLine" id="cb82-11" data-line-number="11"><span class="dt">int</span> main() {</a>
<a class="sourceLine" id="cb82-12" data-line-number="12">    <span class="co">// int</span></a>
<a class="sourceLine" id="cb82-13" data-line-number="13">    <span class="dt">int</span> sqr_of_five = square(<span class="dv">5</span>);</a>
<a class="sourceLine" id="cb82-14" data-line-number="14">    cout &lt;&lt; sqr_of_five &lt;&lt; endl;</a>
<a class="sourceLine" id="cb82-15" data-line-number="15">    <span class="co">// double</span></a>
<a class="sourceLine" id="cb82-16" data-line-number="16">    cout &lt;&lt; (<span class="dt">double</span>)square(<span class="fl">5.3</span>) &lt;&lt; endl;</a>
<a class="sourceLine" id="cb82-17" data-line-number="17">    <span class="co">// complex</span></a>
<a class="sourceLine" id="cb82-18" data-line-number="18">    cout &lt;&lt; square( complex&lt;<span class="dt">double</span>&gt;(<span class="dv">5</span>,<span class="dv">3</span>) )</a>
<a class="sourceLine" id="cb82-19" data-line-number="19">         &lt;&lt; endl;</a>
<a class="sourceLine" id="cb82-20" data-line-number="20">    <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb82-21" data-line-number="21">}</a></code></pre></div>
<p>C++ lo hace mucho mejor que C en este aspecto. Pero para funciones más complejas la sintaxis puede ser difícil de entender: Mira <a href="http://bartoszmilewski.com/2009/10/21/what-does-haskell-have-to-do-with-c/">este artículo</a> por ejemplo.</p>
<p>En C++ se debe declarar que la función puede trabajar con distintos tipos. En Haskell, es lo opuesto. La función será lo más general posible por defecto.</p>
<p>La inferencia de tipos le da a Haskell la sensación de libertad de los lenguajes de tipado dinámico. Pero a diferencia de estos, la mayoría de los errores se encuentra antes de la ejecución. Generalmente, en Haskell:</p>
<blockquote>
<p>“Si compila entonces hace lo que quieres que haga”</p>
</blockquote>
<h3 id="construcción-de-tipos">Construcción de tipos</h3>
<p>Es posible construir tipos propios. Primero, se pueden usar alias o sinónimos de tipos.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb83-1" data-line-number="1"><span class="kw">type</span> <span class="dt">Name</span>   <span class="fu">=</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb83-2" data-line-number="2"><span class="kw">type</span> <span class="dt">Color</span>  <span class="fu">=</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb83-3" data-line-number="3"></a>
<a class="sourceLine" id="cb83-4" data-line-number="4"><span class="ot">showInfos ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span>  <span class="dt">Color</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb83-5" data-line-number="5">showInfos name color <span class="fu">=</span>  <span class="st">&quot;Name: &quot;</span> <span class="fu">++</span> name</a>
<a class="sourceLine" id="cb83-6" data-line-number="6">                        <span class="fu">++</span> <span class="st">&quot;, Color: &quot;</span> <span class="fu">++</span> color</a>
<a class="sourceLine" id="cb83-7" data-line-number="7"><span class="ot">name ::</span> <span class="dt">Name</span></a>
<a class="sourceLine" id="cb83-8" data-line-number="8">name <span class="fu">=</span> <span class="st">&quot;Robin&quot;</span></a>
<a class="sourceLine" id="cb83-9" data-line-number="9"><span class="ot">color ::</span> <span class="dt">Color</span></a>
<a class="sourceLine" id="cb83-10" data-line-number="10">color <span class="fu">=</span> <span class="st">&quot;Blue&quot;</span></a>
<a class="sourceLine" id="cb83-11" data-line-number="11">main <span class="fu">=</span> putStrLn <span class="fu">$</span> showInfos name color</a></code></pre></div>
<p>Pero esto no te protege mucho. Intenta intercambiar los dos parámetros de <code>showInfos</code> y ejecuta el programa:</p>
<pre><code>putStrLn $ showInfos color name</code></pre>
<p>Se compilará y ejecutará. De hecho se pueden reemplazar <code>Name</code>, <code>Color</code> y <code>String</code> con cualquier cosa. El compilador los tratará como si fueran idénticos.</p>
<p>Otro método es crear tus propios tipos usando la palabra reservada <code>data</code>.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb85-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Name</span>   <span class="fu">=</span> <span class="dt">NameConstr</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2"><span class="kw">data</span> <span class="dt">Color</span>  <span class="fu">=</span> <span class="dt">ColorConstr</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb85-3" data-line-number="3"></a>
<a class="sourceLine" id="cb85-4" data-line-number="4"><span class="ot">showInfos ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span>  <span class="dt">Color</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb85-5" data-line-number="5">showInfos (<span class="dt">NameConstr</span> name) (<span class="dt">ColorConstr</span> color) <span class="fu">=</span></a>
<a class="sourceLine" id="cb85-6" data-line-number="6">      <span class="st">&quot;Name: &quot;</span> <span class="fu">++</span> name <span class="fu">++</span> <span class="st">&quot;, Color: &quot;</span> <span class="fu">++</span> color</a>
<a class="sourceLine" id="cb85-7" data-line-number="7"></a>
<a class="sourceLine" id="cb85-8" data-line-number="8">name  <span class="fu">=</span> <span class="dt">NameConstr</span> <span class="st">&quot;Robin&quot;</span></a>
<a class="sourceLine" id="cb85-9" data-line-number="9">color <span class="fu">=</span> <span class="dt">ColorConstr</span> <span class="st">&quot;Blue&quot;</span></a>
<a class="sourceLine" id="cb85-10" data-line-number="10">main <span class="fu">=</span> putStrLn <span class="fu">$</span> showInfos name color</a></code></pre></div>
<p>Ahora si intercambias los parámetros de <code>showInfos</code>, el compilador se queja! De forma que nunca más podrás cometer un error de ese tipo y el único precio es ser un poco más explicito.</p>
<p>También nota que los constructores son funciones:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb86-1" data-line-number="1"><span class="dt">NameConstr</span><span class="ot">  ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Name</span></a>
<a class="sourceLine" id="cb86-2" data-line-number="2"><span class="dt">ColorConstr</span><span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Color</span></a></code></pre></div>
<p>La sintaxis de <code>data</code> es principalmente:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb87-1" data-line-number="1"><span class="kw">data</span> <span class="dt">TypeName</span> <span class="fu">=</span>   <span class="dt">ConstructorName</span>  [types]</a>
<a class="sourceLine" id="cb87-2" data-line-number="2">                <span class="fu">|</span> <span class="dt">ConstructorName2</span> [types]</a>
<a class="sourceLine" id="cb87-3" data-line-number="3">                <span class="fu">|</span> <span class="fu">...</span></a></code></pre></div>
<p>Generalmente se usa el mismo nombre para el <code>DataTypeName</code> y para el <code>DataTypeConstructor</code>.</p>
<p>Ejemplo:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb88-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Complex</span> a <span class="fu">=</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> <span class="dt">Complex</span> a a</a></code></pre></div>
<p>También se puede usar sintaxis record:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb89-1" data-line-number="1"><span class="kw">data</span> <span class="dt">DataTypeName</span> <span class="fu">=</span> <span class="dt">DataConstructor</span> {</a>
<a class="sourceLine" id="cb89-2" data-line-number="2"><span class="ot">                      field1 ::</span> [<span class="kw">type</span> <span class="kw">of</span> field1]</a>
<a class="sourceLine" id="cb89-3" data-line-number="3">                    ,<span class="ot"> field2 ::</span> [<span class="kw">type</span> <span class="kw">of</span> field2]</a>
<a class="sourceLine" id="cb89-4" data-line-number="4">                    <span class="fu">...</span></a>
<a class="sourceLine" id="cb89-5" data-line-number="5">                    ,<span class="ot"> fieldn ::</span> [<span class="kw">type</span> <span class="kw">of</span> fieldn] }</a></code></pre></div>
<p>Y hay varios accesores disponibles. Además se puede usar otro orden cuando se asignen valores.</p>
<p>Ejemplo:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb90-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Complex</span> a <span class="fu">=</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> <span class="dt">Complex</span> {<span class="ot"> real ::</span> a,<span class="ot"> img ::</span> a}</a>
<a class="sourceLine" id="cb90-2" data-line-number="2">c <span class="fu">=</span> <span class="dt">Complex</span> <span class="fl">1.0</span> <span class="fl">2.0</span></a>
<a class="sourceLine" id="cb90-3" data-line-number="3">z <span class="fu">=</span> <span class="dt">Complex</span> { real <span class="fu">=</span> <span class="dv">3</span>, img <span class="fu">=</span> <span class="dv">4</span> }</a>
<a class="sourceLine" id="cb90-4" data-line-number="4">real c <span class="ot">⇒</span> <span class="fl">1.0</span></a>
<a class="sourceLine" id="cb90-5" data-line-number="5">img z <span class="ot">⇒</span> <span class="dv">4</span></a></code></pre></div>
<h3 id="tipos-recursivos">Tipos recursivos</h3>
<p>Ya nos hemos topado con un tipo recursivo: listas. Se pueden re-crear listas, pero con una sintaxis más explicita:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="kw">data</span> <span class="dt">List</span> a <span class="fu">=</span> <span class="dt">Empty</span> <span class="fu">|</span> <span class="dt">Cons</span> a (<span class="dt">List</span> a)</a></code></pre></div>
<p>Si prefieres usar una sintaxis más simple, se puede usar un nombre infijo para los constructores.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="kw">infixr</span> <span class="dv">5</span> <span class="ot">::</span><span class="fu">:</span></a>
<a class="sourceLine" id="cb92-2" data-line-number="2"><span class="kw">data</span> <span class="dt">List</span> a <span class="fu">=</span> <span class="dt">Nil</span> <span class="fu">|</span> a <span class="ot">::</span><span class="fu">:</span> (<span class="dt">List</span> a)</a></code></pre></div>
<p>El numero luego de <code>infixr</code> le da la precedencia.</p>
<p>Si quieres poder imprimir por pantalla (<code>Show</code>), leer (<code>Read</code>), probar igualdad (<code>Eq</code>) y comparar (<code>Ord</code>) con tu nueva estructura de datos puedes pedirle a Haskell que derive las funciones apropiadas por ti.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="kw">infixr</span> <span class="dv">5</span> <span class="ot">::</span><span class="fu">:</span></a>
<a class="sourceLine" id="cb93-2" data-line-number="2"><span class="kw">data</span> <span class="dt">List</span> a <span class="fu">=</span> <span class="dt">Nil</span> <span class="fu">|</span> a <span class="ot">::</span><span class="fu">:</span> (<span class="dt">List</span> a)</a>
<a class="sourceLine" id="cb93-3" data-line-number="3">              <span class="kw">deriving</span> (<span class="dt">Show</span>,<span class="dt">Read</span>,<span class="dt">Eq</span>,<span class="dt">Ord</span>)</a></code></pre></div>
<p>Cuando añades <code>deriving (Show)</code> a tu declaración de datos, Haskell crea una función <code>show</code> por ti. Ya veremos como se puede usar una función <code>show</code> propia.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb94-1" data-line-number="1">convertList [] <span class="fu">=</span> <span class="dt">Nil</span></a>
<a class="sourceLine" id="cb94-2" data-line-number="2">convertList (x<span class="fu">:</span>xs) <span class="fu">=</span> x <span class="ot">::</span><span class="fu">:</span> convertList xs</a></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb95-1" data-line-number="1">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb95-2" data-line-number="2">      print (<span class="dv">0</span> <span class="ot">::</span><span class="fu">:</span> <span class="dv">1</span> <span class="ot">::</span><span class="fu">:</span> <span class="dt">Nil</span>)</a>
<a class="sourceLine" id="cb95-3" data-line-number="3">      print (convertList [<span class="dv">0</span>,<span class="dv">1</span>])</a></code></pre></div>
<p>Esto imprime:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb96-1" data-line-number="1"><span class="dv">0</span> <span class="ot">::</span><span class="fu">:</span> (<span class="dv">1</span> <span class="ot">::</span><span class="fu">:</span> <span class="dt">Nil</span>)</a>
<a class="sourceLine" id="cb96-2" data-line-number="2"><span class="dv">0</span> <span class="ot">::</span><span class="fu">:</span> (<span class="dv">1</span> <span class="ot">::</span><span class="fu">:</span> <span class="dt">Nil</span>)</a></code></pre></div>
<h3 id="arboles">Arboles</h3>
<p><img src="/img/haskellhard/shot8.jpg" class="img-responsive" /><br />
</p>
<p>Otro ejemplo estándar: arboles binarios.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb97-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Data.List</span></a>
<a class="sourceLine" id="cb97-2" data-line-number="2"></a>
<a class="sourceLine" id="cb97-3" data-line-number="3"><span class="kw">data</span> <span class="dt">BinTree</span> a <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb97-4" data-line-number="4">                 <span class="fu">|</span> <span class="dt">Node</span> a (<span class="dt">BinTree</span> a) (<span class="dt">BinTree</span> a)</a>
<a class="sourceLine" id="cb97-5" data-line-number="5">                              <span class="kw">deriving</span> (<span class="dt">Show</span>)</a></code></pre></div>
<p>También crearemos una función que convierta una lista en un árbol binario ordenado.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb98-1" data-line-number="1"><span class="ot">treeFromList ::</span> (<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">BinTree</span> a</a>
<a class="sourceLine" id="cb98-2" data-line-number="2">treeFromList [] <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb98-3" data-line-number="3">treeFromList (x<span class="fu">:</span>xs) <span class="fu">=</span> <span class="dt">Node</span> x (treeFromList (filter (<span class="fu">&lt;</span>x) xs))</a>
<a class="sourceLine" id="cb98-4" data-line-number="4">                             (treeFromList (filter (<span class="fu">&gt;</span>x) xs))</a></code></pre></div>
<p>Observa cuan elegante es esta función.</p>
<ul>
<li>Una lista vacía será convertida en un árbol vació.</li>
<li>Una lista <code>(x:xs)</code> será convertida en un árbol donde: ** La raíz es <code>x</code> ** El sub-árbol de la izquierda es el árbol creado de los miembros de la lista ** <code>xs</code> que son menores a <code>x</code> y ** El sub-árbol de la derecha es el árbol creado de los miembros de la lista <code>xs</code> ** que son mayores que <code>x</code>.</li>
</ul>
<div class="sourceCode" id="cb99"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb99-1" data-line-number="1">main <span class="fu">=</span> print <span class="fu">$</span> treeFromList [<span class="dv">7</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>]</a></code></pre></div>
<p>Deberías obtener lo siguiente:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb100-1" data-line-number="1"><span class="dt">Node</span> <span class="dv">7</span> (<span class="dt">Node</span> <span class="dv">2</span> <span class="dt">Empty</span> (<span class="dt">Node</span> <span class="dv">4</span> <span class="dt">Empty</span> <span class="dt">Empty</span>)) (<span class="dt">Node</span> <span class="dv">8</span> <span class="dt">Empty</span> <span class="dt">Empty</span>)</a></code></pre></div>
<p>Esta es una forma informativa pero no muy agradable de nuestro árbol.</p>
<p>Solo por diversión, hagamos que nuestros arboles se visualicen de una mejor forma. Simplemente resulta divertido hacer una función para mostrar arboles en una forma general. Puedes saltarte esta parta si te parece muy difícil.</p>
<p>Tenemos unos cuantos cambios que hacer. Remover el <code>deriving (Show)</code> de la declaración del tipo <code>BinTree</code>. Y también sería útil hacer nuestras propias infancias de (<code>Eq</code> y <code>Ord</code>) de forma que podamos probar igualdad y comprar arboles.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb101-1" data-line-number="1"><span class="kw">data</span> <span class="dt">BinTree</span> a <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb101-2" data-line-number="2">                 <span class="fu">|</span> <span class="dt">Node</span> a (<span class="dt">BinTree</span> a) (<span class="dt">BinTree</span> a)</a>
<a class="sourceLine" id="cb101-3" data-line-number="3">                  <span class="kw">deriving</span> (<span class="dt">Eq</span>,<span class="dt">Ord</span>)</a></code></pre></div>
<p>Sin el <code>deriving (Show)</code>, Haskell no creará una función <code>show</code> por nosotros. Crearemos nuestra propia versión de <code>show</code>. Para lograrlo, debemos declarar que nuestro nuevo tipo <code>BinTree a</code> es una instancia de la clase de tipo <code>Show</code>. La sintaxis general es:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb102-1" data-line-number="1"><span class="kw">instance</span> <span class="dt">Show</span> (<span class="dt">BinTree</span> a) <span class="kw">where</span></a>
<a class="sourceLine" id="cb102-2" data-line-number="2">   show t <span class="fu">=</span> <span class="fu">...</span> <span class="co">-- You declare your function here</span></a></code></pre></div>
<p>Aquí está mi versión de como mostrar un árbol binario. No te preocupes de la aparente complejidad. Hice un montón de mejoras para mostrar incluso objetos extraños.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb103-1" data-line-number="1"><span class="co">-- declare BinTree a to be an instance of Show</span></a>
<a class="sourceLine" id="cb103-2" data-line-number="2"><span class="kw">instance</span> (<span class="dt">Show</span> a) <span class="ot">=&gt;</span> <span class="dt">Show</span> (<span class="dt">BinTree</span> a) <span class="kw">where</span></a>
<a class="sourceLine" id="cb103-3" data-line-number="3">  <span class="co">-- will start by a &#39;&lt;&#39; before the root</span></a>
<a class="sourceLine" id="cb103-4" data-line-number="4">  <span class="co">-- and put a : a begining of line</span></a>
<a class="sourceLine" id="cb103-5" data-line-number="5">  show t <span class="fu">=</span> <span class="st">&quot;&lt; &quot;</span> <span class="fu">++</span> replace <span class="ch">&#39;\n&#39;</span> <span class="st">&quot;\n: &quot;</span> (treeshow <span class="st">&quot;&quot;</span> t)</a>
<a class="sourceLine" id="cb103-6" data-line-number="6">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb103-7" data-line-number="7">    <span class="co">-- treeshow pref Tree</span></a>
<a class="sourceLine" id="cb103-8" data-line-number="8">    <span class="co">--   shows a tree and starts each line with pref</span></a>
<a class="sourceLine" id="cb103-9" data-line-number="9">    <span class="co">-- We don&#39;t display the Empty tree</span></a>
<a class="sourceLine" id="cb103-10" data-line-number="10">    treeshow pref <span class="dt">Empty</span> <span class="fu">=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb103-11" data-line-number="11">    <span class="co">-- Leaf</span></a>
<a class="sourceLine" id="cb103-12" data-line-number="12">    treeshow pref (<span class="dt">Node</span> x <span class="dt">Empty</span> <span class="dt">Empty</span>) <span class="fu">=</span></a>
<a class="sourceLine" id="cb103-13" data-line-number="13">                  (pshow pref x)</a>
<a class="sourceLine" id="cb103-14" data-line-number="14"></a>
<a class="sourceLine" id="cb103-15" data-line-number="15">    <span class="co">-- Right branch is empty</span></a>
<a class="sourceLine" id="cb103-16" data-line-number="16">    treeshow pref (<span class="dt">Node</span> x left <span class="dt">Empty</span>) <span class="fu">=</span></a>
<a class="sourceLine" id="cb103-17" data-line-number="17">                  (pshow pref x) <span class="fu">++</span> <span class="st">&quot;\n&quot;</span> <span class="fu">++</span></a>
<a class="sourceLine" id="cb103-18" data-line-number="18">                  (showSon pref <span class="st">&quot;`--&quot;</span> <span class="st">&quot;   &quot;</span> left)</a>
<a class="sourceLine" id="cb103-19" data-line-number="19"></a>
<a class="sourceLine" id="cb103-20" data-line-number="20">    <span class="co">-- Left branch is empty</span></a>
<a class="sourceLine" id="cb103-21" data-line-number="21">    treeshow pref (<span class="dt">Node</span> x <span class="dt">Empty</span> right) <span class="fu">=</span></a>
<a class="sourceLine" id="cb103-22" data-line-number="22">                  (pshow pref x) <span class="fu">++</span> <span class="st">&quot;\n&quot;</span> <span class="fu">++</span></a>
<a class="sourceLine" id="cb103-23" data-line-number="23">                  (showSon pref <span class="st">&quot;`--&quot;</span> <span class="st">&quot;   &quot;</span> right)</a>
<a class="sourceLine" id="cb103-24" data-line-number="24"></a>
<a class="sourceLine" id="cb103-25" data-line-number="25">    <span class="co">-- Tree with left and right children non empty</span></a>
<a class="sourceLine" id="cb103-26" data-line-number="26">    treeshow pref (<span class="dt">Node</span> x left right) <span class="fu">=</span></a>
<a class="sourceLine" id="cb103-27" data-line-number="27">                  (pshow pref x) <span class="fu">++</span> <span class="st">&quot;\n&quot;</span> <span class="fu">++</span></a>
<a class="sourceLine" id="cb103-28" data-line-number="28">                  (showSon pref <span class="st">&quot;|--&quot;</span> <span class="st">&quot;|  &quot;</span> left) <span class="fu">++</span> <span class="st">&quot;\n&quot;</span> <span class="fu">++</span></a>
<a class="sourceLine" id="cb103-29" data-line-number="29">                  (showSon pref <span class="st">&quot;`--&quot;</span> <span class="st">&quot;   &quot;</span> right)</a>
<a class="sourceLine" id="cb103-30" data-line-number="30"></a>
<a class="sourceLine" id="cb103-31" data-line-number="31">    <span class="co">-- shows a tree using some prefixes to make it nice</span></a>
<a class="sourceLine" id="cb103-32" data-line-number="32">    showSon pref before next t <span class="fu">=</span></a>
<a class="sourceLine" id="cb103-33" data-line-number="33">                  pref <span class="fu">++</span> before <span class="fu">++</span> treeshow (pref <span class="fu">++</span> next) t</a>
<a class="sourceLine" id="cb103-34" data-line-number="34"></a>
<a class="sourceLine" id="cb103-35" data-line-number="35">    <span class="co">-- pshow replaces &quot;\n&quot; by &quot;\n&quot;++pref</span></a>
<a class="sourceLine" id="cb103-36" data-line-number="36">    pshow pref x <span class="fu">=</span> replace <span class="ch">&#39;\n&#39;</span> (<span class="st">&quot;\n&quot;</span><span class="fu">++</span>pref) (show x)</a>
<a class="sourceLine" id="cb103-37" data-line-number="37"></a>
<a class="sourceLine" id="cb103-38" data-line-number="38">    <span class="co">-- replaces one char by another string</span></a>
<a class="sourceLine" id="cb103-39" data-line-number="39">    replace c new string <span class="fu">=</span></a>
<a class="sourceLine" id="cb103-40" data-line-number="40">      concatMap (change c new) string</a>
<a class="sourceLine" id="cb103-41" data-line-number="41">      <span class="kw">where</span></a>
<a class="sourceLine" id="cb103-42" data-line-number="42">          change c new x</a>
<a class="sourceLine" id="cb103-43" data-line-number="43">              <span class="fu">|</span> x <span class="fu">==</span> c <span class="fu">=</span> new</a>
<a class="sourceLine" id="cb103-44" data-line-number="44">              <span class="fu">|</span> otherwise <span class="fu">=</span> x<span class="fu">:</span>[] <span class="co">-- &quot;x&quot;</span></a></code></pre></div>
<p>El método <code>treeFromList</code> permanece idéntico.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb104-1" data-line-number="1"><span class="ot">treeFromList ::</span> (<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">BinTree</span> a</a>
<a class="sourceLine" id="cb104-2" data-line-number="2">treeFromList [] <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb104-3" data-line-number="3">treeFromList (x<span class="fu">:</span>xs) <span class="fu">=</span> <span class="dt">Node</span> x (treeFromList (filter (<span class="fu">&lt;</span>x) xs))</a>
<a class="sourceLine" id="cb104-4" data-line-number="4">                             (treeFromList (filter (<span class="fu">&gt;</span>x) xs))</a></code></pre></div>
<p>Y ahora, podemos jugar:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb105-1" data-line-number="1">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb105-2" data-line-number="2">  putStrLn <span class="st">&quot;Int binary tree:&quot;</span></a>
<a class="sourceLine" id="cb105-3" data-line-number="3">  print <span class="fu">$</span> treeFromList [<span class="dv">7</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">6</span>,<span class="dv">21</span>,<span class="dv">12</span>,<span class="dv">23</span>]</a></code></pre></div>
<pre><code>Int binary tree:
&lt; 7
: |--2
: |  |--1
: |  `--4
: |     |--3
: |     `--6
: `--8
:    `--21
:       |--12
:       `--23</code></pre>
<p>Ahora es mucho mejor! La raíz se muestra iniciando la linea con <code>&lt;</code>. Y cada linea que le sigue inicia con <code>:</code>. Pero también podríamos usar otro tipo.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb107-1" data-line-number="1">putStrLn <span class="st">&quot;\nString binary tree:&quot;</span></a>
<a class="sourceLine" id="cb107-2" data-line-number="2">print <span class="fu">$</span> treeFromList [<span class="st">&quot;foo&quot;</span>,<span class="st">&quot;bar&quot;</span>,<span class="st">&quot;baz&quot;</span>,<span class="st">&quot;gor&quot;</span>,<span class="st">&quot;yog&quot;</span>]</a></code></pre></div>
<pre><code>String binary tree:
&lt; &quot;foo&quot;
: |--&quot;bar&quot;
: |  `--&quot;baz&quot;
: `--&quot;gor&quot;
:    `--&quot;yog&quot;</code></pre>
<p>Como podemos probar igualdad y ordenar arboles, podemos hacer arboles de arboles!</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb109-1" data-line-number="1">putStrLn <span class="st">&quot;\nBinary tree of Char binary trees:&quot;</span></a>
<a class="sourceLine" id="cb109-2" data-line-number="2">print ( treeFromList</a>
<a class="sourceLine" id="cb109-3" data-line-number="3">        (map treeFromList [<span class="st">&quot;baz&quot;</span>,<span class="st">&quot;zara&quot;</span>,<span class="st">&quot;bar&quot;</span>]))</a></code></pre></div>
<pre><code>Binary tree of Char binary trees:
&lt; &lt; &#39;b&#39;
: : |--&#39;a&#39;
: : `--&#39;z&#39;
: |--&lt; &#39;b&#39;
: |  : |--&#39;a&#39;
: |  : `--&#39;r&#39;
: `--&lt; &#39;z&#39;
:    : `--&#39;a&#39;
:    :    `--&#39;r&#39;</code></pre>
<p>Por eso elegí poner un <code>:</code> en cada linea del árbol (excepto en la raíz).</p>
<p><img src="/img/haskellhard/shot9.jpg" class="img-responsive" /><br />
</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb111-1" data-line-number="1">putStrLn <span class="st">&quot;\nTree of Binary trees of Char binary trees:&quot;</span></a>
<a class="sourceLine" id="cb111-2" data-line-number="2">print <span class="fu">$</span> (treeFromList <span class="fu">.</span> map (treeFromList <span class="fu">.</span> map treeFromList))</a>
<a class="sourceLine" id="cb111-3" data-line-number="3">            [ [<span class="st">&quot;YO&quot;</span>,<span class="st">&quot;DAWG&quot;</span>]</a>
<a class="sourceLine" id="cb111-4" data-line-number="4">            , [<span class="st">&quot;I&quot;</span>,<span class="st">&quot;HEARD&quot;</span>]</a>
<a class="sourceLine" id="cb111-5" data-line-number="5">            , [<span class="st">&quot;I&quot;</span>,<span class="st">&quot;HEARD&quot;</span>]</a>
<a class="sourceLine" id="cb111-6" data-line-number="6">            , [<span class="st">&quot;YOU&quot;</span>,<span class="st">&quot;LIKE&quot;</span>,<span class="st">&quot;TREES&quot;</span>] ]</a></code></pre></div>
<p>Que es equivalente a</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb112-1" data-line-number="1">print ( treeFromList (</a>
<a class="sourceLine" id="cb112-2" data-line-number="2">          map treeFromList</a>
<a class="sourceLine" id="cb112-3" data-line-number="3">             [ map treeFromList [<span class="st">&quot;YO&quot;</span>,<span class="st">&quot;DAWG&quot;</span>]</a>
<a class="sourceLine" id="cb112-4" data-line-number="4">             , map treeFromList [<span class="st">&quot;I&quot;</span>,<span class="st">&quot;HEARD&quot;</span>]</a>
<a class="sourceLine" id="cb112-5" data-line-number="5">             , map treeFromList [<span class="st">&quot;I&quot;</span>,<span class="st">&quot;HEARD&quot;</span>]</a>
<a class="sourceLine" id="cb112-6" data-line-number="6">             , map treeFromList [<span class="st">&quot;YOU&quot;</span>,<span class="st">&quot;LIKE&quot;</span>,<span class="st">&quot;TREES&quot;</span>] ]))</a></code></pre></div>
<p>Y produce:</p>
<pre><code>Binary tree of Binary trees of Char binary trees:
&lt; &lt; &lt; &#39;Y&#39;
: : : `--&#39;O&#39;
: : `--&lt; &#39;D&#39;
: :    : |--&#39;A&#39;
: :    : `--&#39;W&#39;
: :    :    `--&#39;G&#39;
: |--&lt; &lt; &#39;I&#39;
: |  : `--&lt; &#39;H&#39;
: |  :    : |--&#39;E&#39;
: |  :    : |  `--&#39;A&#39;
: |  :    : |     `--&#39;D&#39;
: |  :    : `--&#39;R&#39;
: `--&lt; &lt; &#39;Y&#39;
:    : : `--&#39;O&#39;
:    : :    `--&#39;U&#39;
:    : `--&lt; &#39;L&#39;
:    :    : `--&#39;I&#39;
:    :    :    |--&#39;E&#39;
:    :    :    `--&#39;K&#39;
:    :    `--&lt; &#39;T&#39;
:    :       : `--&#39;R&#39;
:    :       :    |--&#39;E&#39;
:    :       :    `--&#39;S&#39;</code></pre>
<p>Nota como arboles duplicados no son insertados; solo hay un árbol correspondiente a <code>&quot;I&quot;, &quot;HEARD&quot;</code>. Podemos tener esto (casi) gratuitamente, por que hemos declarado que el tipo árbol es una instancia de <code>Eq</code>.</p>
<p>Mira cuan genial es esta estructura: Podemos hacer arboles que contienen no solo enteros, cadenas y caracteres, sino también arboles. Y podemos incluso hacer un árbol que contenga arboles de arboles!</p>
<h2 id="estructuras-infinitas">Estructuras infinitas</h2>
<p><img src="/img/haskellhard/shot10.jpg" class="img-responsive" /><br />
</p>
<p>Es común escuchar que Haskell es perezoso.</p>
<p>De hecho, si se es un poco pedante, se debería decir que <a href="http://www.haskell.org/haskellwiki/Lazy_vs._non-strict">Haskell es no-estricto.</a>. Pereza es solo una implementación común de lenguajes no-estrictos.</p>
<p>¿Pero qué significa “no-estricto”? Desde la wiki de Haskell:</p>
<pre><code>Reduction (the mathematical term for evaluation) proceeds from the outside in.

so if you have (a+(b*c)) then you first reduce + first, then you reduce the inner (b*c)</code></pre>
<p>Por ejemplo en Haskell se puede hacer:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb115-1" data-line-number="1"><span class="co">-- numbers = [1,2,..]</span></a>
<a class="sourceLine" id="cb115-2" data-line-number="2"><span class="ot">numbers ::</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb115-3" data-line-number="3">numbers <span class="fu">=</span> <span class="dv">0</span><span class="fu">:</span>map (<span class="dv">1</span><span class="fu">+</span>) numbers</a>
<a class="sourceLine" id="cb115-4" data-line-number="4"></a>
<a class="sourceLine" id="cb115-5" data-line-number="5">take&#39; n [] <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb115-6" data-line-number="6">take&#39; <span class="dv">0</span> l <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb115-7" data-line-number="7">take&#39; n (x<span class="fu">:</span>xs) <span class="fu">=</span> x<span class="fu">:</span>take&#39; (n<span class="fu">-</span><span class="dv">1</span>) xs</a>
<a class="sourceLine" id="cb115-8" data-line-number="8"></a>
<a class="sourceLine" id="cb115-9" data-line-number="9">main <span class="fu">=</span> print <span class="fu">$</span> take&#39; <span class="dv">10</span> numbers</a></code></pre></div>
<p>Y se detiene.</p>
<p>¿Cómo?</p>
<p>En lugar de intentar evaluar <code>numbers</code> por completo, evalúa los elementos solo cunado se los necesita.</p>
<p>También, nótese que en Haskell hay una notación para listas infinitas.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb116-1" data-line-number="1">[<span class="dv">1</span><span class="fu">..</span>]   ⇔ [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span><span class="fu">...</span>]</a>
<a class="sourceLine" id="cb116-2" data-line-number="2">[<span class="dv">1</span>,<span class="dv">3</span><span class="fu">..</span>] ⇔ [<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">9</span>,<span class="dv">11</span><span class="fu">...</span>]</a></code></pre></div>
<p>Y la mayoría de las funciones funcionarán con ellas. También, hay una función <code>take</code> que es equivalente a nuestro <code>take'</code></p>
<p>Supón que queremos un árbol ordenado binario. Aquí hay una árbol binario infinito.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb117-1" data-line-number="1">nullTree <span class="fu">=</span> <span class="dt">Node</span> <span class="dv">0</span> nullTree nullTree</a></code></pre></div>
<p>Un árbol binario completo donde cada nodo es iguala a 0. Ahora probaré que se puede manipular este objeto usando la siguiente función:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb118-1" data-line-number="1"><span class="co">-- take all element of a BinTree</span></a>
<a class="sourceLine" id="cb118-2" data-line-number="2"><span class="co">-- up to some depth</span></a>
<a class="sourceLine" id="cb118-3" data-line-number="3">treeTakeDepth _ <span class="dt">Empty</span> <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb118-4" data-line-number="4">treeTakeDepth <span class="dv">0</span> _     <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb118-5" data-line-number="5">treeTakeDepth n (<span class="dt">Node</span> x left right) <span class="fu">=</span> <span class="kw">let</span></a>
<a class="sourceLine" id="cb118-6" data-line-number="6">          nl <span class="fu">=</span> treeTakeDepth (n<span class="fu">-</span><span class="dv">1</span>) left</a>
<a class="sourceLine" id="cb118-7" data-line-number="7">          nr <span class="fu">=</span> treeTakeDepth (n<span class="fu">-</span><span class="dv">1</span>) right</a>
<a class="sourceLine" id="cb118-8" data-line-number="8">          <span class="kw">in</span></a>
<a class="sourceLine" id="cb118-9" data-line-number="9">              <span class="dt">Node</span> x nl nr</a></code></pre></div>
<p>Mira lo que ocurre con este programa:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb119-1" data-line-number="1">main <span class="fu">=</span> print <span class="fu">$</span> treeTakeDepth <span class="dv">4</span> nullTree</a></code></pre></div>
<p>Este código compila, se ejecuta y se detiene dando el siguiente resultado:</p>
<pre><code>&lt;  0
: |-- 0
: |  |-- 0
: |  |  |-- 0
: |  |  `-- 0
: |  `-- 0
: |     |-- 0
: |     `-- 0
: `-- 0
:    |-- 0
:    |  |-- 0
:    |  `-- 0
:    `-- 0
:       |-- 0
:       `-- 0</code></pre>
<p>Solo para calentar tus neuronas, hagamos un árbol más interesante:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb121-1" data-line-number="1">iTree <span class="fu">=</span> <span class="dt">Node</span> <span class="dv">0</span> (dec iTree) (inc iTree)</a>
<a class="sourceLine" id="cb121-2" data-line-number="2">        <span class="kw">where</span></a>
<a class="sourceLine" id="cb121-3" data-line-number="3">           dec (<span class="dt">Node</span> x l r) <span class="fu">=</span> <span class="dt">Node</span> (x<span class="fu">-</span><span class="dv">1</span>) (dec l) (dec r)</a>
<a class="sourceLine" id="cb121-4" data-line-number="4">           inc (<span class="dt">Node</span> x l r) <span class="fu">=</span> <span class="dt">Node</span> (x<span class="fu">+</span><span class="dv">1</span>) (inc l) (inc r)</a></code></pre></div>
<p>Otra forma de crear ese árbol es usar una función de orden superior. Esta función debería ser similar a <code>map</code>, pero debería funcionar en <code>BinTree</code> en lugar de una lista. Aquí está la función:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb122-1" data-line-number="1"><span class="co">-- apply a function to each node of Tree</span></a>
<a class="sourceLine" id="cb122-2" data-line-number="2"><span class="ot">treeMap ::</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">BinTree</span> a <span class="ot">-&gt;</span> <span class="dt">BinTree</span> b</a>
<a class="sourceLine" id="cb122-3" data-line-number="3">treeMap f <span class="dt">Empty</span> <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb122-4" data-line-number="4">treeMap f (<span class="dt">Node</span> x left right) <span class="fu">=</span> <span class="dt">Node</span> (f x)</a>
<a class="sourceLine" id="cb122-5" data-line-number="5">                                     (treeMap f left)</a>
<a class="sourceLine" id="cb122-6" data-line-number="6">                                     (treeMap f right)</a></code></pre></div>
<p>Nota: No hablaré más de esto aquí. Si estas interesado en la generalización de <code>map</code> a otras estructuras de datos, busca <em>functor</em> y <code>fmap</code>.</p>
<p>Nuestra definición es ahora:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb123-1" data-line-number="1"><span class="ot">infTreeTwo ::</span> <span class="dt">BinTree</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb123-2" data-line-number="2">infTreeTwo <span class="fu">=</span> <span class="dt">Node</span> <span class="dv">0</span> (treeMap (\x <span class="ot">-&gt;</span> x<span class="fu">-</span><span class="dv">1</span>) infTreeTwo)</a>
<a class="sourceLine" id="cb123-3" data-line-number="3">                    (treeMap (\x <span class="ot">-&gt;</span> x<span class="fu">+</span><span class="dv">1</span>) infTreeTwo)</a></code></pre></div>
<p>Observa el resultado de</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb124-1" data-line-number="1">main <span class="fu">=</span> print <span class="fu">$</span> treeTakeDepth <span class="dv">4</span> infTreeTwo</a></code></pre></div>
<pre><code>&lt;  0
: |-- -1
: |  |-- -2
: |  |  |-- -3
: |  |  `-- -1
: |  `-- 0
: |     |-- -1
: |     `-- 1
: `-- 1
:    |-- 0
:    |  |-- -1
:    |  `-- 1
:    `-- 2
:       |-- 1
:       `-- 3</code></pre>
<h1 id="parte-infernalmente-difícil">Parte infernalmente difícil</h1>
<p>Felicitaciones por llegar tan lejos! Ahora, algunas de las cosas realmente difíciles pueden empezar.</p>
<p>Si eres como yo, ya deberías comprender el estilo funcional. También deberías entender un poco más de las ventajas de la <em>pereza</em> (Laziness) por defecto. Pero también deberías NO comprender aún como empezar a escribir un programa real. Y en particular:</p>
<ul>
<li>¿Cómo se lidia con los efectos?</li>
<li>¿Por qué hay una notación extraña parecida a la imperativa para lidiar con Entrada/Salida (IO)?</li>
</ul>
<p>Prepárate, las respuestas pueden ser complejas. Pero son realmente gratificantes.</p>
<h2 id="lidiando-con-io-entradasalida">Lidiando con IO (Entrada/Salida)</h2>
<p><img src="/img/haskellhard/shot11.jpg" class="img-responsive" /><br />
</p>
<p><em>TL;DR</em>:</p>
<p>Una función típica haciendo IO es muy parecida a un programa imperativo:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb126-1" data-line-number="1"><span class="ot">f ::</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb126-2" data-line-number="2">f <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb126-3" data-line-number="3">  x <span class="ot">&lt;-</span> action1</a>
<a class="sourceLine" id="cb126-4" data-line-number="4">  action2 x</a>
<a class="sourceLine" id="cb126-5" data-line-number="5">  y <span class="ot">&lt;-</span> action3</a>
<a class="sourceLine" id="cb126-6" data-line-number="6">  action4 x y</a></code></pre></div>
<ul>
<li>Para asignar un valor a un objeto se usa <code>&lt;-</code>.</li>
<li>El tipo de cada linea es <code>IO *</code>; en este ejemplo:</li>
<li><code>action1 :: IO b</code></li>
<li><code>action2 x :: IO ()</code></li>
<li><code>action3 :: IO c</code></li>
<li><code>action4 x y :: IO a</code></li>
<li><code>x :: b</code>, <code>y :: c</code></li>
<li>Algunos objetos tienen el tipo <code>IO a</code>, esto debería ayudar a elegir. En particular no se deberían usar funciones puras aquí. Para usar funciones se puede hacer <code>action2 (purefunction x)</code> por ejemplo.</li>
</ul>
<p>En esta sección,, explicaré como usar IO, no como funciona. Se verá como Haskell separa la partes puras del programa de las impuras.</p>
<p>No te detengas por que intentas comprender los detalles de la sintaxis. Las respuestas vendrán en la siguiente sección.</p>
<p>Qué queremos lograr?</p>
<pre><code>Pedir al usuario que ingrese una lista de números. Imprimir la suma de los
números.</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb128-1" data-line-number="1"><span class="ot">toList ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb128-2" data-line-number="2">toList input <span class="fu">=</span> read (<span class="st">&quot;[&quot;</span> <span class="fu">++</span> input <span class="fu">++</span> <span class="st">&quot;]&quot;</span>)</a>
<a class="sourceLine" id="cb128-3" data-line-number="3"></a>
<a class="sourceLine" id="cb128-4" data-line-number="4">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb128-5" data-line-number="5">  putStrLn <span class="st">&quot;Enter a list of numbers (separated by comma):&quot;</span></a>
<a class="sourceLine" id="cb128-6" data-line-number="6">  input <span class="ot">&lt;-</span> getLine</a>
<a class="sourceLine" id="cb128-7" data-line-number="7">  print <span class="fu">$</span> sum (toList input)</a></code></pre></div>
<p>Debería ser sencillo comprender el comportamiento de este programa. Analicemos los tipos en más detalle.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb129-1" data-line-number="1">putStrLn<span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb129-2" data-line-number="2">getLine<span class="ot">  ::</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb129-3" data-line-number="3">print<span class="ot">    ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a></code></pre></div>
<p>O más interesante, notamos que cada expresión en el bloque <code>do</code> tiene el tipo <code>IO a</code></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb130-1" data-line-number="1">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb130-2" data-line-number="2">  putStrLn <span class="st">&quot;Enter ... &quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb130-3" data-line-number="3"><span class="ot">  getLine               ::</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb130-4" data-line-number="4">  print <span class="dt">Something</span><span class="ot">       ::</span> <span class="dt">IO</span> ()</a></code></pre></div>
<p>También debemos prestar atención a los efectos del símbolo <code>&lt;-</code>.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb131-1" data-line-number="1"><span class="kw">do</span></a>
<a class="sourceLine" id="cb131-2" data-line-number="2">    x <span class="ot">&lt;-</span> something</a></code></pre></div>
<p>Si <code>something :: IO a</code> entonces <code>x :: a</code>.</p>
<p>Otra cosa importante a notar sobre usar <code>IO</code>: Todas las lineas en un bloque <code>do</code> deben ser de una de dos posibles formas:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb132-1" data-line-number="1"><span class="ot">action1             ::</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb132-2" data-line-number="2">                    <span class="co">-- in this case, generally a = ()</span></a></code></pre></div>
<p>O</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb133-1" data-line-number="1">value <span class="ot">&lt;-</span> action2    <span class="co">-- where</span></a>
<a class="sourceLine" id="cb133-2" data-line-number="2">                    <span class="co">-- action2 :: IO b</span></a>
<a class="sourceLine" id="cb133-3" data-line-number="3">                    <span class="co">-- value   :: b</span></a></code></pre></div>
<p>Estos dos tipos de linea corresponderán a dos formas diferentes de secuenciar acciones. El significado de esta sentencia debería quedar clara para el final de la siguiente sección.</p>
<p>Ahora veamos como se comporta el programa. Por ejemplo, qué ocurre si el usuario ingresa algo extraño? Intentemos:</p>
<pre><code>% runghc 02_progressive_io_example.lhs
    Enter a list of numbers (separated by comma):
    foo
    Prelude.read: no parse</code></pre>
<p>Un horrible mensaje de error y un fallo! Nuestra primera mejora será responder con un mensaje más amigable.</p>
<p>Para hacerlo, debemos detectar que algo salió mal. Aquí hay una forma de hacerlo: usar el tipo <code>Maybe</code>. Este es un tipo muy común en Haskell.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb135-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Data.Maybe</span></a></code></pre></div>
<p>¿Qué es esto? <code>Maybe</code> es un tipo que toma un parámetro. Su definición es:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Maybe</span> a <span class="fu">=</span> <span class="dt">Nothing</span> <span class="fu">|</span> <span class="dt">Just</span> a</a></code></pre></div>
<p>Esta es una forma muy agradable de decir que hubo un error mientras se intentaba crear/computar un valor. La función <code>maybeRead</code> es un gran ejemplo de esto. Esta es una función similar a la función <code>read</code>[^4], pero si algo sale mal el valor retornado es <code>Nothing</code>. Si el valor es correcto, retorna <code>Just &lt;el valor&gt;</code>. No intentes comprender mucho de esta función. Se usa una función de nivel menor a <code>read</code>; <code>reads</code>.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb137-1" data-line-number="1"><span class="ot">maybeRead ::</span> <span class="dt">Read</span> a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb137-2" data-line-number="2">maybeRead s <span class="fu">=</span> <span class="kw">case</span> reads s <span class="kw">of</span></a>
<a class="sourceLine" id="cb137-3" data-line-number="3">                  [(x,<span class="st">&quot;&quot;</span>)]    <span class="ot">-&gt;</span> <span class="dt">Just</span> x</a>
<a class="sourceLine" id="cb137-4" data-line-number="4">                  _           <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a></code></pre></div>
<p>Ahora para estar un poco más seguros, definimos una función que va así: Si la cadena tiene el formato incorrecto, se retorna <code>Nothing</code>. Caso contrario, por ejemplo “1,2,3”, se retorna <code>Just [1,2,3]</code>.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb138-1" data-line-number="1"><span class="ot">getListFromString ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb138-2" data-line-number="2">getListFromString str <span class="fu">=</span> maybeRead <span class="fu">$</span> <span class="st">&quot;[&quot;</span> <span class="fu">++</span> str <span class="fu">++</span> <span class="st">&quot;]&quot;</span></a></code></pre></div>
<p>Simplemente tenemos que probar el valor en nuestra función principal <code>main</code>.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb139-1" data-line-number="1"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb139-2" data-line-number="2">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb139-3" data-line-number="3">  putStrLn <span class="st">&quot;Enter a list of numbers (separated by comma):&quot;</span></a>
<a class="sourceLine" id="cb139-4" data-line-number="4">  input <span class="ot">&lt;-</span> getLine</a>
<a class="sourceLine" id="cb139-5" data-line-number="5">  <span class="kw">let</span> maybeList <span class="fu">=</span> getListFromString input <span class="kw">in</span></a>
<a class="sourceLine" id="cb139-6" data-line-number="6">      <span class="kw">case</span> maybeList <span class="kw">of</span></a>
<a class="sourceLine" id="cb139-7" data-line-number="7">          <span class="dt">Just</span> l  <span class="ot">-&gt;</span> print (sum l)</a>
<a class="sourceLine" id="cb139-8" data-line-number="8">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> error <span class="st">&quot;Bad format. Good Bye.&quot;</span></a></code></pre></div>
<p>En caso de error, mostramos un mensaje de error amigable.</p>
<p>Nótese que el tipo de cada expresión en el bloque <code>do</code> de main permanece en la forma <code>IO a</code>. La única construcción extraña es <code>error</code>. Aquí solo diré que <code>error msg</code> toma el tipo necesario (aquí <code>IO ()</code>).</p>
<p>Una cosa importante es el tipo de todas las funciones definidas hasta ahora. Solo hay una función que contiene <code>IO</code> en su tipo: <code>main</code>. Esto significa que main es impura. Pero main usa <code>getListFromString</code> que es pura. Entonces queda claro solo observando los tipos declarados que funciones son puras y cuales son impuras.</p>
<p>¿Por qué importa la pureza? Entre las muchas ventajas, aquí hay tres:</p>
<ul>
<li>Es más fácil pensar sobre una pieza de código puro que código impuro</li>
<li>La pureza te protege de los errores difícil de reproducir debido a los efectos secundarios.</li>
<li>Se pueden evaluar funciones puras en cualquier orden o en paralelo sin riesgo.</li>
</ul>
<p>Por esto se debe poner todo el código posible dentro de funciones puras.</p>
<p>Nuestra siguiente iteración será pedir al usuario una y otra vez hasta que introduzca una respuesta valida.</p>
<p>Mantenemos la primera parte:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb140-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Data.Maybe</span></a>
<a class="sourceLine" id="cb140-2" data-line-number="2"></a>
<a class="sourceLine" id="cb140-3" data-line-number="3"><span class="ot">maybeRead ::</span> <span class="dt">Read</span> a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb140-4" data-line-number="4">maybeRead s <span class="fu">=</span> <span class="kw">case</span> reads s <span class="kw">of</span></a>
<a class="sourceLine" id="cb140-5" data-line-number="5">                  [(x,<span class="st">&quot;&quot;</span>)]    <span class="ot">-&gt;</span> <span class="dt">Just</span> x</a>
<a class="sourceLine" id="cb140-6" data-line-number="6">                  _           <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb140-7" data-line-number="7"><span class="ot">getListFromString ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb140-8" data-line-number="8">getListFromString str <span class="fu">=</span> maybeRead <span class="fu">$</span> <span class="st">&quot;[&quot;</span> <span class="fu">++</span> str <span class="fu">++</span> <span class="st">&quot;]&quot;</span></a></code></pre></div>
<p>Ahora creamos una función que pregunte al usuario la lista de enteros hasta que la entrada sea correcta.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb141-1" data-line-number="1"><span class="ot">askUser ::</span> <span class="dt">IO</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb141-2" data-line-number="2">askUser <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb141-3" data-line-number="3">  putStrLn <span class="st">&quot;Enter a list of numbers (separated by comma):&quot;</span></a>
<a class="sourceLine" id="cb141-4" data-line-number="4">  input <span class="ot">&lt;-</span> getLine</a>
<a class="sourceLine" id="cb141-5" data-line-number="5">  <span class="kw">let</span> maybeList <span class="fu">=</span> getListFromString input <span class="kw">in</span></a>
<a class="sourceLine" id="cb141-6" data-line-number="6">      <span class="kw">case</span> maybeList <span class="kw">of</span></a>
<a class="sourceLine" id="cb141-7" data-line-number="7">          <span class="dt">Just</span> l  <span class="ot">-&gt;</span> return l</a>
<a class="sourceLine" id="cb141-8" data-line-number="8">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> askUser</a></code></pre></div>
<p>Esta función es de tipo <code>IO [Integer]</code>. Este tipo significa que obtendremos un valor de tipo <code>[Integer]</code> a través de acciones de entrada/salida (IO). Algunas personas podrían explicar mientras sacuden las manos:</p>
<blockquote>
<p>Esto es un <code>[Integer]</code> dentro de un <code>IO</code></p>
</blockquote>
<p>Si quieres comprender los detalles detrás de todo esto, tendrás que leer la siguiente sección. Pero en realidad, si solamente quieres saber como <em>usar</em> IO solo practica un poco y recuerda pensar sobre el tipo.</p>
<p>Finalmente la función main es mucho más simple:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb142-1" data-line-number="1"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb142-2" data-line-number="2">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb142-3" data-line-number="3">  list <span class="ot">&lt;-</span> askUser</a>
<a class="sourceLine" id="cb142-4" data-line-number="4">  print <span class="fu">$</span> sum list</a></code></pre></div>
<p>Hemos terminado con la introducción a la entrada/salida <code>IO</code>. Fue rápido. Estas son las principales cosas que hay que recordar.</p>
<ul>
<li>En el bloque <code>do</code>, cada expresión debe tener el tipo <code>IO a</code>. Así que estas limitado en el numero de expresiones disponibles. Por ejemplo, <code>getLine</code>, <code>print</code>, <code>putStrLn</code>, etc…</li>
<li>Intenta independizar las funciones puras todo lo posible.</li>
<li><p>El tipo <code>IO a</code> significa: una <strong>acción</strong> IO que retorna un elemento de tipo <code>a</code>. <code>IO</code> representa <em>acciones</em>; por dentro, <code>IO a</code> es el tipo de una función. Lee la siguiente sección si te da curiosidad.</p>
<p>Si practicas un poco, deberías ser capaz de usar <code>IO</code>.</p>
<p>Ejercicios: * Hacer un programa que sume todos sus argumentos. Pista: Usa la función <code>getArgs</code>.</p></li>
</ul>
<h2 id="el-truco-de-la-entradasalida-io-explicado">El truco de la entrada/salida (IO) explicado</h2>
<p><img src="/img/haskellhard/shot12.jpg" class="img-responsive" /><br />
</p>
<p>TL;DR*:</p>
<p>Para separar las partes puras de las impuras, <code>main</code> es la función que modifica el estado del mundo exterior</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb143-1" data-line-number="1"><span class="ot">main ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">World</span></a></code></pre></div>
<p>Una función garantiza que solo tendrá efectos secundarios si tiene este tipo. Pero observa una función <code>main</code> típica:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb144-1" data-line-number="1">main w0 <span class="fu">=</span></a>
<a class="sourceLine" id="cb144-2" data-line-number="2">    <span class="kw">let</span> (v1,w1) <span class="fu">=</span> action1 w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb144-3" data-line-number="3">    <span class="kw">let</span> (v2,w2) <span class="fu">=</span> action2 v1 w1 <span class="kw">in</span></a>
<a class="sourceLine" id="cb144-4" data-line-number="4">    <span class="kw">let</span> (v3,w3) <span class="fu">=</span> action3 v2 w2 <span class="kw">in</span></a>
<a class="sourceLine" id="cb144-5" data-line-number="5">    action4 v3 w3</a></code></pre></div>
<p>Tenemos varios elementos temporales (<code>w1</code>, <code>w2</code>, <code>w3</code>) que deben ser pasados a la siguiente sección.</p>
<p>Creamos una función <code>bind</code> o <code>(&gt;&gt;=)</code>. Con <code>bind</code> ya no necesitamos nombres temporales.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb145-1" data-line-number="1">main <span class="fu">=</span></a>
<a class="sourceLine" id="cb145-2" data-line-number="2">  action1 <span class="fu">&gt;&gt;=</span> action2 <span class="fu">&gt;&gt;=</span> action3 <span class="fu">&gt;&gt;=</span> action4</a></code></pre></div>
<p>Bonus: Haskell tiene azúcar sintáctica para nosotros:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb146-1" data-line-number="1">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb146-2" data-line-number="2">  v1 <span class="ot">&lt;-</span> action1</a>
<a class="sourceLine" id="cb146-3" data-line-number="3">  v2 <span class="ot">&lt;-</span> action2 v1</a>
<a class="sourceLine" id="cb146-4" data-line-number="4">  v3 <span class="ot">&lt;-</span> action3 v2</a>
<a class="sourceLine" id="cb146-5" data-line-number="5">  action4 v3</a></code></pre></div>
<p>Por qué usamos esta sintaxis extraña, y qué es exactamente este tipo <code>IO</code>? Parece algo mágico.</p>
<p>Por ahora vamos a olvidarnos sobre las partes puras de nuestro programa, y enfocarnos en las partes impuras.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb147-1" data-line-number="1"><span class="ot">askUser ::</span> <span class="dt">IO</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb147-2" data-line-number="2">askUser <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb147-3" data-line-number="3">  putStrLn <span class="st">&quot;Enter a list of numbers (separated by commas):&quot;</span></a>
<a class="sourceLine" id="cb147-4" data-line-number="4">  input <span class="ot">&lt;-</span> getLine</a>
<a class="sourceLine" id="cb147-5" data-line-number="5">  <span class="kw">let</span> maybeList <span class="fu">=</span> getListFromString input <span class="kw">in</span></a>
<a class="sourceLine" id="cb147-6" data-line-number="6">      <span class="kw">case</span> maybeList <span class="kw">of</span></a>
<a class="sourceLine" id="cb147-7" data-line-number="7">          <span class="dt">Just</span> l  <span class="ot">-&gt;</span> return l</a>
<a class="sourceLine" id="cb147-8" data-line-number="8">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> askUser</a>
<a class="sourceLine" id="cb147-9" data-line-number="9"></a>
<a class="sourceLine" id="cb147-10" data-line-number="10"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb147-11" data-line-number="11">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb147-12" data-line-number="12">  list <span class="ot">&lt;-</span> askUser</a>
<a class="sourceLine" id="cb147-13" data-line-number="13">  print <span class="fu">$</span> sum list</a></code></pre></div>
<p>Primera cuestión remarcarle: esto parece un programa imperativo. Haskell es lo suficientemente poderoso para hacer código impuro lucir imperativo. Por ejemplo, si deseas podrías crear un <code>while</code> en Haskell. De hecho, para lidiar con entrada/salida, un estilo imperativo es generalmente más apropiado.</p>
<p>Pero deberías haber notado que esta notación es un poco inusual. Aquí el por qué, en detalle.</p>
<p>En un lenguaje imperativo el estado del mundo puede ser visto como una gran variable global oculta. Esta variable oculta es accesible por todas las funciones del lenguaje. Por ejemplo, se pude leer desde un fichero en cualquier función. Sea que el fichero exista o no es una diferencia en el posible estado que el mundo puede tomar.</p>
<p>En Haskell este estado no es oculto. Más bien, se dice <em>explicitamemten</em> que <code>main</code> es una función que puede <em>potencialmente</em> cambiar el estado del mundo. Su tipo es como:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb148-1" data-line-number="1"><span class="ot">main ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> <span class="dt">World</span></a></code></pre></div>
<p>No todas las funciones pueden tener acceso a esta variable. Aquellas que tienen acceso son impuras. Funciones a las que no se les provee esta variable del mundo son puras[^5].</p>
<p>Haskell considera el estado del mundo exterior como una variable de enterada a <code>main</code>. Pero el tipo real de main es más parecido a[^6]:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb149-1" data-line-number="1"><span class="ot">main ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> ((),<span class="dt">World</span>)</a></code></pre></div>
<p>El tipo <code>()</code> es el tipo unitario. Nada que ver aquí.</p>
<p>Ahora escribamos nuestra función principal con esto en mente:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb150-1" data-line-number="1">main w0 <span class="fu">=</span></a>
<a class="sourceLine" id="cb150-2" data-line-number="2">    <span class="kw">let</span> (list,w1) <span class="fu">=</span> askUser w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb150-3" data-line-number="3">    <span class="kw">let</span> (x,w2) <span class="fu">=</span> print (sum list,w1) <span class="kw">in</span></a>
<a class="sourceLine" id="cb150-4" data-line-number="4">    x</a></code></pre></div>
<p>Primero, notamos que todas las funciones que tienen efectos secundarios deben tener el tipo:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb151-1" data-line-number="1"><span class="dt">World</span> <span class="ot">-&gt;</span> (a,<span class="dt">World</span>)</a></code></pre></div>
<p>Donde <code>a</code> es el tipo del resultado. Por ejemplo, una función <code>getChar</code> debería tener el tipo <code>World -&gt; (Char, World)</code>.</p>
<p>Otra cosa a notar es el truco para fijar el orden de la evaluación. En Haskell, para evaluar <code>f a b</code>, tienes varias opciones:</p>
<ul>
<li>primero evaluar <code>a</code> luego <code>b</code> luego <code>f a b</code></li>
<li>primero evaluar <code>b</code> luego <code>a</code> luego <code>f a b</code></li>
<li>evaluar <code>a</code> y <code>b</code> en paralelo y luego <code>f a b</code></li>
</ul>
<p>Esto es verdad por que estamos trabajando en la parte pura del lenguaje.</p>
<p>Ahora, si tomas la función <code>main</code>, está claro que debes evaluar la primera linea antes de la segunda puesto que para evaluar la segunda linea es necesario obtener el parámetro dado en la evaluación de la primera linea.</p>
<p>Este truco funciona bien. El compilador proveerá en cada paso un puntero a un nuevo identificador del mundo real. Por dentro, <code>print</code> se evaluará como:</p>
<ul>
<li>imprimir algo en la pantalla</li>
<li>modifica el <em>id</em> del mundo exterior</li>
<li>evaluar como <code>((),new world id)</code>.</li>
</ul>
<p>Ahora, si miras el estilo de la función main, es claramente incómodo. Intentemos hacer lo mismo a la función askUser:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb152-1" data-line-number="1"><span class="ot">askUser ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> ([<span class="dt">Integer</span>],<span class="dt">World</span>)</a></code></pre></div>
<p>Antes:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb153-1" data-line-number="1"><span class="ot">askUser ::</span> <span class="dt">IO</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb153-2" data-line-number="2">askUser <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb153-3" data-line-number="3">  putStrLn <span class="st">&quot;Enter a list of numbers:&quot;</span></a>
<a class="sourceLine" id="cb153-4" data-line-number="4">  input <span class="ot">&lt;-</span> getLine</a>
<a class="sourceLine" id="cb153-5" data-line-number="5">  <span class="kw">let</span> maybeList <span class="fu">=</span> getListFromString input <span class="kw">in</span></a>
<a class="sourceLine" id="cb153-6" data-line-number="6">      <span class="kw">case</span> maybeList <span class="kw">of</span></a>
<a class="sourceLine" id="cb153-7" data-line-number="7">          <span class="dt">Just</span> l  <span class="ot">-&gt;</span> return l</a>
<a class="sourceLine" id="cb153-8" data-line-number="8">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> askUser</a></code></pre></div>
<p>Después:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb154-1" data-line-number="1">askUser w0 <span class="fu">=</span></a>
<a class="sourceLine" id="cb154-2" data-line-number="2">    <span class="kw">let</span> (_,w1)     <span class="fu">=</span> putStrLn <span class="st">&quot;Enter a list of numbers:&quot;</span> <span class="kw">in</span></a>
<a class="sourceLine" id="cb154-3" data-line-number="3">    <span class="kw">let</span> (input,w2) <span class="fu">=</span> getLine w1 <span class="kw">in</span></a>
<a class="sourceLine" id="cb154-4" data-line-number="4">    <span class="kw">let</span> (l,w3)     <span class="fu">=</span> <span class="kw">case</span> getListFromString input <span class="kw">of</span></a>
<a class="sourceLine" id="cb154-5" data-line-number="5">                      <span class="dt">Just</span> l   <span class="ot">-&gt;</span> (l,w2)</a>
<a class="sourceLine" id="cb154-6" data-line-number="6">                      <span class="dt">Nothing</span>  <span class="ot">-&gt;</span> askUser w2</a>
<a class="sourceLine" id="cb154-7" data-line-number="7">    <span class="kw">in</span></a>
<a class="sourceLine" id="cb154-8" data-line-number="8">        (l,w3)</a></code></pre></div>
<p>Esto es similar, pero incómodo. Mira todos esos nombres temporales <code>w?</code>.</p>
<p>La lección es: poner implementación <code>IO</code> en lenguajes funcionales puros es incómodo!</p>
<p>Afortunadamente, hay una mejor forma de manejar este problema. Observamos un patrón. Cada linea es de la forma:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb155-1" data-line-number="1"><span class="kw">let</span> (y, w&#39;) <span class="fu">=</span> action x w <span class="kw">in</span></a></code></pre></div>
<p>Incluso si para alguna linea el primer argumento <code>x</code> no es necesario. La salida es de tipo tupla, <code>(answer, newWorldValue)</code>. Cada función <code>f</code> debe tener un tipo similar a:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb156-1" data-line-number="1"><span class="ot">f ::</span> <span class="dt">World</span> <span class="ot">-&gt;</span> (a,<span class="dt">World</span>)</a></code></pre></div>
<p>No solo eso, también podemos notar que siempre seguimos el mismo patrón de uso:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb157-1" data-line-number="1"><span class="kw">let</span> (y,w1) <span class="fu">=</span> action1 w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb157-2" data-line-number="2"><span class="kw">let</span> (z,w2) <span class="fu">=</span> action2 w1 <span class="kw">in</span></a>
<a class="sourceLine" id="cb157-3" data-line-number="3"><span class="kw">let</span> (t,w3) <span class="fu">=</span> action3 w2 <span class="kw">in</span></a>
<a class="sourceLine" id="cb157-4" data-line-number="4"><span class="fu">...</span></a></code></pre></div>
<p>Cada acción puede tomar de 0 a n parámetros. Y en particular, cada acción puede tomar un parámetro del resultado de la linea anterior.</p>
<p>Por ejemplo, también podríamos tener:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb158-1" data-line-number="1"><span class="kw">let</span> (_,w1) <span class="fu">=</span> action1 x w0   <span class="kw">in</span></a>
<a class="sourceLine" id="cb158-2" data-line-number="2"><span class="kw">let</span> (z,w2) <span class="fu">=</span> action2 w1     <span class="kw">in</span></a>
<a class="sourceLine" id="cb158-3" data-line-number="3"><span class="kw">let</span> (_,w3) <span class="fu">=</span> action3 x z w2 <span class="kw">in</span></a>
<a class="sourceLine" id="cb158-4" data-line-number="4"><span class="fu">...</span></a></code></pre></div>
<p>Y por supuesto <code>actionN w :: (World) -&gt; (a,World)</code>.</p>
<p>IMPORTANTE: Hay dos patrones importantes a considerar:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb159-1" data-line-number="1"><span class="kw">let</span> (x,w1) <span class="fu">=</span> action1 w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb159-2" data-line-number="2"><span class="kw">let</span> (y,w2) <span class="fu">=</span> action2 x w1 <span class="kw">in</span></a></code></pre></div>
<p>Y</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb160-1" data-line-number="1"><span class="kw">let</span> (_,w1) <span class="fu">=</span> action1 w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb160-2" data-line-number="2"><span class="kw">let</span> (y,w2) <span class="fu">=</span> action2 w1 <span class="kw">in</span></a></code></pre></div>
<p><img src="/img/haskellhard/shot13.jpg" class="img-responsive" /><br />
</p>
<p>Ahora, haremos un truco de magia. Haremos que el símbolo del mundo temporal “desaparezca”. Haremos un <code>bind</code> a las dos lineas. Dinamos la función <code>bind</code>. Su tipo es un poco intimidarte al principio:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb161-1" data-line-number="1"><span class="ot">bind ::</span> (<span class="dt">World</span> <span class="ot">-&gt;</span> (a,<span class="dt">World</span>))</a>
<a class="sourceLine" id="cb161-2" data-line-number="2">        <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> (<span class="dt">World</span> <span class="ot">-&gt;</span> (b,<span class="dt">World</span>)))</a>
<a class="sourceLine" id="cb161-3" data-line-number="3">        <span class="ot">-&gt;</span> (<span class="dt">World</span> <span class="ot">-&gt;</span> (b,<span class="dt">World</span>))</a></code></pre></div>
<p>Pero recuerda que <code>(World -&gt; (a,World))</code> es un tipo para una acción <code>IO</code>. Ahora renombremoslo por claridad:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb162-1" data-line-number="1"><span class="kw">type</span> <span class="dt">IO</span> a <span class="fu">=</span> <span class="dt">World</span> <span class="ot">-&gt;</span> (a, <span class="dt">World</span>)</a></code></pre></div>
<p>Algunos ejemplos de funciones:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb163-1" data-line-number="1">getLine<span class="ot"> ::</span> <span class="dt">IO</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb163-2" data-line-number="2">print<span class="ot"> ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a></code></pre></div>
<p><code>getLine</code> es una acción <code>IO</code> que toma el mundo exterior como parámetro y retorna una tupla <code>(String,World)</code>. Esto se puede resumir como: <code>getLine</code> es de tipo <code>IO String</code>, que también vemos como una acción IO que retornará una cadena “embeded inside an IO”.</p>
<p>La función <code>print</code> también es interesante. Toma un argumento que puede ser mostrado. De hecho puede tomar dos argumentos. El primero es el valor a imprimir y el otro es el estado del mundo exterior. Luego retorna una tupla de tipo <code>((),World)</code>. Esto significa que cambia el estado del mundo exterior, pero no produce más información.</p>
<p>Este tipo nos ayuda a simplificar el tipo de <code>bind</code>:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb164-1" data-line-number="1"><span class="ot">bind ::</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb164-2" data-line-number="2">        <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">IO</span> b)</a>
<a class="sourceLine" id="cb164-3" data-line-number="3">        <span class="ot">-&gt;</span> <span class="dt">IO</span> b</a></code></pre></div>
<p>Dice que <code>bind</code> toma dos acciones IO como parámetros y retorna otra acción IO.</p>
<p>Ahora, recuerda los patrones <em>importantes</em>. El primero era:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb165-1" data-line-number="1"><span class="kw">let</span> (x,w1) <span class="fu">=</span> action1 w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb165-2" data-line-number="2"><span class="kw">let</span> (y,w2) <span class="fu">=</span> action2 x w1 <span class="kw">in</span></a>
<a class="sourceLine" id="cb165-3" data-line-number="3">(y,w2)</a></code></pre></div>
<p>Observa los tipos:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb166-1" data-line-number="1"><span class="ot">action1  ::</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb166-2" data-line-number="2"><span class="ot">action2  ::</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> b</a>
<a class="sourceLine" id="cb166-3" data-line-number="3">(y,w2)<span class="ot">   ::</span> <span class="dt">IO</span> b</a></code></pre></div>
<p>Resulta familiar?</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb167-1" data-line-number="1">(bind action1 action2) w0 <span class="fu">=</span></a>
<a class="sourceLine" id="cb167-2" data-line-number="2">    <span class="kw">let</span> (x, w1) <span class="fu">=</span> action1 w0</a>
<a class="sourceLine" id="cb167-3" data-line-number="3">        (y, w2) <span class="fu">=</span> action2 x w1</a>
<a class="sourceLine" id="cb167-4" data-line-number="4">    <span class="kw">in</span>  (y, w2)</a></code></pre></div>
<p>La idea es esconder el argumento del mundo exterior con esta función. Hagamoslo: Como un ejemplo imagina que queremos simular:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb168-1" data-line-number="1"><span class="kw">let</span> (line1,w1) <span class="fu">=</span> getLine w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb168-2" data-line-number="2"><span class="kw">let</span> ((),w2) <span class="fu">=</span> print line1 <span class="kw">in</span></a>
<a class="sourceLine" id="cb168-3" data-line-number="3">((),w2)</a></code></pre></div>
<p>Ahora, usando la función bind:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb169-1" data-line-number="1">(res,w2) <span class="fu">=</span> (bind getLine (\l <span class="ot">-&gt;</span> print l)) w0</a></code></pre></div>
<p>Como print es de tipo <code>(World -&gt; ((),World))</code>, sabemos que <code>res = ()</code> (tipo nulo). Si no te diste cuenta de la magia aquí, intentemos con tres lineas esta vez:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb170-1" data-line-number="1"><span class="kw">let</span> (line1,w1) <span class="fu">=</span> getLine w0 <span class="kw">in</span></a>
<a class="sourceLine" id="cb170-2" data-line-number="2"><span class="kw">let</span> (line2,w2) <span class="fu">=</span> getLine w1 <span class="kw">in</span></a>
<a class="sourceLine" id="cb170-3" data-line-number="3"><span class="kw">let</span> ((),w3) <span class="fu">=</span> print (line1 <span class="fu">++</span> line2) <span class="kw">in</span></a>
<a class="sourceLine" id="cb170-4" data-line-number="4">((),w3)</a></code></pre></div>
<p>Que es equivalente a:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb171-1" data-line-number="1">(res,w3) <span class="fu">=</span> (bind getLine (\line1 <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb171-2" data-line-number="2">             (bind getLine (\line2 <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb171-3" data-line-number="3">               print (line1 <span class="fu">++</span> line2))))) w0</a></code></pre></div>
<p>Notaste algo? Si, nada de variables temporales del mundo exterior en ninguna parte! Esto es MÁGICO.</p>
<p>Podemos usar una mejor notación. Usemos <code>(&gt;&gt;=)</code> en lugar de <code>bind</code>. <code>(&gt;&gt;=)</code> es una función infijo como <code>(+)</code>; Recuerda <code>3 + 4 ⇔ (+) 3 4</code></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb172-1" data-line-number="1">(res,w3) <span class="fu">=</span> (getLine <span class="fu">&gt;&gt;=</span></a>
<a class="sourceLine" id="cb172-2" data-line-number="2">           (\line1 <span class="ot">-&gt;</span> getLine <span class="fu">&gt;&gt;=</span></a>
<a class="sourceLine" id="cb172-3" data-line-number="3">           (\line2 <span class="ot">-&gt;</span> print (line1 <span class="fu">++</span> line2)))) w0</a></code></pre></div>
<p>Haskell tiene azúcar sintáctica para nosotros:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb173-1" data-line-number="1"><span class="kw">do</span></a>
<a class="sourceLine" id="cb173-2" data-line-number="2">  x <span class="ot">&lt;-</span> action1</a>
<a class="sourceLine" id="cb173-3" data-line-number="3">  y <span class="ot">&lt;-</span> action2</a>
<a class="sourceLine" id="cb173-4" data-line-number="4">  z <span class="ot">&lt;-</span> action3</a>
<a class="sourceLine" id="cb173-5" data-line-number="5">  <span class="fu">...</span></a></code></pre></div>
<p>Se reemplaza con:</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb174-1" data-line-number="1">action1 <span class="fu">&gt;&gt;=</span> (\x <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb174-2" data-line-number="2">action2 <span class="fu">&gt;&gt;=</span> (\y <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb174-3" data-line-number="3">action3 <span class="fu">&gt;&gt;=</span> (\z <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb174-4" data-line-number="4"><span class="fu">...</span></a>
<a class="sourceLine" id="cb174-5" data-line-number="5">)))</a></code></pre></div>
<p>Nota que se puede usar <code>x</code> en <code>action2</code> y <code>x</code> y <code>y</code> en <code>action3</code>.</p>
<p>Pero qué pasa con las lineas que no usan <code>&lt;-</code>? Fácil, otra función <code>blindBind</code>:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb175-1" data-line-number="1"><span class="ot">blindBind ::</span> <span class="dt">IO</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> b <span class="ot">-&gt;</span> <span class="dt">IO</span> b</a>
<a class="sourceLine" id="cb175-2" data-line-number="2">blindBind action1 action2 w0 <span class="fu">=</span></a>
<a class="sourceLine" id="cb175-3" data-line-number="3">    bind action (\_ <span class="ot">-&gt;</span> action2) w0</a></code></pre></div>
<p>No simplifiqué esta definición por propósitos de claridad. Pero claro que podemos usar una mejor notación, usaremos el operador <code>(&gt;&gt;)</code>.</p>
<p>Y</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb176-1" data-line-number="1"><span class="kw">do</span></a>
<a class="sourceLine" id="cb176-2" data-line-number="2">    action1</a>
<a class="sourceLine" id="cb176-3" data-line-number="3">    action2</a>
<a class="sourceLine" id="cb176-4" data-line-number="4">    action3</a></code></pre></div>
<p>Se transforma en</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb177-1" data-line-number="1">action1 <span class="fu">&gt;&gt;</span></a>
<a class="sourceLine" id="cb177-2" data-line-number="2">action2 <span class="fu">&gt;&gt;</span></a>
<a class="sourceLine" id="cb177-3" data-line-number="3">action3</a></code></pre></div>
<p>También, otra función útil.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb178-1" data-line-number="1"><span class="ot">putInIO ::</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb178-2" data-line-number="2">putInIO x <span class="fu">=</span> <span class="dt">IO</span> (\w <span class="ot">-&gt;</span> (x,w))</a></code></pre></div>
<p>Esto es en general la forma de poner variables dentro de un “contexto de IO”. El nombre general para <code>ponerEnIO</code> es <code>return</code>. Que es un mal nombre cuando aprendes Haskell. <code>return</code> es muy distinto de lo que puedes estar acostumbrado.</p>
<p>Para finalizar, traduzcamos nuestro ejemplo:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb179-1" data-line-number="1"><span class="ot">askUser ::</span> <span class="dt">IO</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb179-2" data-line-number="2">askUser <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb179-3" data-line-number="3">  putStrLn <span class="st">&quot;Enter a list of numbers (separated by commas):&quot;</span></a>
<a class="sourceLine" id="cb179-4" data-line-number="4">  input <span class="ot">&lt;-</span> getLine</a>
<a class="sourceLine" id="cb179-5" data-line-number="5">  <span class="kw">let</span> maybeList <span class="fu">=</span> getListFromString input <span class="kw">in</span></a>
<a class="sourceLine" id="cb179-6" data-line-number="6">      <span class="kw">case</span> maybeList <span class="kw">of</span></a>
<a class="sourceLine" id="cb179-7" data-line-number="7">          <span class="dt">Just</span> l  <span class="ot">-&gt;</span> return l</a>
<a class="sourceLine" id="cb179-8" data-line-number="8">          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> askUser</a>
<a class="sourceLine" id="cb179-9" data-line-number="9"></a>
<a class="sourceLine" id="cb179-10" data-line-number="10"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb179-11" data-line-number="11">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb179-12" data-line-number="12">  list <span class="ot">&lt;-</span> askUser</a>
<a class="sourceLine" id="cb179-13" data-line-number="13">  print <span class="fu">$</span> sum list</a></code></pre></div>
<p>Se traduce a:</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb180-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Data.Maybe</span></a>
<a class="sourceLine" id="cb180-2" data-line-number="2"></a>
<a class="sourceLine" id="cb180-3" data-line-number="3"><span class="ot">maybeRead ::</span> <span class="dt">Read</span> a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb180-4" data-line-number="4">maybeRead s <span class="fu">=</span> <span class="kw">case</span> reads s <span class="kw">of</span></a>
<a class="sourceLine" id="cb180-5" data-line-number="5">                  [(x,<span class="st">&quot;&quot;</span>)]    <span class="ot">-&gt;</span> <span class="dt">Just</span> x</a>
<a class="sourceLine" id="cb180-6" data-line-number="6">                  _           <span class="ot">-&gt;</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb180-7" data-line-number="7"><span class="ot">getListFromString ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb180-8" data-line-number="8">getListFromString str <span class="fu">=</span> maybeRead <span class="fu">$</span> <span class="st">&quot;[&quot;</span> <span class="fu">++</span> str <span class="fu">++</span> <span class="st">&quot;]&quot;</span></a>
<a class="sourceLine" id="cb180-9" data-line-number="9"><span class="ot">askUser ::</span> <span class="dt">IO</span> [<span class="dt">Integer</span>]</a>
<a class="sourceLine" id="cb180-10" data-line-number="10">askUser <span class="fu">=</span></a>
<a class="sourceLine" id="cb180-11" data-line-number="11">    putStrLn <span class="st">&quot;Enter a list of numbers (sep. by commas):&quot;</span> <span class="fu">&gt;&gt;</span></a>
<a class="sourceLine" id="cb180-12" data-line-number="12">    getLine <span class="fu">&gt;&gt;=</span> \input <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb180-13" data-line-number="13">    <span class="kw">let</span> maybeList <span class="fu">=</span> getListFromString input <span class="kw">in</span></a>
<a class="sourceLine" id="cb180-14" data-line-number="14">      <span class="kw">case</span> maybeList <span class="kw">of</span></a>
<a class="sourceLine" id="cb180-15" data-line-number="15">        <span class="dt">Just</span> l <span class="ot">-&gt;</span> return l</a>
<a class="sourceLine" id="cb180-16" data-line-number="16">        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> askUser</a></code></pre></div>
<p>main :: IO () main = askUser &gt;&gt;= -&gt; print $ sum list</p>
<p>Puedes compilar este código y verificar que funciona.</p>
<p>Imagina como se vería sin el <code>(&gt;&gt;)</code> y <code>(&gt;&gt;=)</code>.</p>
<h2 id="monads">Monads</h2>
<p><img src="/img/haskellhard/shot14.jpg" class="img-responsive" /><br />
</p>
<p>Ahora el secreto puede ser revelado: <code>IO</code> es un <em>monad</em>. Ser un monad significa que se tiene acceso a azúcar sintáctica con la notación <code>do</code>. Pero principalmente, se tiene acceso al patrón que facilitará el flujo del código.</p>
<pre><code>Aclaraciones importantes:

* Los monads no tratan necesariamente efectos secundarios!
Hay varios Monads puros.
* Los monads se tratan se secuenciar.</code></pre>
<p>En Haskell, <code>Monad</code> es una clase de tipo. Para crear una instancia de esta clase de tipo, se deben proveer las funciones <code>(&gt;&gt;=)</code> y <code>return</code>. La función <code>(&gt;&gt;)</code> se deriva de <code>(&gt;&gt;=)</code>. Aquí se muestra como la clase de tipo <code>Monad</code> está declarada (básicamente):</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb182-1" data-line-number="1"><span class="kw">class</span> <span class="dt">Monad</span> m  <span class="kw">where</span></a>
<a class="sourceLine" id="cb182-2" data-line-number="2"><span class="ot">  (&gt;&gt;=) ::</span> m a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m b) <span class="ot">-&gt;</span> m b</a>
<a class="sourceLine" id="cb182-3" data-line-number="3"><span class="ot">  return ::</span> a <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb182-4" data-line-number="4"></a>
<a class="sourceLine" id="cb182-5" data-line-number="5"><span class="ot">  (&gt;&gt;) ::</span> m a <span class="ot">-&gt;</span> m b <span class="ot">-&gt;</span> m b</a>
<a class="sourceLine" id="cb182-6" data-line-number="6">  f <span class="fu">&gt;&gt;</span> g <span class="fu">=</span> f <span class="fu">&gt;&gt;=</span> \_ <span class="ot">-&gt;</span> g</a>
<a class="sourceLine" id="cb182-7" data-line-number="7"></a>
<a class="sourceLine" id="cb182-8" data-line-number="8">  <span class="co">-- You should generally safely ignore this function</span></a>
<a class="sourceLine" id="cb182-9" data-line-number="9">  <span class="co">-- which I believe exists for historical reasons</span></a>
<a class="sourceLine" id="cb182-10" data-line-number="10"><span class="ot">  fail ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb182-11" data-line-number="11">  fail <span class="fu">=</span> error</a></code></pre></div>
<pre><code>Aclaraciones:

* La palabra `class` no es tu amiga. En Haskell *class* no es una clase del
tipo que encontraras en lenguajes orientados a objetos. En Haskell una clase
tiene más bien similitudes con las interfaces de Java. Una mejor palabra
hubiera sido `typeclass`, pues eso significa un conjunto de tipos. Para que un
tipo pertenezca a una clase, todas las funciones de la clase debe ser
proporcionadas por el tipo.

* En este ejemplo en particular de clase de tipo, el tipo `m` debe ser un tipo
que tome un argumento. Por ejemplo `IO a`, pero también `Maybe a`, `[a]`,
etc...

* Para que un monad sea útil, la función debe obedecer algunas reglas. Si
tu construcción no las obedece cosas extrañas pueden ocurrir:

* Return a &gt;&gt;= k == K a m &gt;&gt;= return == m m &gt;&gt;= (-&gt; k x &gt;&gt;= h) == (m &gt;&gt;= k) &gt;&gt;=
h ~</code></pre>
<h3 id="maybe-es-un-monad">Maybe es un monad</h3>
<p>Hay varios tipos diferentes que son instancias de <code>Monad</code>. Una de las más fáciles de describir es <code>Maybe</code>. Si se tiene una secuencia de valores <code>Maybe</code>, se pueden usar monads para manipularlos. Es particularmente útil para remover construcciones <code>if..then..else..</code> profundas</p>
<p>Imagina una operación bancaria compleja. Eres candidato a ganar 700$ solo si puedes seguir una lista de operaciones sin que tu cuenta caiga hasta cero.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb184-1" data-line-number="1">deposit  value account <span class="fu">=</span> account <span class="fu">+</span> value</a>
<a class="sourceLine" id="cb184-2" data-line-number="2">withdraw value account <span class="fu">=</span> account <span class="fu">-</span> value</a>
<a class="sourceLine" id="cb184-3" data-line-number="3"></a>
<a class="sourceLine" id="cb184-4" data-line-number="4"><span class="ot">eligible ::</span> (<span class="dt">Num</span> a,<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb184-5" data-line-number="5">eligible account <span class="fu">=</span></a>
<a class="sourceLine" id="cb184-6" data-line-number="6">  <span class="kw">let</span> account1 <span class="fu">=</span> deposit <span class="dv">100</span> account <span class="kw">in</span></a>
<a class="sourceLine" id="cb184-7" data-line-number="7">    <span class="kw">if</span> (account1 <span class="fu">&lt;</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb184-8" data-line-number="8">    <span class="kw">then</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb184-9" data-line-number="9">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb184-10" data-line-number="10">      <span class="kw">let</span> account2 <span class="fu">=</span> withdraw <span class="dv">200</span> account1 <span class="kw">in</span></a>
<a class="sourceLine" id="cb184-11" data-line-number="11">      <span class="kw">if</span> (account2 <span class="fu">&lt;</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb184-12" data-line-number="12">      <span class="kw">then</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb184-13" data-line-number="13">      <span class="kw">else</span></a>
<a class="sourceLine" id="cb184-14" data-line-number="14">        <span class="kw">let</span> account3 <span class="fu">=</span> deposit <span class="dv">100</span> account2 <span class="kw">in</span></a>
<a class="sourceLine" id="cb184-15" data-line-number="15">        <span class="kw">if</span> (account3 <span class="fu">&lt;</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb184-16" data-line-number="16">        <span class="kw">then</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb184-17" data-line-number="17">        <span class="kw">else</span></a>
<a class="sourceLine" id="cb184-18" data-line-number="18">          <span class="kw">let</span> account4 <span class="fu">=</span> withdraw <span class="dv">300</span> account3 <span class="kw">in</span></a>
<a class="sourceLine" id="cb184-19" data-line-number="19">          <span class="kw">if</span> (account4 <span class="fu">&lt;</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb184-20" data-line-number="20">          <span class="kw">then</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb184-21" data-line-number="21">          <span class="kw">else</span></a>
<a class="sourceLine" id="cb184-22" data-line-number="22">            <span class="kw">let</span> account5 <span class="fu">=</span> deposit <span class="dv">1000</span> account4 <span class="kw">in</span></a>
<a class="sourceLine" id="cb184-23" data-line-number="23">            <span class="kw">if</span> (account5 <span class="fu">&lt;</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb184-24" data-line-number="24">            <span class="kw">then</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb184-25" data-line-number="25">            <span class="kw">else</span></a>
<a class="sourceLine" id="cb184-26" data-line-number="26">              <span class="dt">True</span></a>
<a class="sourceLine" id="cb184-27" data-line-number="27"></a>
<a class="sourceLine" id="cb184-28" data-line-number="28">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb184-29" data-line-number="29">  print <span class="fu">$</span> eligible <span class="dv">300</span> <span class="co">-- True</span></a>
<a class="sourceLine" id="cb184-30" data-line-number="30">  print <span class="fu">$</span> eligible <span class="dv">299</span> <span class="co">-- False</span></a></code></pre></div>
<p>Ahora, mejoremos esto usando <code>Maybe</code> y el hecho de que es un Monad</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb185-1" data-line-number="1"><span class="ot">deposit ::</span> (<span class="dt">Num</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb185-2" data-line-number="2">deposit value account <span class="fu">=</span> <span class="dt">Just</span> (account <span class="fu">+</span> value)</a>
<a class="sourceLine" id="cb185-3" data-line-number="3"></a>
<a class="sourceLine" id="cb185-4" data-line-number="4"><span class="ot">withdraw ::</span> (<span class="dt">Num</span> a,<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb185-5" data-line-number="5">withdraw value account <span class="fu">=</span> <span class="kw">if</span> (account <span class="fu">&lt;</span> value)</a>
<a class="sourceLine" id="cb185-6" data-line-number="6">                         <span class="kw">then</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb185-7" data-line-number="7">                         <span class="kw">else</span> <span class="dt">Just</span> (account <span class="fu">-</span> value)</a>
<a class="sourceLine" id="cb185-8" data-line-number="8"></a>
<a class="sourceLine" id="cb185-9" data-line-number="9"><span class="ot">eligible ::</span> (<span class="dt">Num</span> a, <span class="dt">Ord</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb185-10" data-line-number="10">eligible account <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb185-11" data-line-number="11">  account1 <span class="ot">&lt;-</span> deposit <span class="dv">100</span> account</a>
<a class="sourceLine" id="cb185-12" data-line-number="12">  account2 <span class="ot">&lt;-</span> withdraw <span class="dv">200</span> account1</a>
<a class="sourceLine" id="cb185-13" data-line-number="13">  account3 <span class="ot">&lt;-</span> deposit <span class="dv">100</span> account2</a>
<a class="sourceLine" id="cb185-14" data-line-number="14">  account4 <span class="ot">&lt;-</span> withdraw <span class="dv">300</span> account3</a>
<a class="sourceLine" id="cb185-15" data-line-number="15">  account5 <span class="ot">&lt;-</span> deposit <span class="dv">1000</span> account4</a>
<a class="sourceLine" id="cb185-16" data-line-number="16">  <span class="dt">Just</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb185-17" data-line-number="17"></a>
<a class="sourceLine" id="cb185-18" data-line-number="18">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb185-19" data-line-number="19">  print <span class="fu">$</span> eligible <span class="dv">300</span> <span class="co">-- Just True</span></a>
<a class="sourceLine" id="cb185-20" data-line-number="20">  print <span class="fu">$</span> eligible <span class="dv">299</span> <span class="co">-- Nothing</span></a></code></pre></div>
<p>No esta nada mal, pero podemos mejorarlo más:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb186-1" data-line-number="1"><span class="ot">deposit ::</span> (<span class="dt">Num</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb186-2" data-line-number="2">deposit value account <span class="fu">=</span> <span class="dt">Just</span> (account <span class="fu">+</span> value)</a>
<a class="sourceLine" id="cb186-3" data-line-number="3"></a>
<a class="sourceLine" id="cb186-4" data-line-number="4"><span class="ot">withdraw ::</span> (<span class="dt">Num</span> a,<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</a>
<a class="sourceLine" id="cb186-5" data-line-number="5">withdraw value account <span class="fu">=</span> <span class="kw">if</span> (account <span class="fu">&lt;</span> value)</a>
<a class="sourceLine" id="cb186-6" data-line-number="6">                         <span class="kw">then</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb186-7" data-line-number="7">                         <span class="kw">else</span> <span class="dt">Just</span> (account <span class="fu">-</span> value)</a>
<a class="sourceLine" id="cb186-8" data-line-number="8"></a>
<a class="sourceLine" id="cb186-9" data-line-number="9"><span class="ot">eligible ::</span> (<span class="dt">Num</span> a, <span class="dt">Ord</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb186-10" data-line-number="10">eligible account <span class="fu">=</span></a>
<a class="sourceLine" id="cb186-11" data-line-number="11">  deposit <span class="dv">100</span> account <span class="fu">&gt;&gt;=</span></a>
<a class="sourceLine" id="cb186-12" data-line-number="12">  withdraw <span class="dv">200</span> <span class="fu">&gt;&gt;=</span></a>
<a class="sourceLine" id="cb186-13" data-line-number="13">  deposit <span class="dv">100</span>  <span class="fu">&gt;&gt;=</span></a>
<a class="sourceLine" id="cb186-14" data-line-number="14">  withdraw <span class="dv">300</span> <span class="fu">&gt;&gt;=</span></a>
<a class="sourceLine" id="cb186-15" data-line-number="15">  deposit <span class="dv">1000</span> <span class="fu">&gt;&gt;</span></a>
<a class="sourceLine" id="cb186-16" data-line-number="16">  return <span class="dt">True</span></a>
<a class="sourceLine" id="cb186-17" data-line-number="17"></a>
<a class="sourceLine" id="cb186-18" data-line-number="18">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb186-19" data-line-number="19">  print <span class="fu">$</span> eligible <span class="dv">300</span> <span class="co">-- Just True</span></a>
<a class="sourceLine" id="cb186-20" data-line-number="20">  print <span class="fu">$</span> eligible <span class="dv">299</span> <span class="co">-- Nothing</span></a></code></pre></div>
<p>Hemos demostrado que los Monads son una buena forma de hacer el código más elegante. Esta idea para organizar el código, en particular para <code>Maybe</code> se puede usar en la mayoría de los lenguajes imperativos. De hecho, este es más o menos el tipo de construcciones que hacemos naturalmente.</p>
<pre><code>Una aclaración importante:

El primer elemento en la secuencia evaluada a `Nothing` detendrá por
completo la evaluación. Esto significa que no se ejecutan todas las
lineas. Obtienes esto gratuitamente, gracias a la pereza (laziness).</code></pre>
<p>También se puede replicar este ejemplo con la definición de <code>(&gt;&gt;=)</code> para <code>Maybe</code> en mente:</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb188-1" data-line-number="1"><span class="kw">instance</span> <span class="dt">Monad</span> <span class="dt">Maybe</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb188-2" data-line-number="2"><span class="ot">    (&gt;&gt;=) ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b</a>
<a class="sourceLine" id="cb188-3" data-line-number="3">    <span class="dt">Nothing</span>  <span class="fu">&gt;&gt;=</span> _  <span class="fu">=</span> <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb188-4" data-line-number="4">    (<span class="dt">Just</span> x) <span class="fu">&gt;&gt;=</span> f  <span class="fu">=</span> f x</a>
<a class="sourceLine" id="cb188-5" data-line-number="5"></a>
<a class="sourceLine" id="cb188-6" data-line-number="6">    return x <span class="fu">=</span> <span class="dt">Just</span> x</a></code></pre></div>
<p>El monad <code>Maybe</code> probó ser útil en este ejemplo. Vimos la utilidad de el monad <code>IO</code>. Pero vamos por un mejor ejemplo, las listas.</p>
<h3 id="el-monad-lista">El monad lista</h3>
<p><img src="/img/haskellhard/shot15.jpg" class="img-responsive" /><br />
</p>
<p>El monad lista ayuda a simular cómputos no determinístico:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb189-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Control.Monad</span> (guard)</a>
<a class="sourceLine" id="cb189-2" data-line-number="2"></a>
<a class="sourceLine" id="cb189-3" data-line-number="3">allCases <span class="fu">=</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]</a>
<a class="sourceLine" id="cb189-4" data-line-number="4"></a>
<a class="sourceLine" id="cb189-5" data-line-number="5"><span class="ot">resolve ::</span> [(<span class="dt">Int</span>,<span class="dt">Int</span>,<span class="dt">Int</span>)]</a>
<a class="sourceLine" id="cb189-6" data-line-number="6">resolve <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb189-7" data-line-number="7">              x <span class="ot">&lt;-</span> allCases</a>
<a class="sourceLine" id="cb189-8" data-line-number="8">              y <span class="ot">&lt;-</span> allCases</a>
<a class="sourceLine" id="cb189-9" data-line-number="9">              z <span class="ot">&lt;-</span> allCases</a>
<a class="sourceLine" id="cb189-10" data-line-number="10">              guard <span class="fu">$</span> <span class="dv">4</span><span class="fu">*</span>x <span class="fu">+</span> <span class="dv">2</span><span class="fu">*</span>y <span class="fu">&lt;</span> z</a>
<a class="sourceLine" id="cb189-11" data-line-number="11">              return (x,y,z)</a>
<a class="sourceLine" id="cb189-12" data-line-number="12"></a>
<a class="sourceLine" id="cb189-13" data-line-number="13">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb189-14" data-line-number="14">  print resolve</a></code></pre></div>
<p>MAGIA:</p>
<pre><code>[(1,1,7),(1,1,8),(1,1,9),(1,1,10),(1,2,9),(1,2,10)]</code></pre>
<p>Para el monad lista, también hay azúcar sintáctica:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb191-1" data-line-number="1">print <span class="fu">$</span> [ (x,y,z) <span class="fu">|</span> x <span class="ot">&lt;-</span> allCases,</a>
<a class="sourceLine" id="cb191-2" data-line-number="2">                      y <span class="ot">&lt;-</span> allCases,</a>
<a class="sourceLine" id="cb191-3" data-line-number="3">                      z <span class="ot">&lt;-</span> allCases,</a>
<a class="sourceLine" id="cb191-4" data-line-number="4">                      <span class="dv">4</span><span class="fu">*</span>x <span class="fu">+</span> <span class="dv">2</span><span class="fu">*</span>y <span class="fu">&lt;</span> z ]</a></code></pre></div>
<p>No listaré todos los monads, pero hay muchos de ellos. Usar monads simplifica la manipulación de varias nociones en lenguajes puros. En particular, los monads son muy útiles para:</p>
<ul>
<li>IO</li>
<li>Computo no determinístico</li>
<li>Generar números pseudo aleatorios</li>
<li>Mantener configuración de estado</li>
<li>Escribir estado</li>
<li>…</li>
</ul>
<p>Si me has seguido hasta aquí, entonces lo lograste! Sabes Monads[^7]!</p>
<h1 id="apéndice">Apéndice</h1>
<p>Esta sección no se trata de aprender Haskell. Solo está aquí para discutir a más profundidad algunos detalles.</p>
<h2 id="más-sobre-los-arboles-infinitos">Más sobre los arboles infinitos</h2>
<p>En la sección <em>Estructuras infinitas</em> vimos algunas construcciones simples. Desafortunadamente removimos dos propiedades de nuestro árbol:</p>
<ol type="1">
<li>No valores duplicados en los nodos</li>
<li>Árbol bien ordenado</li>
</ol>
<p>En esta sección intentaremos mantener la primera propiedad. Respecto a la segunda, debemos relajarla pero discutiremos como mantenerla todo lo posible.</p>
<p>El primer paso es crear una lista de números pseudo aleatorios:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb192-1" data-line-number="1">shuffle <span class="fu">=</span> map (\x <span class="ot">-&gt;</span> (x<span class="fu">*</span><span class="dv">3123</span>) <span class="ot">`mod`</span> <span class="dv">4331</span>) [<span class="dv">1</span><span class="fu">..</span>]</a></code></pre></div>
<p>Solo como recordatorio, aquí esta la definición de <code>treeFromList</code></p>
<div class="sourceCode" id="cb193"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb193-1" data-line-number="1"><span class="ot">treeFromList ::</span> (<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">BinTree</span> a</a>
<a class="sourceLine" id="cb193-2" data-line-number="2">treeFromList []    <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb193-3" data-line-number="3">treeFromList (x<span class="fu">:</span>xs) <span class="fu">=</span> <span class="dt">Node</span> x (treeFromList (filter (<span class="fu">&lt;</span>x) xs))</a>
<a class="sourceLine" id="cb193-4" data-line-number="4">                             (treeFromList (filter (<span class="fu">&gt;</span>x) xs))</a></code></pre></div>
<p>y <code>treeTakeDepth</code>:</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb194-1" data-line-number="1">treeTakeDepth _ <span class="dt">Empty</span> <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb194-2" data-line-number="2">treeTakeDepth <span class="dv">0</span> _     <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb194-3" data-line-number="3">treeTakeDepth n (<span class="dt">Node</span> x left right) <span class="fu">=</span> <span class="kw">let</span></a>
<a class="sourceLine" id="cb194-4" data-line-number="4">          nl <span class="fu">=</span> treeTakeDepth (n<span class="fu">-</span><span class="dv">1</span>) left</a>
<a class="sourceLine" id="cb194-5" data-line-number="5">          nr <span class="fu">=</span> treeTakeDepth (n<span class="fu">-</span><span class="dv">1</span>) right</a>
<a class="sourceLine" id="cb194-6" data-line-number="6">          <span class="kw">in</span></a>
<a class="sourceLine" id="cb194-7" data-line-number="7">              <span class="dt">Node</span> x nl nr</a></code></pre></div>
<p>Observa el resultado de:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb195-1" data-line-number="1">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb195-2" data-line-number="2">      putStrLn <span class="st">&quot;take 10 shuffle&quot;</span></a>
<a class="sourceLine" id="cb195-3" data-line-number="3">      print <span class="fu">$</span> take <span class="dv">10</span> shuffle</a>
<a class="sourceLine" id="cb195-4" data-line-number="4">      putStrLn <span class="st">&quot;\ntreeTakeDepth 4 (treeFromList shuffle)&quot;</span></a>
<a class="sourceLine" id="cb195-5" data-line-number="5">      print <span class="fu">$</span> treeTakeDepth <span class="dv">4</span> (treeFromList shuffle)</a></code></pre></div>
<pre><code>% runghc 02_Hard_Part/41_Infinites_Structures.lhs
take 10 shuffle
[3123,1915,707,3830,2622,1414,206,3329,2121,913]
treeTakeDepth 4 (treeFromList shuffle)

&lt; 3123
: |--1915
: |  |--707
: |  |  |--206
: |  |  `--1414
: |  `--2622
: |     |--2121
: |     `--2828
: `--3830
:    |--3329
:    |  |--3240
:    |  `--3535
:    `--4036
:       |--3947
:       `--4242</code></pre>
<p>Bien! Termina! Pero cuidado, solo funcionará si tiene algo que poner en la rama.</p>
<p>Por ejemplo</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb197-1" data-line-number="1">treeTakeDepth <span class="dv">4</span> (treeFromList [<span class="dv">1</span><span class="fu">..</span>])</a></code></pre></div>
<p>No terminará nunca. Por que intentará acceder a la cabeza de <code>filter (&lt;1) [2..]</code>. Pero <code>filger</code> no es lo bastante inteligente para entender que el resultado es una lista vacía.</p>
<p>Aun así, es un ejemplo muy bueno de lo que los programas no estrictos pueden ofrecer.</p>
<p>Como ejercicio para el lector:</p>
<ul>
<li>Probar la existencia de un numero <code>n</code> tal que <code>treeTakeDepth n (treeFromList shuffle)</code> entrará en un loop infinito.</li>
<li>Encontrar un limite superior para <code>n</code>.</li>
<li>Probar que no hay una lista <code>suffle</code> tal que para cualquier profundidad, el programa termina.</li>
</ul>
<p>Para resolver este problema modificaremos un poco las funciones <code>treeFromList</code> y <code>shuffle</code>.</p>
<p>Un primer problema es la falta de infinitos números diferentes en nuestra implementación de <code>shuffle</code>. Solo hemos generado <code>4331</code> números distintos. Para solucionarlo haremos una función <code>shuffle</code> mejorada.</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb198-1" data-line-number="1">shuffle <span class="fu">=</span> map rand [<span class="dv">1</span><span class="fu">..</span>]</a>
<a class="sourceLine" id="cb198-2" data-line-number="2">          <span class="kw">where</span></a>
<a class="sourceLine" id="cb198-3" data-line-number="3">              rand x <span class="fu">=</span> ((p x) <span class="ot">`mod`</span> (x<span class="fu">+</span>c)) <span class="fu">-</span> ((x<span class="fu">+</span>c) <span class="ot">`div`</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb198-4" data-line-number="4">              p x <span class="fu">=</span> m<span class="fu">*</span>x<span class="fu">^</span><span class="dv">2</span> <span class="fu">+</span> n<span class="fu">*</span>x <span class="fu">+</span> o <span class="co">-- some polynome</span></a>
<a class="sourceLine" id="cb198-5" data-line-number="5">              m <span class="fu">=</span> <span class="dv">3123</span></a>
<a class="sourceLine" id="cb198-6" data-line-number="6">              n <span class="fu">=</span> <span class="dv">31</span></a>
<a class="sourceLine" id="cb198-7" data-line-number="7">              o <span class="fu">=</span> <span class="dv">7641</span></a>
<a class="sourceLine" id="cb198-8" data-line-number="8">              c <span class="fu">=</span> <span class="dv">1237</span></a></code></pre></div>
<p>Esta función tiene la propiedad de no tener un limite superior o inferior. Pero tener una lista mejor mezclada no es suficiente para no entrar en un bucle infinito.</p>
<p>Generalmente, no podemos decidir si <code>filter (&lt;x) xs</code> está vacía. Entonces para resolver este problema, autorizaré algo de error en la creación del árbol binario. Esta nueva versión puede crear un árbol binario que no tienen la siguiente propiedad para algunos de sus nodos:</p>
<pre><code>Cualquier elemento en la rama izquierda debe ser estrictamente
inferior a la etiqueta de la raíz.</code></pre>
<p>Permanecerá en su <em>mayor parte</em> un árbol binario ordenado. Más aún, por construcción, el valor de cada nodo es único en el árbol.</p>
<p>Aquí nuestra nueva versión de <code>treeFromList</code>. Simplemente sea ha remplazado <code>filter</code> por <code>safefilter</code>.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb200-1" data-line-number="1"><span class="ot">treeFromList ::</span> (<span class="dt">Ord</span> a, <span class="dt">Show</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">BinTree</span> a</a>
<a class="sourceLine" id="cb200-2" data-line-number="2">treeFromList []    <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb200-3" data-line-number="3">treeFromList (x<span class="fu">:</span>xs) <span class="fu">=</span> <span class="dt">Node</span> x left right</a>
<a class="sourceLine" id="cb200-4" data-line-number="4">          <span class="kw">where</span></a>
<a class="sourceLine" id="cb200-5" data-line-number="5">              left <span class="fu">=</span> treeFromList <span class="fu">$</span> safefilter (<span class="fu">&lt;</span>x) xs</a>
<a class="sourceLine" id="cb200-6" data-line-number="6">              right <span class="fu">=</span> treeFromList <span class="fu">$</span> safefilter (<span class="fu">&gt;</span>x) xs</a></code></pre></div>
<p>Esta nueva función <code>safefilter</code> es casi equivalente a <code>filter</code> pero no entra en un bucle infinito si el resultado es una lista infinita. Si no puede encontrar un elemento para el cual la prueba resulte cierta luego de 10000 pasos consecutivos, entonces considera que es el final de la búsqueda.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb201-1" data-line-number="1"><span class="ot">safefilter ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb201-2" data-line-number="2">safefilter f l <span class="fu">=</span> safefilter&#39; f l nbTry</a>
<a class="sourceLine" id="cb201-3" data-line-number="3">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb201-4" data-line-number="4">      nbTry <span class="fu">=</span> <span class="dv">10000</span></a>
<a class="sourceLine" id="cb201-5" data-line-number="5">      safefilter&#39; _ _ <span class="dv">0</span> <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb201-6" data-line-number="6">      safefilter&#39; _ [] _ <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb201-7" data-line-number="7">      safefilter&#39; f (x<span class="fu">:</span>xs) n <span class="fu">=</span></a>
<a class="sourceLine" id="cb201-8" data-line-number="8">                  <span class="kw">if</span> f x</a>
<a class="sourceLine" id="cb201-9" data-line-number="9">                     <span class="kw">then</span> x <span class="fu">:</span> safefilter&#39; f xs nbTry</a>
<a class="sourceLine" id="cb201-10" data-line-number="10">                     <span class="kw">else</span> safefilter&#39; f xs (n<span class="fu">-</span><span class="dv">1</span>)</a></code></pre></div>
<p>Ahora el programa se ejecuta bien:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb202-1" data-line-number="1">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb202-2" data-line-number="2">      putStrLn <span class="st">&quot;take 10 shuffle&quot;</span></a>
<a class="sourceLine" id="cb202-3" data-line-number="3">      print <span class="fu">$</span> take <span class="dv">10</span> shuffle</a>
<a class="sourceLine" id="cb202-4" data-line-number="4">      putStrLn <span class="st">&quot;\ntreeTakeDepth 8 (treeFromList shuffle)&quot;</span></a>
<a class="sourceLine" id="cb202-5" data-line-number="5">      print <span class="fu">$</span> treeTakeDepth <span class="dv">8</span> (treeFromList <span class="fu">$</span> shuffle)</a></code></pre></div>
<p>Se debería ver que el tiempo para imprimir cada valor es diferente. Esto es por que Haskell calcula cada valor cuando lo necesita. Y en este caso, esto ocurre cuando se solicita imprimirlo en pantalla.</p>
<p>Intenta remplazar la profundidad de <code>8</code> a <code>100</code>. Funcionará sin comerse tu RAM! El flujo en el manejo de memoria es hecho de forma natural por Haskell.</p>
<p>Como ejercicio para el lector:</p>
<ul>
<li><p>Incluso con un valor grande constante para <code>deep</code> y <code>nbTry</code>, parece funcionar bien. Pero en el peor caso, puede ser exponencial. Crear una lista para el peor caso y darlo como parámetro a <code>treeFromList</code>. Pista: piensa en <code>[0,-1,-1,...,-1,1,-1,...,-1,1,...]</code>.</p></li>
<li><p>Primero intenté implementar <code>safefilter</code> como:</p></li>
</ul>
<div class="sourceCode" id="cb203"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb203-1" data-line-number="1">safefilter&#39; f l <span class="fu">=</span> <span class="kw">if</span> filter f (take <span class="dv">10000</span> l) <span class="fu">==</span> []</a>
<a class="sourceLine" id="cb203-2" data-line-number="2">            <span class="kw">then</span> []</a>
<a class="sourceLine" id="cb203-3" data-line-number="3">            <span class="kw">else</span> filter f l</a></code></pre></div>
<p>Explica por que no funciona y puede entrar en un loop infinito.</p>
<ul>
<li>Supón que <code>shuffle</code> es una lista aleatoria real con limites crecientes. Si estudias un poco esta estructura, descubrirás que con una probabilidad de 1, esta es una estructura infinita. Usando el siguiente código encuentra una definición de <code>f</code> tal que con probabilidad de <code>1</code>, <code>treeFromList' shuffle</code> es infinita. Y pruebalo. (esto solo es una conjetura).</li>
</ul>
<div class="sourceCode" id="cb204"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb204-1" data-line-number="1">treeFromList&#39; []  n <span class="fu">=</span> <span class="dt">Empty</span></a>
<a class="sourceLine" id="cb204-2" data-line-number="2">treeFromList&#39; (x<span class="fu">:</span>xs) n <span class="fu">=</span> <span class="dt">Node</span> x left right</a>
<a class="sourceLine" id="cb204-3" data-line-number="3">    <span class="kw">where</span></a>
<a class="sourceLine" id="cb204-4" data-line-number="4">        left <span class="fu">=</span> treeFromList&#39; (safefilter&#39; (<span class="fu">&lt;</span>x) xs (f n)</a>
<a class="sourceLine" id="cb204-5" data-line-number="5">        right <span class="fu">=</span> treeFromList&#39; (safefilter&#39; (<span class="fu">&gt;</span>x) xs (f n)</a>
<a class="sourceLine" id="cb204-6" data-line-number="6">        f <span class="fu">=</span> <span class="fu">???</span></a></code></pre></div>
<p>[^1]. Incluso si los lenguajes mas recientes intentan ocultarlos, están presentes.</p>
<p>[^2]. Se que estoy haciendo trampa. Pero hablaré “no estricto” luego.</p>
<p>[^3]. Para los valientes, una explicación más completa del patrón de matching se puede encontrar <a href="http://www.cs.auckland.ac.nz/references/haskell/haskell-intro-html/patterns.html">aquí</a>.</p>
<p>[^4]. Es muy similar al <code>eval</code> de javascript en una cadena que contiene JSON.</p>
<p>[^5]. Hay algunas excepciones <em>no seguras</em> ha esta regla. Pero no deberías ver su uso en una aplicación real excepto tal vez para propósitos de depuración.</p>
<p>[^6]. Para los curiosos el tipo real es <code>data IO a = IO {unIO :: State# RealWorld -&gt; (#State# RealWorld, a #)}</code>. Los ‘#’ tienen que ver con la optimización.</p>
<p>[^7]. Ciertamente necesitas practicar un poco para acostumbrarte a ellos y entender cuando los puedes usar y crearlos tu mismo. Pero ya haz hecho un gran avance.</p>]]></summary>
</entry>
<entry>
    <title>Seamlessly Vim-Tmux-WindowManager-Monitor navigator</title>
    <link href="http://www.sillybytes.net/2016/06/seamlessly-vim-tmux-windowmanager_24.html" />
    <id>http://www.sillybytes.net/2016/06/seamlessly-vim-tmux-windowmanager_24.html</id>
    <published>2016-06-24T00:00:00Z</published>
    <updated>2016-06-24T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/navigator/thumbnail.jpg" class="img-responsive" /></p>
<p><a href="https://robots.thoughtbot.com/seamlessly-navigate-vim-and-tmux-splits">This Thoughtbot post</a> describes how to make Vim and Tmux <em>work together in Harmony</em> based on <a href="https://github.com/christoomey/vim-tmux-navigator">this crhistoomey plugin</a>, allowing you to traverse both your Vim and Tmux windows and panes respectively.</p>
<!--more-->
<p>Having the ability to traverse Vim and Tmux splits without having to think about it using <code>ctrl-h</code>, <code>ctrl-j</code>, <code>ctrl-k</code>, <code>ctrl-l</code> is fantastic! But I still had an annoyance source from the window manager (Ratpoison) and the multi monitor setup.</p>
<p>So I took the same concept and extend it to those uses cases, so now I use <code>ctrl-h</code>, <code>ctrl-j</code>, <code>ctrl-k</code>, <code>ctrl-l</code> to move through my <strong>Window Manager splits</strong>, my <strong>Tmux panes</strong>, my <strong>Vim windows</strong> and my <strong>Monitors</strong> with minimum mental overhead. Here is how.</p>
<p>Some of the scripts are a bit of complex, so instead of explaining them in detail the general algorithm is described.</p>
<h1 id="frame-monitor-navigation">Frame-Monitor Navigation</h1>
<p><img src="/img/navigator/shot1.jpg" class="img-left" /></p>
<p>When traversing frames (Ratpoison splits) it stops at the end of the current monitor, so first I needed to change to the left or right monitor when a movement command is triggered at the edge of the current one.</p>
<p>The script <a href="https://github.com/alx741/dotfiles/blob/master/scripts/.scripts/ratpoison/frame-mon_navigator.sh">frame-mon_navigator.sh</a> calculates if the current frame is the rightmost or the leftmost in the current monitor, if it is, it goes to the next of previous monitor depending on the movement command.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">#!/bin/sh</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ex">ratpoison</span> -c <span class="st">&#39;fdump&#39;</span><span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/,/\n/g&#39;</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $5&quot; &quot;$19}&#39;</span> <span class="op">&gt;</span> /tmp/ratpoison_frame_monitor_navigator</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co"># Calculate X coordinate for rightmost frame</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="va">greater_x_coordinate=</span>0</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">while</span> <span class="bu">read</span> <span class="va">frame</span>; <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    <span class="va">coordinate=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$frame</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f1<span class="va">)</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="kw">if [[</span> <span class="va">$coordinate</span> <span class="ot">-gt</span> <span class="va">$greater_x_coordinate</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">        <span class="va">greater_x_coordinate=$coordinate</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw">done</span> <span class="op">&lt;</span> <span class="ex">/tmp/ratpoison_frame_monitor_navigator</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co"># Calculate current frame X coordinate</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="va">x_coordinate=$(</span><span class="fu">head</span> -n1 /tmp/ratpoison_frame_monitor_navigator <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f1<span class="va">)</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="va">last_access=$(</span><span class="fu">head</span> -n1 /tmp/ratpoison_frame_monitor_navigator <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f2<span class="va">)</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="kw">while</span> <span class="bu">read</span> <span class="va">frame</span>; <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">    <span class="va">access=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$frame</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f2<span class="va">)</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    <span class="kw">if [[</span> <span class="va">$access</span> <span class="ot">-gt</span> <span class="va">$last_access</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">        <span class="va">last_access=$access</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">        <span class="va">x_coordinate=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$frame</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f1<span class="va">)</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="kw">done</span> <span class="op">&lt;</span> <span class="ex">/tmp/ratpoison_frame_monitor_navigator</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="kw">function</span><span class="fu"> is_leftmost</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="kw">{</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30">    <span class="kw">if [[</span> <span class="va">$x_coordinate</span> <span class="ot">-eq</span> 0<span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31">        <span class="bu">return</span> 0</a>
<a class="sourceLine" id="cb1-32" data-line-number="32">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">        <span class="bu">return</span> 1</a>
<a class="sourceLine" id="cb1-34" data-line-number="34">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="kw">}</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="kw">function</span><span class="fu"> is_rightmost</span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="kw">{</span></a>
<a class="sourceLine" id="cb1-39" data-line-number="39">    <span class="kw">if [[</span> <span class="va">$x_coordinate</span> <span class="ot">-eq</span> <span class="va">$greater_x_coordinate</span><span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-40" data-line-number="40">        <span class="bu">return</span> 0</a>
<a class="sourceLine" id="cb1-41" data-line-number="41">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-42" data-line-number="42">        <span class="bu">return</span> 1</a>
<a class="sourceLine" id="cb1-43" data-line-number="43">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-44" data-line-number="44"><span class="kw">}</span></a>
<a class="sourceLine" id="cb1-45" data-line-number="45"></a>
<a class="sourceLine" id="cb1-46" data-line-number="46"><span class="co"># Go to previous screen if currently if leftmost frame</span></a>
<a class="sourceLine" id="cb1-47" data-line-number="47"><span class="co"># Go to next screen if currently if rightmost frame</span></a>
<a class="sourceLine" id="cb1-48" data-line-number="48"><span class="co"># Execute frame focus otherwise</span></a>
<a class="sourceLine" id="cb1-49" data-line-number="49"><span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;left&quot;</span><span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-50" data-line-number="50">    <span class="kw">if</span> <span class="ex">is_leftmost</span><span class="kw">;</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-51" data-line-number="51">        <span class="ex">ratpoison</span> -c <span class="st">&#39;prevscreen&#39;</span></a>
<a class="sourceLine" id="cb1-52" data-line-number="52">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-53" data-line-number="53">        <span class="ex">ratpoison</span> -c <span class="st">&#39;focusleft&#39;</span></a>
<a class="sourceLine" id="cb1-54" data-line-number="54">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-55" data-line-number="55"><span class="kw">elif [[</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;right&quot;</span><span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-56" data-line-number="56">    <span class="kw">if</span> <span class="ex">is_rightmost</span><span class="kw">;</span> <span class="kw">then</span></a>
<a class="sourceLine" id="cb1-57" data-line-number="57">        <span class="ex">ratpoison</span> -c <span class="st">&#39;nextscreen&#39;</span></a>
<a class="sourceLine" id="cb1-58" data-line-number="58">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb1-59" data-line-number="59">        <span class="ex">ratpoison</span> -c <span class="st">&#39;focusright&#39;</span></a>
<a class="sourceLine" id="cb1-60" data-line-number="60">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="kw">fi</span></a></code></pre></div>
<h1 id="ratpoison-tmux-navigator">Ratpoison-Tmux Navigator</h1>
<p><img src="/img/navigator/shot2.jpg" class="img-left" /></p>
<p>We need a way to pass movement commands to Tmux so Vim-Tmux navigation works as always, but we also need to pass movement commands from Tmux to Ratpoison when a movement command is triggered from Tmux edge pane.</p>
<p>The script <a href="https://github.com/alx741/dotfiles/blob/master/scripts/.scripts/ratpoison/rat_tmux-navigator.sh">rat_tmux-navigator.sh</a> is able to tell if the terminal emulator (Urxvt) is currently focused and, if so, send the movement commands to Tmux so it can handle panes traversing as usual. It also define functions that Tmux can use to know if a edge pane is reached and send the movement commands to Ratpoison through the <strong>frame-mon_navigator.sh</strong> script so Frame-Monitor navigation is included in the process.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;rat&quot;</span><span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="va">current_window=$(</span><span class="ex">ratpoison</span> -c <span class="st">&#39;info&#39;</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/(.*).*(\(.*\))/\1/&#39;</span>\</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">                <span class="kw">|</span> <span class="fu">tr</span> <span class="st">&#39;[:upper:]&#39;</span> <span class="st">&#39;[:lower:]&#39;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">elif [[</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;tmux&quot;</span><span class="kw"> ]]</span>;<span class="kw">then</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">    <span class="va">window_bottom=$(</span><span class="ex">tmux</span> list-panes -F <span class="st">&quot;#{window_height}&quot;</span> <span class="kw">|</span> <span class="fu">head</span> -n1<span class="va">)</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="va">window_right=$(</span><span class="ex">tmux</span> list-panes -F <span class="st">&quot;#{window_width}&quot;</span> <span class="kw">|</span> <span class="fu">head</span> -n1<span class="va">)</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">    <span class="va">window_bottom=$(($window_bottom</span> - 1<span class="va">))</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    <span class="va">window_right=$(($window_right</span> - 1<span class="va">))</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    <span class="va">pane=$(</span><span class="ex">tmux</span> list-panes -F <span class="st">&quot;#{pane_left} #{pane_right} #{pane_top} #{pane_bottom} #{pane_active}&quot;</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&#39;.* 1$&#39;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    <span class="va">pane_left=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$pane</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f 1<span class="va">)</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    <span class="va">pane_right=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$pane</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f 2<span class="va">)</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">    <span class="va">pane_top=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$pane</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f 3<span class="va">)</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">    <span class="va">pane_bottom=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$pane</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">cut</span> -d<span class="st">&#39; &#39;</span> -f 4<span class="va">)</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="kw">function</span><span class="fu"> rat_up</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$current_window</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;urxvt&quot;</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">        <span class="ex">ratpoison</span> -c <span class="st">&#39;meta C-k&#39;</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">        <span class="ex">ratpoison</span> -c <span class="st">&#39;focusup&#39;</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="kw">function</span><span class="fu"> rat_down</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$current_window</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;urxvt&quot;</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-32" data-line-number="32">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33">        <span class="ex">ratpoison</span> -c <span class="st">&#39;meta C-j&#39;</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-35" data-line-number="35">        <span class="ex">ratpoison</span> -c <span class="st">&#39;focusdown&#39;</span></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38"></a>
<a class="sourceLine" id="cb2-39" data-line-number="39"><span class="kw">function</span><span class="fu"> rat_right</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$current_window</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;urxvt&quot;</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">        <span class="ex">ratpoison</span> -c <span class="st">&#39;meta C-l&#39;</span></a>
<a class="sourceLine" id="cb2-44" data-line-number="44">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-45" data-line-number="45">        <span class="ex">~/.scripts/ratpoison/frame-mon_navigator.sh</span> right</a>
<a class="sourceLine" id="cb2-46" data-line-number="46">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-47" data-line-number="47"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-48" data-line-number="48"></a>
<a class="sourceLine" id="cb2-49" data-line-number="49"><span class="kw">function</span><span class="fu"> rat_left</span></a>
<a class="sourceLine" id="cb2-50" data-line-number="50"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$current_window</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;urxvt&quot;</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-52" data-line-number="52">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-53" data-line-number="53">        <span class="ex">ratpoison</span> -c <span class="st">&#39;meta C-h&#39;</span></a>
<a class="sourceLine" id="cb2-54" data-line-number="54">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-55" data-line-number="55">        <span class="ex">~/.scripts/ratpoison/frame-mon_navigator.sh</span> left</a>
<a class="sourceLine" id="cb2-56" data-line-number="56">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-57" data-line-number="57"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-58" data-line-number="58"></a>
<a class="sourceLine" id="cb2-59" data-line-number="59"><span class="kw">function</span><span class="fu"> tmux_up</span></a>
<a class="sourceLine" id="cb2-60" data-line-number="60"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-61" data-line-number="61">    <span class="kw">if [[</span> <span class="va">$pane_top</span>  <span class="ot">-eq</span> 0<span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-62" data-line-number="62">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-63" data-line-number="63">        <span class="ex">ratpoison</span> -c <span class="st">&#39;focusup&#39;</span></a>
<a class="sourceLine" id="cb2-64" data-line-number="64">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-65" data-line-number="65">        <span class="ex">tmux</span> select-pane -U</a>
<a class="sourceLine" id="cb2-66" data-line-number="66">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-67" data-line-number="67"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-68" data-line-number="68"></a>
<a class="sourceLine" id="cb2-69" data-line-number="69"><span class="kw">function</span><span class="fu"> tmux_down</span></a>
<a class="sourceLine" id="cb2-70" data-line-number="70"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-71" data-line-number="71">    <span class="kw">if [[</span> <span class="va">$pane_bottom</span>  <span class="ot">-eq</span> <span class="va">$window_bottom</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-72" data-line-number="72">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-73" data-line-number="73">        <span class="ex">ratpoison</span> -c <span class="st">&#39;focusdown&#39;</span></a>
<a class="sourceLine" id="cb2-74" data-line-number="74">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-75" data-line-number="75">        <span class="ex">tmux</span> select-pane -D</a>
<a class="sourceLine" id="cb2-76" data-line-number="76">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-77" data-line-number="77"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-78" data-line-number="78"></a>
<a class="sourceLine" id="cb2-79" data-line-number="79"><span class="kw">function</span><span class="fu"> tmux_right</span></a>
<a class="sourceLine" id="cb2-80" data-line-number="80"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-81" data-line-number="81">    <span class="kw">if [[</span> <span class="va">$pane_right</span>  <span class="ot">-eq</span> <span class="va">$window_right</span><span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-82" data-line-number="82">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-83" data-line-number="83">        <span class="ex">~/.scripts/ratpoison/frame-mon_navigator.sh</span> right</a>
<a class="sourceLine" id="cb2-84" data-line-number="84">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-85" data-line-number="85">        <span class="ex">tmux</span> select-pane -R</a>
<a class="sourceLine" id="cb2-86" data-line-number="86">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-87" data-line-number="87"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-88" data-line-number="88"></a>
<a class="sourceLine" id="cb2-89" data-line-number="89"><span class="kw">function</span><span class="fu"> tmux_left</span></a>
<a class="sourceLine" id="cb2-90" data-line-number="90"><span class="kw">{</span></a>
<a class="sourceLine" id="cb2-91" data-line-number="91">    <span class="kw">if [[</span> <span class="va">$pane_left</span>  <span class="ot">-eq</span> 0<span class="kw"> ]]</span>;</a>
<a class="sourceLine" id="cb2-92" data-line-number="92">    <span class="kw">then</span></a>
<a class="sourceLine" id="cb2-93" data-line-number="93">        <span class="ex">~/.scripts/ratpoison/frame-mon_navigator.sh</span> left</a>
<a class="sourceLine" id="cb2-94" data-line-number="94">    <span class="kw">else</span></a>
<a class="sourceLine" id="cb2-95" data-line-number="95">        <span class="ex">tmux</span> select-pane -L</a>
<a class="sourceLine" id="cb2-96" data-line-number="96">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb2-97" data-line-number="97"><span class="kw">}</span></a>
<a class="sourceLine" id="cb2-98" data-line-number="98"></a>
<a class="sourceLine" id="cb2-99" data-line-number="99"></a>
<a class="sourceLine" id="cb2-100" data-line-number="100"><span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;rat&quot;</span><span class="kw"> ]]</span>;<span class="kw">then</span></a>
<a class="sourceLine" id="cb2-101" data-line-number="101">    <span class="kw">case</span> <span class="st">&quot;</span><span class="va">$2</span><span class="st">&quot;</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb2-102" data-line-number="102">        <span class="st">&#39;up&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-103" data-line-number="103">            <span class="ex">rat_up</span></a>
<a class="sourceLine" id="cb2-104" data-line-number="104">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-105" data-line-number="105">        <span class="st">&#39;down&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-106" data-line-number="106">            <span class="ex">rat_down</span></a>
<a class="sourceLine" id="cb2-107" data-line-number="107">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-108" data-line-number="108">        <span class="st">&#39;right&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-109" data-line-number="109">            <span class="ex">rat_right</span></a>
<a class="sourceLine" id="cb2-110" data-line-number="110">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-111" data-line-number="111">        <span class="st">&#39;left&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-112" data-line-number="112">            <span class="ex">rat_left</span></a>
<a class="sourceLine" id="cb2-113" data-line-number="113">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-114" data-line-number="114">    <span class="kw">esac</span></a>
<a class="sourceLine" id="cb2-115" data-line-number="115"></a>
<a class="sourceLine" id="cb2-116" data-line-number="116"><span class="kw">elif [[</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;tmux&quot;</span><span class="kw"> ]]</span>;<span class="kw">then</span></a>
<a class="sourceLine" id="cb2-117" data-line-number="117">    <span class="kw">case</span> <span class="st">&quot;</span><span class="va">$2</span><span class="st">&quot;</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb2-118" data-line-number="118">        <span class="st">&#39;up&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-119" data-line-number="119">            <span class="ex">tmux_up</span></a>
<a class="sourceLine" id="cb2-120" data-line-number="120">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-121" data-line-number="121">        <span class="st">&#39;down&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-122" data-line-number="122">            <span class="ex">tmux_down</span></a>
<a class="sourceLine" id="cb2-123" data-line-number="123">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-124" data-line-number="124">        <span class="st">&#39;right&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-125" data-line-number="125">            <span class="ex">tmux_right</span></a>
<a class="sourceLine" id="cb2-126" data-line-number="126">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-127" data-line-number="127">        <span class="st">&#39;left&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb2-128" data-line-number="128">            <span class="ex">tmux_left</span></a>
<a class="sourceLine" id="cb2-129" data-line-number="129">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb2-130" data-line-number="130">    <span class="kw">esac</span></a>
<a class="sourceLine" id="cb2-131" data-line-number="131"><span class="kw">fi</span></a></code></pre></div>
<h1 id="vim-tmux-navigator">Vim-Tmux Navigator</h1>
<p>Modifying Tmux mappings to use above scripts will make it work for Tmux-Ratpoison traversing but when a Vim instance is on an Tmux edge pane it will not jump to the appropriate Ratpoison split. To solve it I forked the <code>vim-tmux-navigator</code> project and made the right changes to it in the <a href="https://github.com/alx741/vim-tmux-navigator/tree/vim-tmux-wm-monitor">vim-tmux-wm-monitor branch</a></p>
<p>Then using <a href="https://github.com/junegunn/vim-plug">vim-plug</a> I install it in my <code>.vimrc</code> with:</p>
<pre><code>Plug &#39;alx741/vim-tmux-navigator&#39;, { &#39;branch&#39;: &#39;vim-tmux-wm-monitor&#39; }</code></pre>
<h1 id="mappings">Mappings</h1>
<p>Putting all together requires the appropriate mappings for Ratpoison and Tmux. Vim is already configured with the forked plugin.</p>
<h2 id="ratpoison">Ratpoison</h2>
<p>These lines on <code>.ratpoisonrc</code> will do the top level handling. Take into account the path to the <code>rat_tmux-navigator.sh</code> script.</p>
<pre><code>definekey top C-k exec ~/.scripts/ratpoison/rat_tmux-navigator.sh rat up
definekey top C-j exec ~/.scripts/ratpoison/rat_tmux-navigator.sh rat down
definekey top C-l exec ~/.scripts/ratpoison/rat_tmux-navigator.sh rat right
definekey top C-h exec ~/.scripts/ratpoison/rat_tmux-navigator.sh rat left</code></pre>
<h2 id="tmux">Tmux</h2>
<p>Finally these lines on <code>.tmux.conf</code> are basically modified versions of the <code>vim-tmux-navigator</code> plugin ones.</p>
<pre><code>is_vim=&quot;ps -o state= -o comm= -t &#39;#{pane_tty}&#39; \
    | grep -iqE &#39;^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$&#39;&quot;
bind-key C-h if-shell &quot;$is_vim&quot; &quot;send-keys C-h&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux left&#39;&quot;
bind-key C-j if-shell &quot;$is_vim&quot; &quot;send-keys C-j&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux down&#39;&quot;
bind-key C-k if-shell &quot;$is_vim&quot; &quot;send-keys C-k&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux up&#39;&quot;
bind-key C-l if-shell &quot;$is_vim&quot; &quot;send-keys C-l&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux right&#39;&quot;
bind-key -n C-h if-shell &quot;$is_vim&quot; &quot;send-keys C-h&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux left&#39;&quot;
bind-key -n C-j if-shell &quot;$is_vim&quot; &quot;send-keys C-j&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux down&#39;&quot;
bind-key -n C-k if-shell &quot;$is_vim&quot; &quot;send-keys C-k&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux up&#39;&quot;
bind-key -n C-l if-shell &quot;$is_vim&quot; &quot;send-keys C-l&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux right&#39;&quot;
bind-key h if-shell &quot;$is_vim&quot; &quot;send-keys C-h&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux left&#39;&quot;
bind-key j if-shell &quot;$is_vim&quot; &quot;send-keys C-j&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux down&#39;&quot;
bind-key k if-shell &quot;$is_vim&quot; &quot;send-keys C-k&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux up&#39;&quot;
bind-key l if-shell &quot;$is_vim&quot; &quot;send-keys C-l&quot;  &quot;run &#39;~/.scripts/ratpoison/rat_tmux-navigator.sh tmux right&#39;&quot;</code></pre>]]></summary>
</entry>
<entry>
    <title>How to write C in 2016</title>
    <link href="http://www.sillybytes.net/2016/06/how-to-write-c-in-2016.html" />
    <id>http://www.sillybytes.net/2016/06/how-to-write-c-in-2016.html</id>
    <published>2016-06-19T00:00:00Z</published>
    <updated>2016-06-19T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/clang/thumbnail.png" id="thumbnail" /><br />
</p>
<p>Matt wrote a very interesting and totally recommended post about <a href="https://matt.sh/howto-c">how to C (as of 2016)</a>. Keith Thompson wrote later a very detailed and rather useful <a href="https://github.com/Keith-S-Thompson/how-to-c-response/blob/master/README.md">critique</a> with some extra notes about Matt’s post. Go ahead and read both articles now.</p>
<p>Here I would like to point out some things about tooling.</p>
<p><img src="/img/clang/shot1.jpg" class="img-responsive" /> <!--more--></p>
<h1 id="use-building-tools-make-autotools-cmake">Use building tools (Make, Autotools, CMake)</h1>
<p><img src="/img/clang/shot2.png" class="img-responsive" /></p>
<p>This might be obvious for most C programmers, but I’ve seen quite a lot of people, novices specially, copying and pasting the compilation command on each iteration.</p>
<p>Using a build tool will allow you to automate the building process, but also testing, distribution package generation, etc.</p>
<p>In order to sanely write C code the bear minimum you need is to know and feel comfortable <a href="http://mrbook.org/blog/tutorials/make/">writing</a> and <a href="http://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/">using</a> <em>makefiles</em>, so the compilation process can be described like in a recipe and triggered by issuing the <code>$ make</code> command.</p>
<p><img src="/img/clang/shot3.png" class="img-responsive" /></p>
<p>Using <a href="https://www.gnu.org/software/make/">make</a> alone by writing <em>makefiles</em> will take you pretty far, but for larger software you might want to automate even further all the software ecosystem, so your code can examine the target system for both static and dynamic libraries, binaries available and configure it self to adapt to the system and be as portable as possible. <a href="https://www.gnu.org/software/automake/manual/html_node/Autotools-Introduction.html">Autotools</a> to the rescue.</p>
<p><a href="https://autotools.io/index.html">Learning</a> and <a href="https://www.sourceware.org/autobook/autobook/autobook.html#Top">using</a> <em>Autotools</em> is not much of a trivial task, but when the complexity in your code starts to get out of hand, taking the effort to use them is worth it!</p>
<p>If your code is needs not only to be Posix systems portable, but also get compiled on Windows machines, <a href="https://cmake.org/">CMake</a> rocks!</p>
<p><img src="/img/clang/shot4.jpg" class="img-responsive" /></p>
<h1 id="the-standard-c-library-is-your-friend">The standard C library is your friend</h1>
<p>You can’t get any better at writing C code if you’re not familiar enough with the <a href="https://www.gnu.org/software/libc/manual/html_node/index.html">Standard C library (libc)</a>, in particular I know a lot of people that don’t even know the libc mechanism for error reporting, so be sure you <a href="https://www.gnu.org/software/libc/manual/html_node/index.html#toc-Error-Reporting-1">know it</a>.</p>
<h1 id="use-a-linter">Use a linter</h1>
<p><img src="/img/clang/shot5.jpg" class="img-left" /></p>
<p>A <em>linter</em>, in case you don’t know, is a program that will statically check the <strong>source code</strong> (not the executable) to find any known non-portable constructs, vulnerabilities from common programming mistakes or bad practices and any other general coding mistakes that can make your program leak memory, step on segmentation faults and the like.</p>
<p><a href="http://www.splint.org/">Splint</a> is an awesome piece of software that will tell you a <strong>lot</strong> about what your code might be doing wrong.</p>
<p>You can use it very easily just by specifying the source files like:</p>
<pre><code>$ splint foo.c bar.c</code></pre>
<p>Most of the <em>splint</em> output will be more than suggestions than critical warnings, but following the <em>splint</em> recommendations with poise will make your code more robust.</p>
<p>You can tune the level of paranoia with the <em>splint</em> argument options: <code>-weak</code>, <code>-standard</code>, <code>-cheks</code> and <code>-strict</code></p>
<h1 id="valgrind">Valgrind</h1>
<p><img src="/img/clang/shot6.png" class="img-responsive" /></p>
<p><a href="http://valgrind.org/">Valgrind</a> is a profiling software with a few neat tricks up the sleeve. In contrast to <em>splint</em>, it will use your <strong>executable program</strong> and will help you finding memory leaks, make your programs faster and more correct.</p>
<p>When compiling your program use the <code>-g</code> compiler flag so extra debugging information is include in the executable.</p>
<p>Then you can execute you program with Valgrind like this:</p>
<pre><code>$ valgrind foobar arg1 arg2</code></pre>
<p>That will use the <code>Memcheck</code> tool, one of multiple <a href="http://valgrind.org/docs/manual/manual.html">Valgrind tools</a>.</p>
<h1 id="use-a-debugger">Use a debugger</h1>
<p><img src="/img/clang/shot7.png" class="img-responsive" /></p>
<p>Yeah sure, you can fill up you code with <code>printf</code> calls for debugging and pretty much get away with it, but knowing how to use a debugger is always a valuable skill.</p>
<p>Some debugging sessions will be far more easy with <a href="https://www.gnu.org/software/gdb/">GDB</a> than a bunch of <code>printf</code> lines all around, and some times it will not be the case. But for those cases it is, you’ll be a happy programmer.</p>
<h1 id="use-a-control-version-system">Use a control version system</h1>
<p><img src="/img/clang/shot8.jpg" class="img-responsive" /></p>
<p>You might think you can get away keeping a ton of directories for each version of your program if it is small, but that will, eventually, byte you!</p>
<p>A control version system will give you a few super powers for collaboration, version restoring, multi branching, proper history tracking, back up and so much more.</p>
<p>You could use <a href="http://www.nongnu.org/cvs/">CVS</a> or <a href="https://subversion.apache.org/">SVN (Subversion)</a>, but why to do so if you can use a much more powerful control version system like <a href="https://www.mercurial-scm.org/wiki/">Mercurial</a> or even better <a href="https://git-scm.com/">Git</a>.</p>
<p><img src="/img/clang/shot9.png" class="img-responsive" /> <img src="/img/clang/shot10.png" class="img-responsive" /></p>
<p>On top of that, even if you’re working alone in a project and won’t collaborate with more people, using a repository hosting service like <a href="https://bitbucket.org/">Bitbucket</a> or <a href="https://github.com/">Github</a> is a great way to always have a backup of your code. In the future if more people join to your project, collaboration will be frictionless.</p>
<h1 id="automated-documentation">Automated documentation</h1>
<p><img src="/img/clang/shot11.png" class="img-responsive" /></p>
<blockquote>
<p>Documentation is like sex: when it is good, it is very good; and when it is bad, it is better than nothing –Dick Brandon</p>
</blockquote>
<p>Nobody likes to write and maintain documentation so keep it as automatized as possible!</p>
<p>Using tools like <a href="http://www.stack.nl/~dimitri/doxygen/">Doxygen</a> will provide you with some amazing tricks: documentation generation from source code, multi target format documentation (HTML, LATEX, PDF, TROFF Man pages, PostScript, etc).</p>
<p>Remember tu use your abilities writing <em>Make</em> recipes to automate the documentation process as well!</p>
<p>Always write documentation in ways that every possible aspect of it can be automatized. Don’t write documentation using MS Word!! (god dammit!). Use <a href="https://daringfireball.net/projects/markdown/syntax">Markdown</a>, <a href="http://www.methods.co.nz/asciidoc/">AsciiDoc</a>, <a href="http://www.docbook.org/">DocBook</a>.</p>
<p>If you really want a WYSIWYG tool, <a href="https://www.libreoffice.org/">Libre Office</a> has a CLI interface that allows you to generate PDF files, so you can add in your <em>Make</em> recipe something like:</p>
<pre><code>document.pdf: document.odt
    libreoffice --convert-to pdf $&lt;</code></pre>
<p>You can even automatize some graphs generation using <a href="http://www.graphviz.org/doc/info/lang.html">DOT</a>.</p>
<h1 id="unit-testing">Unit testing</h1>
<p><img src="/img/clang/shot12.jpg" class="img-responsive" /></p>
<p>In a <a href="https://en.wikipedia.org/wiki/Unit_testing">nutshell</a> <em>unit testing</em> is writing pieces of code that will use the functions of your software and compare the results to what it is expected to produce. Think of it as writing a program tu use your program and automatically check if it does what it’s supposed to do.</p>
<p>You can take this approach further by doing <a href="https://en.wikipedia.org/wiki/Test-driven_development">Test Driven Development (TDD)</a>.</p>
<p>Automated tests is fundamental, if you want to write C code in 2016+, start writing proper test right know! The world will end if you don’t.</p>
<p>You could write testing functions for your code by hand or use one of the great testing frameworks there are for C out there.</p>
<p>I like <a href="https://libcheck.github.io/check/">Check</a> in particular, it seems to be the more active one and uses the <code>make</code> <code>check</code> command so doing <code>$ make check</code> will test your software.</p>
<p>Writing tests with <strong>Check</strong> is easy as pie:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;check.h&gt;</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="pp">#include </span><span class="im">&quot;../src/foo.h&quot;</span><span class="pp">  </span><span class="co">// Contains &#39;multply&#39; function</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">START_TEST (my_test)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">{</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="dt">int</span> result = multply(<span class="dv">2</span>, <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    ck_assert_int_eq(result, <span class="dv">4</span>);</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">END_TEST</a></code></pre></div>
<p>It should be pretty obvious: the testing function will use the <code>multply</code> function (our tested code) declared in <code>src/foo.h</code> and <strong>assert</strong> that the result of multiplying <code>2</code> times <code>2</code> is equals to <code>4</code>, so next time changes are made in the <code>multply</code> function that makes it misbehave, the bug will be catch pretty fast and easily when we execute our tests. The example here is a bit dumb but you get the idea, check every possible edge case. The more robust the tests are, the more robust the end code will be.</p>
<h1 id="learn-functional-programming">Learn functional programming</h1>
<p><img src="/img/clang/shot13.jpg" class="img-responsive" /></p>
<p>Learning to think functionally will improve your C code despite C being an imperative language, you’ll stop using mutable global state, and all the kind of stuff that prevent your software from being multi thread safe.</p>
<p>If you work on embedded software, you’re probably writing in C. Considering that even relatively cheap embedded hardware today have more than one core, parallelism is pretty important and functional programming mind set will help a lot to do it well.</p>
<p><img src="/img/clang/shot14.png" class="img-left" /><br />
<br />
</p>
<p>There are quite a few multi paradigm languages out there, like python, but if I have to give a recommendation I would say: Learn a pure functional programming language. Specially, <a href="https://www.haskell.org/">blow your mind with Haskell!</a></p>
<h1 id="write-in-c">Write in C</h1>
<p>Eric Raymond <a href="http://www.catb.org/esr/faqs/hacker-howto.html">said</a>:</p>
<blockquote>
<p>The more you can avoid programming in C the more productive you will be.</p>
</blockquote>
<p>And a lot of people say similar things, but I <strong>disagree</strong>. C is a great and powerful language, but with a great power comes a great responsibility. You don’t need to <strong>avoid it</strong>, instead use C when you need and can take advantage of its power and you can afford the effort it takes handling all the extra responsibility that power comes with.</p>
<p><img src="/img/clang/shot15.png" class="img-left" /></p>
<p>Depending on what you’re doing, some other languages would probably fit better and give you extra abstraction in exchange of some perforce decrement. In most cases when you think you need C you probably can also do it well with <a href="https://www.rust-lang.org/">Rust</a> or <a href="https://golang.org/">Go</a> (I recommend the former) and get the work done with great performance and low level management when needed.</p>
<p>C is not a monster you have to hide from, it’s just a (wonderful) tool. You have to pick the appropriate tool depending on what you’re doing.</p>]]></summary>
</entry>
<entry>
    <title>From PIC to AVR</title>
    <link href="http://www.sillybytes.net/2016/06/from-pic-to-avr.html" />
    <id>http://www.sillybytes.net/2016/06/from-pic-to-avr.html</id>
    <published>2016-06-17T00:00:00Z</published>
    <updated>2016-06-17T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/picavr/thumbnail.png" id="thumbnail" /><br />
</p>
<p>This is my humble contribution to the <em>PIC vs AVR holy war</em>.</p>
<p>TL;DR: I was a PIC user but decided I hate it, switched to AVR and love it!</p>
<p><a href="https://en.wikipedia.org/wiki/PIC_microcontroller">PIC</a> from Microchip and <a href="https://en.wikipedia.org/wiki/Atmel_AVR">AVR</a> from Atmel are both wonderful microcontrollers for hobbyist and professional as well (I am a hobbyist only if you’re wondering).</p>
<p>I used to love PIC microcontrollers and originally choose them because they are the most widely available in my location. But there are just so many annoyances that AVR solves so wonderfully! <!--more--></p>
<h1 id="hardware">Hardware</h1>
<p>I’m referring to programming hardware here. Then only feasible way I have to program a PIC uC currently is using my <a href="http://silly-bytes.blogspot.com/2013/08/programando-pics-en-gnulinux-hardware-y.html">parallel port PIC programmer</a> and the completely forgotten, unmaintained <em>Odyssey</em> software.</p>
<p>The only feasible way you say? Yes!, getting a PICkit (2,3) in my location requires a $100 (USD) budget. Any other solution like PICkit clones are not much cheaper.</p>
<p>I’ve also tried the <a href="http://www.usbpicprog.org">usbpicprog</a> but didn’t get it to work. Compiling the host software requires to build not only the CLI (the only I want) but also the bloated GUI. Burning the bootloader is easy, but burning the firmware using the bootloader requires me to use <em>piklab</em> IDE, and I <a href="http://silly-bytes.blogspot.com/2016/03/why-do-i-hate-ides.htm">hate IDE’s!!</a></p>
<p>But the price is the least of the impediments. Using an original Microchip’s PICkit or a clone requires using the <em>pk2cmd</em> <strong>privative</strong> software and doing anything outside MPLAB is a major PITA.</p>
<p>AVR on the other hand allows me to program chips so easily and for so cheap!, A DAPA or DASA programmer is simple, cheap, fast. A USBTiny or a USBASP is so easy and so cheap to get online, and every programmer can be easily used with the completely awesome <em>avrdude</em> CLI software.</p>
<h1 id="software">Software</h1>
<h2 id="programming">Programming</h2>
<p>Yes, Microchip provides a complete, fully compatible IDE (MPLAB) that can run in Unix* systems and can use PICkit. <a href="http://silly-bytes.blogspot.com/2016/03/why-do-i-hate-ides.htm">But using an IDE bothers me</a>, and using <strong>privative</strong> software that only works with <strong>privative</strong> hardware bothers me even more!</p>
<p>I want; I demand! A Free Software (Free as in Freedom), Command Line interface for controlling a Free (Open source is Ok for this) programmer hardware that I can build my self and doesn’t takes a shit load of money from my wallet.</p>
<p>The <em>Odyssey</em> Unix* software that I’ve mentioned before is a bless!, but getting (Free) software for a Serial programmer, a PICkit or a PICkit clone is impossible. Nobody cares about PIC Free tooling, just go and use all the privative, restrictive stuff that Microchip pushes on you.</p>
<p><em>Avrdude</em> solves just everything! An unified (GPL) tool that can drive any programmer with any hardware interface. I absolutely love it!</p>
<h2 id="compiler">Compiler</h2>
<p>The same problem here, Microchips provide a freeware (<strong>privative</strong>) compiler –that even restricts some optimization for the freeware user– and the only sane way to use it is thought the bloated IDE!</p>
<p>The amazing <a href="http://sdcc.sourceforge.net/">SDCC</a> solves this… Almost… Look, I really like SDCC, is an excellent Free Software compiler! But the PIC port is not that good, and using it still requires you to use non-free Microchip’s header files and linker mappings.</p>
<p>With AVR, you use <em>GCC</em>. YES! The GNU freaking C compiler!! Isn’t that completely awesome!? And you even get a fantastic fully featured GPL <a href="http://www.nongnu.org/avr-libc/">avr-libc</a> on top of that!</p>
<h1 id="community">Community</h1>
<p>I’ve always struggle looking for PIC information. Sure there is a lot out there, Microchip’s official documentation is very good and professional, but even in the Microchip’s forums you’re not able to get the level of community help you get from AVR’s community.</p>
<p>AVR has a hacker/hobbyist/professional Free Software and Open Hardware centered community that makes it so much better overall.</p>
<h1 id="conclusion">Conclusion</h1>
<p>All that I’ve presented can vary enormously depending on what the user wants/likes to use.</p>
<p>For me, PIC is horrible because I hate IDE’s I want to use CLI software only that I can easily script with, adapt to powerful text editors, run on remote machines over network and so on. But there is people that hate the command line interface and can’t live without an IDE, so the reasons I don’t like PIC and love AVR might be the reasons is the opposite for you.</p>
<p>Its all about <strong>tooling</strong>. When I say “I don’t like PIC” or “I hate PIC”, what I mean is: “I don’t like PIC <strong>tooling</strong>”. Both PIC and AVR are very powerful and comparable hardware and I like a lot both <em>devices</em>. It’s just PIC tooling is hell, while AVR tooling is heaven… With LED’s… And angels… And beer… Free as in freedom beer…</p>]]></summary>
</entry>
<entry>
    <title>Firefox control on steroids [Firefox + Ratpoison + Mozrepl]</title>
    <link href="http://www.sillybytes.net/2016/05/firefox-control-on-steroids-firefox.html" />
    <id>http://www.sillybytes.net/2016/05/firefox-control-on-steroids-firefox.html</id>
    <published>2016-05-27T00:00:00Z</published>
    <updated>2016-05-27T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><img src="/img/mozrepl/thumbnail.png" id="thumbnail" /><br />
</p>
<p>I’m not going to lie to you, what you’re about to read is really cool.</p>
<p>Controlling all sort of stuff with Ratpoison, as you can see in my previous posts, is pretty neat and you can extend it to control your browser as well.</p>
<p>These are the current capabilities:</p>
<p>Every command start with the Ratpoison prefix + ‘f’ like in <code>C-t f</code>:</p>
<!--more-->
<pre><code>**Command**     **Action**

    f           Facebook
    y           Youtube
    r           Reddit
    g           Github
    o           Open a new tab
    w           Open a new window
    s           Search for the current content in the clipboard
    /           Jump to the tab with url mathing a user input
    l           Open a new tab with the lyrics of the currenlty playing song (mpd)</code></pre>
<p>What does this do?, you might be wondering…</p>
<p>…Well, this does a little bit more than what you’re probably thinking.</p>
<p>Take for instance the <code>f</code> command, it has the <em>“Facebook”</em> action which means that:</p>
<p>No matter where you are, which window currently has the focus, or even if Firefox is not currently running. Firefox will be started (if needed) and will acquire the focus.</p>
<p>Then all your tabs will be parsed (starting from the last one), and if a Facebook tab is found then jump to it; if there is no Facebook tab opened then start a new one.</p>
<p>The same is applied to any of the other pages available (The list can be extended to suit you needs).</p>
<p>The <code>o</code> commands is self explanatory, the only advantage of this one is the ability to have a fast new tab no matter where you are, which window has the focus, or if Firefox is running or not.</p>
<p>The <code>s</code> command is quite nice, here is an use case:</p>
<p>You’re compiling some code, but the compiler complains with a cryptic message, so you use <a href="https://github.com/alx741/dotfiles/blob/master/tmux/.tmux.conf#L55-L59">tmux to copy the error message</a>, then issue the key sequence <code>C-t f /</code> and BANG!, no matter what, a new Firefox tab is just in front of you with the Google results of your error message. And this is applicable to any content in your clipboard as well!</p>
<p>The <code>/</code> command prompts the user for a query and jumps to the tab which URL contains the query as a substring.</p>
<p>The <code>l</code> will take the name of the currently playing song in MPD, google it, and open the first google result for the song lyrics in a new tab.</p>
<h1 id="how-to">How to</h1>
<p>The main dependencies of all this are:</p>
<ul>
<li>Firefox</li>
<li><a href="https://github.com/bard/mozrepl">Mozrepl</a></li>
<li>Ratpoison</li>
<li>Expect</li>
</ul>
<p>You can install them all with the system package manager, except for Mozrepl which you can get from Firefox addons.</p>
<p>This also depends on a Ratpoison <a href="https://github.com/alx741/dotfiles/blob/master/scripts/.scripts/ratpoison/app_select.sh">script</a> introduced in the previous posts, so be sure to have it.</p>
<p>Some extra <code>~/.ratpoisonrc</code> is needed for the new mappings:</p>
<pre><code>newkmap firefox
definekey firefox f exec ~/.scripts/ratpoison/firefox.sh select_tab facebook
definekey firefox y exec ~/.scripts/ratpoison/firefox.sh select_tab youtube
definekey firefox e exec ~/.scripts/ratpoison/firefox.sh select_tab evirtual
definekey firefox r exec ~/.scripts/ratpoison/firefox.sh select_tab reddit
definekey firefox g exec ~/.scripts/ratpoison/firefox.sh select_tab github
definekey firefox o exec ~/.scripts/ratpoison/firefox.sh new_tab
definekey firefox w exec ~/.scripts/ratpoison/firefox.sh new_window
definekey firefox s exec ~/.scripts/ratpoison/firefox.sh clipboard_search
definekey firefox l exec ~/.scripts/ratpoison/firefox.sh search_lyrics
definekey firefox slash exec ~/.scripts/ratpoison/firefox.sh search_tab
bind f readkey firefox</code></pre>
<p>Most of the magic is performed thanks to the amazing <em>Mozrepl</em>. Unfortunately I couldn’t get it to load an external script, but <em>Expect</em> is needed for the communication with it anyways, so lets give it the script line by line.</p>
<p>The <code>select_tab.js</code> <a href="https://github.com/alx741/dotfiles/blob/master/mozrepl/.mozrepl/select_tab.js">script</a> is on charge of parsing the tabs to find one that matches the query and jump to it.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">function</span> <span class="at">selectTab</span>(page) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    <span class="kw">var</span> numTabs<span class="op">=</span><span class="va">gBrowser</span>.<span class="va">browsers</span>.<span class="at">length</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="kw">var</span> url<span class="op">=</span><span class="st">&quot;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    <span class="cf">for</span>(i<span class="op">=</span>numTabs<span class="dv">-1</span><span class="op">;</span> i<span class="op">&gt;</span><span class="dv">0</span><span class="op">;</span> i<span class="op">--</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">        url<span class="op">=</span><span class="va">gBrowser</span>.<span class="at">browsers</span>[i].<span class="va">contentDocument</span>.<span class="va">location</span>.<span class="at">href</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">        <span class="cf">if</span>(<span class="va">url</span>.<span class="at">search</span>(page) <span class="op">!=</span> <span class="dv">-1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">            <span class="va">gBrowser</span>.<span class="va">tabContainer</span>.<span class="at">selectedIndex</span><span class="op">=</span>i<span class="op">;</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="op">}</span></a></code></pre></div>
<p>Use <em>Expect</em> and the <code>select_tab.expect</code> <a href="https://github.com/alx741/dotfiles/blob/master/mozrepl/.mozrepl/select_tab.expect">script</a> to perform the telnet communication with <em>Mozrepl</em> and send the script and commands as well.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">#!/usr/bin/expect</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">set</span> <span class="ex">page</span> [lindex <span class="va">$argv</span> 0]</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">set</span> <span class="ex">port</span> 4242</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">set</span> <span class="fu">file</span> [open <span class="st">&quot;select_tab.js&quot;</span>]</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw">set</span> <span class="ex">content</span> [split [read <span class="va">$file</span>] <span class="st">&quot;\n&quot;</span>]</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="ex">close</span> <span class="va">$file</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="ex">spawn</span> telnet localhost <span class="va">$port</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="ex">foreach</span> line <span class="va">$content</span> {</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">    <span class="ex">send</span> <span class="st">&quot;</span><span class="va">$line</span><span class="st">\r&quot;</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="ex">send</span> <span class="st">&quot;selectTab(</span><span class="dt">\&quot;</span><span class="va">$page</span><span class="dt">\&quot;</span><span class="st">);\r&quot;</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="ex">expect</span> <span class="st">&quot;repl2&gt; &quot;</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="ex">expect</span> {</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">    <span class="st">&quot;true&quot;</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">        <span class="bu">exit</span> 0</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">    <span class="kw">}</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">    <span class="st">&quot;false&quot;</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">        <span class="bu">exit</span> 1</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">    <span class="kw">}</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">}</a></code></pre></div>
<p>Now the <code>firefox.sh</code> <a href="https://github.com/alx741/dotfiles/blob/master/scripts/.scripts/ratpoison/firefox.sh">script</a>, invoked from the Ratpoison configuration, will glue it all together.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="va">URL=</span><span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="kw">function</span><span class="fu"> set_url</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    <span class="kw">case</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">        <span class="st">&#39;facebook&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">            <span class="va">URL=</span><span class="st">&quot;www.facebook.com&quot;</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">        <span class="st">&#39;youtube&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">            <span class="va">URL=</span><span class="st">&quot;www.youtube.com&quot;</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">        <span class="st">&#39;reddit&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">            <span class="va">URL=</span><span class="st">&quot;www.reddit.com&quot;</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">        <span class="st">&#39;github&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">            <span class="va">URL=</span><span class="st">&quot;www.github.com&quot;</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18">        <span class="st">&#39;evirtual&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19">            <span class="va">URL=</span><span class="st">&quot;evirtual.ucuenca.edu.ec&quot;</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20">            <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21">    <span class="kw">esac</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="kw">}</span></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="kw">function</span><span class="fu"> select_tab</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25">    <span class="bu">cd</span> ~/.mozrepl/</a>
<a class="sourceLine" id="cb5-26" data-line-number="26">    <span class="ex">expect</span> select_tab.expect <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="op">&gt;</span> /dev/null</a>
<a class="sourceLine" id="cb5-27" data-line-number="27">    <span class="kw">if [[</span> <span class="va">$?</span> <span class="ot">!=</span> 0<span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28">        <span class="ex">set_url</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29">        <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span> <span class="ot">!=</span> <span class="st">&quot;&quot;</span><span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30">            <span class="ex">firefox</span> --new-tab <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-31" data-line-number="31">        <span class="kw">fi</span></a>
<a class="sourceLine" id="cb5-32" data-line-number="32">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb5-33" data-line-number="33"><span class="kw">}</span></a>
<a class="sourceLine" id="cb5-34" data-line-number="34"></a>
<a class="sourceLine" id="cb5-35" data-line-number="35"><span class="kw">function</span><span class="fu"> search_tab</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36">    <span class="va">query=</span><span class="kw">`</span><span class="ex">ratpoison</span> -c <span class="st">&quot;prompt [Tab] &gt;  &quot;</span><span class="kw">`</span></a>
<a class="sourceLine" id="cb5-37" data-line-number="37">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$query</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;&quot;</span><span class="kw"> ]]</span>; <span class="kw">then</span> <span class="bu">exit</span> 0<span class="kw">;</span> <span class="kw">fi</span></a>
<a class="sourceLine" id="cb5-38" data-line-number="38">    <span class="ex">select_tab</span> <span class="st">&quot;</span><span class="va">$query</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-39" data-line-number="39"><span class="kw">}</span></a>
<a class="sourceLine" id="cb5-40" data-line-number="40"></a>
<a class="sourceLine" id="cb5-41" data-line-number="41"><span class="kw">function</span><span class="fu"> clipboard_search</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb5-42" data-line-number="42">    <span class="va">search=$(</span><span class="ex">xclip</span> -selection clipboard -o<span class="va">)</span></a>
<a class="sourceLine" id="cb5-43" data-line-number="43">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$search</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;&quot;</span><span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb5-44" data-line-number="44">        <span class="bu">exit</span> 0</a>
<a class="sourceLine" id="cb5-45" data-line-number="45">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb5-46" data-line-number="46">    <span class="va">search=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$search</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/ /+/g&#39;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb5-47" data-line-number="47">    <span class="va">google_url=</span><span class="st">&quot;https://www.google.com/search?q=</span><span class="va">$search</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-48" data-line-number="48">    <span class="ex">firefox</span> --new-tab <span class="st">&quot;</span><span class="va">$google_url</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-49" data-line-number="49"><span class="kw">}</span></a>
<a class="sourceLine" id="cb5-50" data-line-number="50"></a>
<a class="sourceLine" id="cb5-51" data-line-number="51"><span class="kw">function</span><span class="fu"> search_lyrics</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb5-52" data-line-number="52">    <span class="va">search=$(</span><span class="ex">mpc</span> <span class="kw">|</span> <span class="fu">head</span> -n 1<span class="va">)</span></a>
<a class="sourceLine" id="cb5-53" data-line-number="53">    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">$search</span><span class="st">&quot;</span> <span class="ot">==</span> <span class="st">&quot;&quot;</span><span class="kw"> ]]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb5-54" data-line-number="54">        <span class="bu">exit</span> 0</a>
<a class="sourceLine" id="cb5-55" data-line-number="55">    <span class="kw">fi</span></a>
<a class="sourceLine" id="cb5-56" data-line-number="56">    <span class="va">search+=</span><span class="st">&quot; lyrics&quot;</span></a>
<a class="sourceLine" id="cb5-57" data-line-number="57">    <span class="va">search=$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$search</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">&#39;s/ /+/g&#39;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb5-58" data-line-number="58">    <span class="ex">curl</span> -A <span class="st">&#39;Mozilla/5.0 (X11; Linux i586; rv:31.0) Gecko/20100101 Firefox/31.0&#39;</span>\</a>
<a class="sourceLine" id="cb5-59" data-line-number="59">        <span class="st">&quot;https://www.google.com/search?q=</span><span class="va">$search</span><span class="st">&quot;</span>\</a>
<a class="sourceLine" id="cb5-60" data-line-number="60">            <span class="op">&gt;</span> /tmp/google_search_result.html</a>
<a class="sourceLine" id="cb5-61" data-line-number="61">    <span class="va">url=$(</span><span class="fu">sed</span> <span class="st">&#39;s/&gt;/&gt;\r\n/g&#39;</span> /tmp/google_search_result.html\</a>
<a class="sourceLine" id="cb5-62" data-line-number="62">        <span class="kw">|</span> <span class="fu">grep</span> -m 1 <span class="st">&#39;&lt;a href=&quot;http:.*&quot;.*&gt;&#39;</span>\</a>
<a class="sourceLine" id="cb5-63" data-line-number="63">        <span class="kw">|</span> <span class="fu">sed</span> -e <span class="st">&#39;s/.*href=&quot;\([^&quot;]*\)&quot;.*/\1/&#39;</span><span class="va">)</span></a>
<a class="sourceLine" id="cb5-64" data-line-number="64">    <span class="ex">firefox</span> --new-tab <span class="st">&quot;</span><span class="va">$url</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb5-65" data-line-number="65"><span class="kw">}</span></a>
<a class="sourceLine" id="cb5-66" data-line-number="66"></a>
<a class="sourceLine" id="cb5-67" data-line-number="67"><span class="kw">case</span> <span class="va">$1</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb5-68" data-line-number="68">    <span class="st">&#39;select_tab&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-69" data-line-number="69">        <span class="ex">~/.scripts/ratpoison/app_select.sh</span> firefox</a>
<a class="sourceLine" id="cb5-70" data-line-number="70">        <span class="ex">select_tab</span> <span class="va">$2</span></a>
<a class="sourceLine" id="cb5-71" data-line-number="71">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-72" data-line-number="72">    <span class="st">&#39;search_tab&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-73" data-line-number="73">        <span class="ex">search_tab</span></a>
<a class="sourceLine" id="cb5-74" data-line-number="74">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-75" data-line-number="75">    <span class="st">&#39;new_tab&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-76" data-line-number="76">        <span class="ex">~/.scripts/ratpoison/app_select.sh</span> firefox</a>
<a class="sourceLine" id="cb5-77" data-line-number="77">        <span class="ex">firefox</span> --new-tab <span class="st">&quot;http://www.google.com&quot;</span></a>
<a class="sourceLine" id="cb5-78" data-line-number="78">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-79" data-line-number="79">    <span class="st">&#39;new_window&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-80" data-line-number="80">        <span class="ex">ratpoison</span> -c <span class="st">&quot;nextscreen&quot;</span></a>
<a class="sourceLine" id="cb5-81" data-line-number="81">        <span class="ex">firefox</span> --new-window <span class="st">&quot;http://www.google.com&quot;</span></a>
<a class="sourceLine" id="cb5-82" data-line-number="82">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-83" data-line-number="83">    <span class="st">&#39;clipboard_search&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-84" data-line-number="84">        <span class="ex">~/.scripts/ratpoison/app_select.sh</span> firefox</a>
<a class="sourceLine" id="cb5-85" data-line-number="85">        <span class="ex">clipboard_search</span></a>
<a class="sourceLine" id="cb5-86" data-line-number="86">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-87" data-line-number="87">    <span class="st">&#39;search_lyrics&#39;</span><span class="kw">)</span></a>
<a class="sourceLine" id="cb5-88" data-line-number="88">        <span class="ex">~/.scripts/ratpoison/app_select.sh</span> firefox</a>
<a class="sourceLine" id="cb5-89" data-line-number="89">        <span class="ex">search_lyrics</span></a>
<a class="sourceLine" id="cb5-90" data-line-number="90">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb5-91" data-line-number="91"><span class="kw">esac</span></a></code></pre></div>
<p>You can find all those scripts and configuration bits in my <a href="https://github.com/alx741/dotfiles">Dotfiles</a>.</p>]]></summary>
</entry>

</feed>

<!doctype html>
<html lang="en">
    <head>
        <title>Silly Bytes</title>

        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" type="image/png" href="../../img/favicon.png" />

        <link rel="stylesheet" href="../../css/default.css" />
        <link rel="stylesheet" href="../../css/post-list.css" />
        <link rel="stylesheet" href="../../css/post.css" />

        <link rel="stylesheet" href="../../bower_components/bootstrap/dist/css/bootstrap.min.css" />
        <link rel="stylesheet" href="../../bower_components/highlight/src/styles/solarized-light.css" />

        <script src="../../bower_components/jquery/dist/jquery.min.js"></script>
        <script src="../../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="../../bower_components/highlight/src/highlight.pack.js"></script>

        <script> hljs.initHighlightingOnLoad(); </script>

    </head>
    <body>
        <header class="container-fluid">
            <div class="row">
                <div class="col-xs-12">
                    <a href="../../">
                        <img alt="Silly Bytes" id="logo" class="image-responsive" src="../../img/silly-bytes_logo.png" />
                    </a>
                </div>
            </div>
        </header>

        <div id="blog" class="container-fluid">
            <div class="row">

                <div id="sidebar" class="hidden-xs hidden-sm col-md-3">
                    <div id="author">
    <img id="author-pic" src="../../img/daniel.jpg">
    <h3 id="author-name">Daniel Campoverde [alx741]</h3>
    <img id="location-icon" src="../../img/location_icon.png">
    <span id="location">Cuenca, Ecuador</span>
</div>

<div id="findme">
    <h2 class="sidebar-h2">FIND ME</h2>
    <a target="_blank" href="https://gitlab.com/alx741">
        <img class="icon" src="../../img/gitlab.png">
    </a>
    <a target="_blank" href="https://github.com/alx741">
        <img class="icon" src="../../img/github.png">
    </a>
    <a target="_blank" href="https://twitter.com/alx741alx">
        <img class="icon" src="../../img/twitter.png">
    </a>
    <a target="_blank" href="https://www.facebook.com/sillybytes/">
        <img class="icon" src="../../img/facebook.png">
    </a>
    <a target="_blank" href="https://plus.google.com/116038619580828681039">
        <img class="icon" src="../../img/google.png">
    </a>

    <div id="findme-textual">
        <b>Freenode:</b> #vim, #archlinux, #avr, #rust, #haskell,
        #yesod, #zsh
        <hr>
        <b>Mailto:</b> alx@sillybytes.net
        <br>
        <b>GPG Key ID:</b> <a href="http://pgp.mit.edu/pks/lookup?op=get&search=0xEB0E776276450F22">76450F22</a>
        <hr>
        <b>Subscribe:</b> <a href="http://www.sillybytes.net/atom.xml">
            <img id="rss-img" alt="rss" src="../../img/rss.png" /> </a>
    </div>


    <div id="facebook-embed">
        <iframe src="//www.facebook.com/plugins/likebox.php?href=https%3A%2F%2Fwww.facebook.com%2Fsillybytes&amp;width&amp;height=290&amp;colorscheme=light&amp;show_faces=true&amp;header=true&amp;stream=false&amp;show_border=true" scrolling="yes" style="border:none; overflow:hidden;" allowtransparency="false" frameborder="0"></iframe>
    </div>
</div>

<div id="random">
    <h2 class="sidebar-h2">YOU MIGHT LIKE</h2>

    <div id="random-posts">
        <ul>
        </ul>
    </div>
</div>

<div id="about">
    <h2 class="sidebar-h2">ABOUT</h2>

    <a target="_blank" href="http://www.haskellers.com/user/4344">
        <img id="haskellers-img" class="badge" alt="I'm a Haskeller" src="../../img/haskellers.png">
    </a>

    <img id="fsf-img" class="badge" alt="Free Software Fundation Member" src="../../img/fsf.png">

    <a target="_blank" href="http://internetdefenseleague.org/">
        <img id="idl-img" class="badge" alt="Internet Defesen League" src="../../img/idl.png">
    </a>
</div>

<div id="dotfiles">
    <h2 class="sidebar-h2">DOTFILES</h2>
    <p>
        Software configuration, scripts, tools and magic.
        Be sure to add <b>attribution </b> when using them
        (fully or partially).
    </p>
    <a target="_blank" href="https://github.com/alx741/dotfiles#readme">
        <img id="dotfiles-img" src="../../img/dotfiles.png">
    </a>
</div>


<div id="license">
    <h2 class="sidebar-h2">LICENSE</h2>

    <a target="_blank" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
        <img id="cc-img" alt="Creative Commons - SA - BY" src="../../img/cc.png">
    </a>
    <p id="cc-text">
        Silly Bytes by Daniel Alejandro Campoverde Carrión
        [alx741] is licensed under a
        <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
            Creative Commons Attribution-ShareAlike 3.0 Unported License.
        </a>
    </p>
</div>

                </div>

                <div id="content" class="col-xs-12 col-md-9">
                    <div class="row">
    <div class="post col-xs-12">
        <h2 class="post-title">TDD (Test-Driven Development) Physical Traffic Light</h2>
        <div class="post-date-author">
            Posted on August 28, 2016
            
                by Daniel Campoverde
            
        </div>
        <div class="post-content">
            <p><img src="../../img/tddlight/thumbnail.jpg" id="thumbnail" /><br />
</p>
<p>Robert C. Martin <em>(Uncle Bob)</em> said in a talk:</p>
<blockquote>
<p>Imagine you have a button that you can push, it will test your code and if everything is working a green light will come up, but if something is broken, a red light will come up […]</p>
</blockquote>
<p>He was of course talking about TDD. I got inspired to build this little toy.</p>
<p>Hardware schematics, firmware and host software is available in <a href="https://github.com/alx741/tdd_traffic-light">this Github repo</a>. Along with information on how to compile and use.</p>
<blockquote>
<p>This is a physical toy traffic light to be used with software development TDD (and testing in general) tools. It will not boost your productivity nor make you a better programmer or TDD practitioner, but it looks cool :)</p>
</blockquote>
<p>Lets explain how it works, it’s very simple: <!--more--></p>
<h1 id="hardware">Hardware</h1>
<p>The <strong>atmega328p</strong> AVR microcontroller is very popular and cheap, but if you buy them on Ebay for example, chances are it comes with an Arduino bootloader, which gets in the way because we can perfectly use the internal oscillator instead of an external 16Mhz crystal. So the first thing to do is change the fuses to the default ones:</p>
<pre class="shell"><code># avrdude -p m328p -c usbasp -U lfuse:w:0x62:m -U hfuse:w:0xd9:m</code></pre>
<p>Now we are using the internal 1MHz oscillator, perfect!</p>
<p>I don’t have a PCB yet (although it should be pretty easy as I made the circuit schematic using <em>kicad</em>) but the circuit is small and simple so it’s easy to build it with prototype PCB. Additionally I added some small neodymium magnets in the back to stick it easily close to my monitors.</p>
<p><img src="../../img/tddlight/img1.jpg" class="img-responsive" /> <img src="../../img/tddlight/img2.jpg" class="img-responsive" /> <img src="../../img/tddlight/img3.jpg" class="img-responsive" /> <img src="../../img/tddlight/img4.jpg" class="img-responsive" /> <img src="../../img/tddlight/img5.jpg" class="img-responsive" /> <img src="../../img/tddlight/img6.jpg" class="img-responsive" /> <img src="../../img/tddlight/img7.jpg" class="img-responsive" /> <img src="../../img/tddlight/img8.jpg" class="img-responsive" /></p>
<h1 id="software">Software</h1>
<p>The firmware is no more than UART boilerplate with <code>4800</code> baud rate so it is stable with at 1MHz clock speed.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;avr/io.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;util/delay.h&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="pp">#define F_CPU 1000000</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="pp">#define BAUD 4800</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="pp">#define BAUD_PRESCALE ((((F_CPU/16) + (BAUD/2)) / (BAUD)) - 1)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="dt">char</span> getchar(<span class="dt">void</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>{</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>    <span class="cf">while</span> ((UCSR0A &amp; (<span class="dv">1</span> &lt;&lt; RXC0)) == <span class="dv">0</span>) {}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    <span class="cf">return</span> UDR0;</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>}</span></code></pre></div>
<p>The main loop will wait for a command <code>r</code>, <code>y</code> or <code>g</code> and turn on the pin corresponding to the color LED.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;avr/io.h&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;util/delay.h&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="pp">#define F_CPU 1000000</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="pp">#define BAUD 4800</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="pp">#define BAUD_PRESCALE ((((F_CPU/16) + (BAUD/2)) / (BAUD)) - 1)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a><span class="dt">char</span> getchar(<span class="dt">void</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>{</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>    <span class="cf">while</span> ((UCSR0A &amp; (<span class="dv">1</span> &lt;&lt; RXC0)) == <span class="dv">0</span>) {}</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>    <span class="cf">return</span> UDR0;</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>}</span></code></pre></div>
<p>Notice how if another character is received the output is cleared so all the LEDs are off.</p>
<p>The host software configures the serial port with a <code>4800</code> baud rate:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="dt">void</span> serial_init(<span class="dt">char</span>* port)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>{</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    <span class="cf">if</span> (COM_FD &gt; <span class="dv">0</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>    {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>        <span class="cf">return</span>;</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>    }</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    <span class="co">// Open serial port file</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    <span class="dt">int</span> fd = open(port, O_RDWR | O_NOCTTY | O_NDELAY);</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="co">// Configure serial port</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>    <span class="kw">struct</span> termios config;</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>    <span class="cf">if</span> (tcgetattr(fd, &amp;config) != <span class="dv">0</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>    {</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>        COM_FD = -<span class="dv">1</span>;</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>        printf(<span class="st">&quot;Error while configing serial port&quot;</span>);</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>        exit(<span class="dv">1</span>);</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>    }</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>    cfsetispeed(&amp;config, B4800);</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>    cfsetospeed(&amp;config, B4800);</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>    config.c_cflag |= (CLOCAL | CREAD | CS8);</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>    config.c_cflag &amp;= ~(PARENB | PARODD);</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>    config.c_iflag = <span class="dv">0</span>;</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    config.c_oflag = <span class="dv">0</span>;</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>    config.c_lflag &amp;= ~(ICANON | ECHO | ECHOE | ISIG);</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>    config.c_cc[VTIME] = <span class="dv">5</span>;</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>    config.c_cc[VMIN] = <span class="dv">0</span>;</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a>    <span class="cf">if</span> (tcsetattr(fd, TCSANOW, &amp;config) != <span class="dv">0</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a>    {</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true"></a>        COM_FD = -<span class="dv">1</span>;</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true"></a>        printf(<span class="st">&quot;Error while configing serial port&quot;</span>);</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true"></a>        exit(<span class="dv">1</span>);</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true"></a>    }</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true"></a>    COM_FD = fd;</span></code></pre></div>
<p>From then controlling the LEDs is as simple as</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>write(COM_FD, <span class="st">&quot;r&quot;</span>, <span class="dv">1</span>);</span></code></pre></div>
<p>Find more information about how to use it in the <a href="https://github.com/alx741/tdd_traffic-light">Github repo</a>.</p>
        </div>
    </div>
</div>


                    <div class="row">
                        <div class="col-sm-4">
                            
                        </div>

                        <div class="col-sm-4">
                            <a class="archive" href="../../archive.html">Archive</a>
                        </div>

                        <div class="col-sm-4">
                            
                        </div>
                    </div>
                </div>

            </div>
        </div>


        <footer class="container-fluid">
            <div class="row">
                <div id="sidebar" class="visible-xs visible-sm col-xs-12">
                    <div id="author">
    <img id="author-pic" src="../../img/daniel.jpg">
    <h3 id="author-name">Daniel Campoverde [alx741]</h3>
    <img id="location-icon" src="../../img/location_icon.png">
    <span id="location">Cuenca, Ecuador</span>
</div>

<div id="findme">
    <h2 class="sidebar-h2">FIND ME</h2>
    <a target="_blank" href="https://gitlab.com/alx741">
        <img class="icon" src="../../img/gitlab.png">
    </a>
    <a target="_blank" href="https://github.com/alx741">
        <img class="icon" src="../../img/github.png">
    </a>
    <a target="_blank" href="https://twitter.com/alx741alx">
        <img class="icon" src="../../img/twitter.png">
    </a>
    <a target="_blank" href="https://www.facebook.com/sillybytes/">
        <img class="icon" src="../../img/facebook.png">
    </a>
    <a target="_blank" href="https://plus.google.com/116038619580828681039">
        <img class="icon" src="../../img/google.png">
    </a>

    <div id="findme-textual">
        <b>Freenode:</b> #vim, #archlinux, #avr, #rust, #haskell,
        #yesod, #zsh
        <hr>
        <b>Mailto:</b> alx@sillybytes.net
        <br>
        <b>GPG Key ID:</b> <a href="http://pgp.mit.edu/pks/lookup?op=get&search=0xEB0E776276450F22">76450F22</a>
        <hr>
        <b>Subscribe:</b> <a href="http://www.sillybytes.net/atom.xml">
            <img id="rss-img" alt="rss" src="../../img/rss.png" /> </a>
    </div>


    <div id="facebook-embed">
        <iframe src="//www.facebook.com/plugins/likebox.php?href=https%3A%2F%2Fwww.facebook.com%2Fsillybytes&amp;width&amp;height=290&amp;colorscheme=light&amp;show_faces=true&amp;header=true&amp;stream=false&amp;show_border=true" scrolling="yes" style="border:none; overflow:hidden;" allowtransparency="false" frameborder="0"></iframe>
    </div>
</div>

<div id="random">
    <h2 class="sidebar-h2">YOU MIGHT LIKE</h2>

    <div id="random-posts">
        <ul>
        </ul>
    </div>
</div>

<div id="about">
    <h2 class="sidebar-h2">ABOUT</h2>

    <a target="_blank" href="http://www.haskellers.com/user/4344">
        <img id="haskellers-img" class="badge" alt="I'm a Haskeller" src="../../img/haskellers.png">
    </a>

    <img id="fsf-img" class="badge" alt="Free Software Fundation Member" src="../../img/fsf.png">

    <a target="_blank" href="http://internetdefenseleague.org/">
        <img id="idl-img" class="badge" alt="Internet Defesen League" src="../../img/idl.png">
    </a>
</div>

<div id="dotfiles">
    <h2 class="sidebar-h2">DOTFILES</h2>
    <p>
        Software configuration, scripts, tools and magic.
        Be sure to add <b>attribution </b> when using them
        (fully or partially).
    </p>
    <a target="_blank" href="https://github.com/alx741/dotfiles#readme">
        <img id="dotfiles-img" src="../../img/dotfiles.png">
    </a>
</div>


<div id="license">
    <h2 class="sidebar-h2">LICENSE</h2>

    <a target="_blank" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
        <img id="cc-img" alt="Creative Commons - SA - BY" src="../../img/cc.png">
    </a>
    <p id="cc-text">
        Silly Bytes by Daniel Alejandro Campoverde Carrión
        [alx741] is licensed under a
        <a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
            Creative Commons Attribution-ShareAlike 3.0 Unported License.
        </a>
    </p>
</div>

                </div>
            </div>
        </footer>

        <script type="text/javascript" src="../../js/random_posts.js"></script>

    </body>
</html>
